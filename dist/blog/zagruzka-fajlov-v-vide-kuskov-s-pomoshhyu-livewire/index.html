<!DOCTYPE html><html lang="ru"> <head><title>Загрузка файлов в виде кусков с помощью Livewire - Igor Gorlov</title><link rel="canonical" href="https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire"><meta name="description" content="Сегодня мы загрузим файл по частям с помощью Livewire. Загружайте файлы рядом с пользователями с помощью Fly.io, и вы сможете запустить свое приложение Laravel за считанные минуты!"><meta name="robots" content="index, follow"><!-- favicon --><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><!-- theme meta --><meta name="theme-name" content="igorlov.ru"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="generator" content="Astro v4.9.1"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- responsive meta --><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><meta name="google-adsense-account" content="ca-pub-0634695143666394"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/_regular_.sihbnQqJ.css">
<style>.breadcrumbs[data-astro-cid-vcbh62el]{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#0d52a1;color:rgba(13,82,161,var(--tw-text-opacity));border-radius:min(1.5rem,1.1625rem + .45vw)}.breadcrumbs[data-astro-cid-vcbh62el]:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}.container[data-astro-cid-vcbh62el]{padding:min(2rem,1.2125rem + 1.05vw)}.list[data-astro-cid-vcbh62el]{display:flex;align-items:center;gap:.125rem}.link[data-astro-cid-vcbh62el]{font-weight:500;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;padding:.125rem .75rem;font-size:min(1.5rem,1.1625rem + .45vw);line-height:var(--tw-lh)}
</style>
<link rel="stylesheet" href="/_astro/_single_.CpmbJtnn.css">
<style>.circular-pagination[data-astro-cid-ihkjvfsn]{display:flex;width:100%;flex-wrap:wrap;align-items:center;justify-content:center;overflow:hidden;border-top-width:1px;--tw-border-opacity: 1;border-color:#27292d;border-color:rgba(39,41,45,var(--tw-border-opacity));margin-top:min(1.25rem,1.1375rem + .15vw)}.circular-pagination__link[data-astro-cid-ihkjvfsn]{width:100%;--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity));text-decoration-line:none}.circular-pagination__link[data-astro-cid-ihkjvfsn]:hover{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.circular-pagination__link[data-astro-cid-ihkjvfsn]{padding-left:min(1.5rem,1.1625rem + .45vw);padding-right:min(1.5rem,1.1625rem + .45vw);padding-top:.5rem;padding-bottom:.5rem}
.comments[data-v-f9c4118f]{margin:auto;margin-top:1.25rem;width:100%;--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.comments:where([class=dark][data-v-f9c4118f],[class=dark] *[data-v-f9c4118f]){--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.giscus-frame[data-v-f9c4118f]{width:100%;--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.giscus-frame:where([class=dark][data-v-f9c4118f],[class=dark] *[data-v-f9c4118f]){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity))}
</style><script type="module" src="/_astro/hoisted.CUFolni_.js"></script><style>[data-astro-transition-scope="astro-xdjatz7t-1"] { view-transition-name: blog-image-zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire; }</style></head> <body class="flex min-h-screen flex-col bg-gray-light pt-16 font-inter text-blue fluid:text-lg lg:pt-24 dark:bg-black dark:text-white"> <header class="header" data-astro-cid-rq644orq> <div class="header__container container" data-astro-cid-rq644orq> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg header__logo dark:hover:text-light text-blue dark:text-white" aria-label="logo" data-astro-cid-ijoll5s5> <svg width="1.44em" height="1em" viewBox="0 0 5660 3931" class="icon" data-astro-cid-ijoll5s5 data-icon="logo-one">  <symbol id="ai:local:logo-one"><g fill="currentColor"><path d="M1198.57 596.749c0 329.575-267.171 596.751-596.747 596.751-329.575 0-596.749-267.176-596.749-596.751S272.248 0 601.823 0c329.576 0 596.747 267.174 596.747 596.749Z"/><circle cx="3035.75" cy="617.751" r="596.749" transform="rotate(-90 3035.75 617.751)"/><path d="M3035.75 2736.81c329.57 0 596.75 267.18 596.75 596.75 0 329.58-267.18 596.75-596.75 596.75-329.58 0-596.75-267.17-596.75-596.75 0-329.57 267.17-596.75 596.75-596.75Z"/><circle cx="596.749" cy="1964.8" r="596.749"/><path d="M1193.5 3332.87c0 329.57-267.176 596.75-596.751 596.75S0 3662.44 0 3332.87c0-329.58 267.174-596.75 596.749-596.75 329.575 0 596.751 267.17 596.751 596.75Z"/><circle cx="5062.46" cy="617.751" r="596.749" transform="rotate(-90 5062.46 617.751)"/><circle cx="5062.46" cy="3333.56" r="596.749" transform="rotate(-90 5062.46 3333.56)"/></g></symbol><use xlink:href="#ai:local:logo-one"></use>  </svg>  </a> <div class="nav header__nav" data-astro-cid-7wkmezxd> <button class="nav__open" title="Открыть меню" data-astro-cid-7wkmezxd> Меню</button> <nav class="nav__container" data-astro-cid-7wkmezxd> <button class="nav__close" title="Закрыть меню" data-astro-cid-7wkmezxd> Закрыть</button> <ul class="nav__list" data-astro-cid-7wkmezxd> <li class="nav__item" data-astro-cid-7wkmezxd> <a href="/blog" class="nav__link nav__link--active" data-astro-cid-7wkmezxd> Блог </a> </li><li class="nav__item" data-astro-cid-7wkmezxd> <a href="#cta" class="nav__link" data-astro-cid-7wkmezxd> Контакты </a> </li> </ul> </nav> </div>   <!-- <ThemeToggle client:only /> --> </div> </header>  <main id="main-content" class="main flex-1">  <div class="blocks"> <nav aria-label="Breadcrumbs" class="breadcrumbs" data-astro-cid-vcbh62el> <div class="container" data-astro-cid-vcbh62el> <ol class="list" role="list" data-astro-cid-vcbh62el> <li class="item" role="listitem" data-astro-cid-vcbh62el> <a class="link" href="/" data-astro-cid-vcbh62el> Главная </a> </li><li class="item" role="listitem" data-astro-cid-vcbh62el> <a class="link" href="/blog" data-astro-cid-vcbh62el> Blog </a> </li><li class="item" role="listitem" data-astro-cid-vcbh62el>  </li> </ol> </div> </nav>  <!-- <TextAds class="fade-in-bottom fluid:my-2" style="--delay: .8s;" /> --><article class="article" data-astro-cid-axzg2cw6> <article data-astro-cid-axzg2cw6> <figure class="article__image" data-astro-cid-axzg2cw6> <picture data-astro-cid-axzg2cw6> <source srcset="/_astro/undefined-Feb-16-2023.Bt978EJ__1Vjq4l.avif" type="image/avif"><source srcset="/_astro/undefined-Feb-16-2023.Bt978EJ__Z255VwV.webp" type="image/webp"> <img src="/_astro/undefined-Feb-16-2023.Bt978EJ__Z18CCYU.png" alt="Загрузка файлов в виде кусков с помощью Livewire" class="aspect-video h-full w-full object-cover object-center" loading="eager" data-astro-cid-axzg2cw6 data-astro-transition-scope="astro-xdjatz7t-1" width="1120" height="580" decoding="async"> </picture> </figure> </article> <div class="container" data-astro-cid-axzg2cw6> <div class="article__header" data-astro-cid-axzg2cw6> <!-- <ul class="article__categories categories">
				{
					categories.map((category: string, index: number) => (
						<li class="categories__item">
							<a href={`/category/${slugify(category)}`} class="categories__link">
								{humanize(category)}
								{index !== categories.length - 1 && ','}
							</a>
						</li>
					))
				}
			</ul> --> <h1 class="article__title text-wrap" data-astro-cid-axzg2cw6> Загрузка файлов в виде кусков с помощью Livewire </h1> <!-- <ul class="article__tags tags">
				{
					tags.map((tag: string) => (
						<li class="tags__item">
							<a class="tags__link" href={`/tag/${slugify(tag)}`}>
								{humanize(tag)}
							</a>
						</li>
					))
				}
			</ul> --> <time class="article__date" data-astro-cid-axzg2cw6>
Опубликовано 16 фев., 2023 by Igor Gorlov </time> <time class="article__date" data-astro-cid-axzg2cw6> Последнее изменение: 21 мар., 2024 </time> </div> <div class="article__content prose prose-zinc max-w-full break-words text-blue dark:prose-invert prose-headings:text-blue prose-p:text-balance prose-a:no-underline hover:prose-a:underline prose-figure:bg-gray-light prose-figure:p-10 prose-figcaption:text-dark dark:prose-figure:bg-dark dark:prose-figcaption:text-white" data-astro-cid-axzg2cw6> <div class="flex flex-col border-b border-blue bg-box font-bold transition-colors text-xs fluid:py-5 lg:text-lg" data-astro-cid-2umh5aky> <span class="title" data-astro-cid-2umh5aky>Задонатить на пиво</span> <ul class="list" data-astro-cid-2umh5aky> <li class="item" data-astro-cid-2umh5aky>usdt trc20 (tron): TCgbLvPt8fe8n4jqbTjVNkzyPTqhEWxW3k</li><li class="item" data-astro-cid-2umh5aky>btc: bc1qslfl8efv733sgr489yxmf9hduw6ptjvvlq2mwx</li><li class="item" data-astro-cid-2umh5aky>eth: 0x316577c4071a5738DD5C0242A97C44bdd3CD6304</li> </ul> </div>  <!-- <AdfoxTocAds blockId="adfox_17062261612859555" /> --> <div class="article__meta" data-astro-cid-axzg2cw6> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Загрузка файлов в виде кусков с помощью Livewire&url=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&url=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire&title=Загрузка файлов в виде кусков с помощью Livewire&summary=Сегодня мы загрузим файл по частям с помощью Livewire. Загружайте файлы рядом с пользователями с помощью Fly.io, и вы сможете запустить свое приложение Laravel за считанные минуты!&source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire&media=&description=Сегодня мы загрузим файл по частям с помощью Livewire. Загружайте файлы рядом с пользователями с помощью Fly.io, и вы сможете запустить свое приложение Laravel за считанные минуты!" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <a class="article__meta-section" href="#comments" data-astro-cid-axzg2cw6> Комментарии</a> </div> <!-- <img class="post-cover" src="https://fly.io/laravel-bytes/2023-02-08/slicing-chunks-cover.jpg" alt="A close up on a chopping board. Three carrots, and three fruits are located on the left space near the board, and three potatoes on its right. Human hands are shown using a knife to cut cubes out of a presumably potato ingredient on top of the chopping board."> Изображение Annie Ruygt -->
<p>Сегодня мы загрузим файл по частям с помощью Livewire. Загружайте файлы рядом с пользователями с помощью Fly.io, и вы сможете запустить свое приложение Laravel за считанные минуты!</p>
<p>Серверы настроены на ограничение размера запросов, которые они могут принимать. Это делается для того, чтобы избежать длительного времени обработки, недоступности и потенциальных рисков безопасности, которые возникают при обработке больших запросов за один раз.</p>
<p>Что произойдет, если пользователь попросит загрузить файл, превышающий установленные ограничения? Соответственно, загрузка завершится неудачей, либо с написанным нами пользовательским сообщением, либо со стандартной ошибкой с кодом состояния 413, возвращаемой нашим сервером.</p>
<p>Мы сталкиваемся с проблемой, с которой сталкивались разработчики до нас и будут сталкиваться еще долго после нас: обработка больших загрузок файлов.</p>
<!-- wp:rank-math/toc-block {"title":"Оглавление","headings":[{"key":"47c2e1f9-d8f6-4c60-80de-5a370fd24326","content":"Проблема","level":2,"link":"#проблема","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"2e940318-75c9-4cee-ac90-89a9429f703a","content":"Решение","level":2,"link":"#решение","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"5856e3e2-6c99-44a8-b0fc-78264c6cf1f1","content":"План","level":2,"link":"#план","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"06bd4b96-c098-4cf9-a960-2be8cdd45d70","content":"Вид","level":2,"link":"#вид","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"95bca40f-8667-4280-9c70-0c56eb766d58","content":"Ожидания от совместного использования","level":2,"link":"#ожидания-от-совместного-использования","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"350fff3b-0596-412f-964b-dc8dc9eb7fc9","content":"Как вырезать фрагмент из нашего файла?","level":2,"link":"#как-вырезать-фрагмент-из-нашего-файла","disable":false,"isUpdated":false,"isGeneratedLink":true}],"listStyle":"ul"} -->
<div class="wp-block-rank-math-toc-block" id="rank-math-toc"><h2>Оглавление</h2><nav><ul><li class=""><a href="#проблема">Проблема</a></li><li class=""><a href="#решение">Решение</a></li><li class=""><a href="#план">План</a></li><li class=""><a href="#вид">Вид</a></li><li class=""><a href="#ожидания-от-совместного-использования">Ожидания от совместного использования</a></li><li class=""><a href="#как-вырезать-фрагмент-из-нашего-файла">Как вырезать фрагмент из нашего файла?</a></li></ul></nav></div>
<!-- /wp:rank-math/toc-block -->
<h2 class="wp-block-heading" id="проблема">Проблема</h2>
<p>Очевидным подходом к решению проблемы является обновление наших ограничений конфигурации. Мы можем увеличить несколько ограничений конфигурации в самом сервере и в PHP.</p>
<p>Проблема в том, что это не совсем динамично. Размер загружаемых файлов может увеличиться со временем, и тогда нам придется заново настраивать наши ограничения. А с увеличением ограничений увеличивается и время обработки запроса.</p>
<p>Есть ли способ избежать этой вечной перенастройки и увеличения времени обработки запросов?</p>
<h2 class="wp-block-heading" id="решение">Решение</h2>
<p>Решение не всегда заключается в увеличении ограничений, иногда достаточно просто скорректировать существующий подход, чтобы спасти ситуацию. Вместо того чтобы отправлять весь файл целиком, почему бы не отправлять его партиями?</p>
<p>Именно так! Сегодня мы не будем изменять нашу конфигурацию под давлением развивающихся ограничений. Вместо этого мы решим эту проблему без изменения нашей конфигурации.</p>
<p>Сегодня мы нарежем, нарежем и объединим фрагменты файлов - с помощью Livewire!</p>
<h2 class="wp-block-heading" id="план">План</h2>
<p>У нас есть трехэтапный план по нарезке и объединению:</p>
<p>Сначала мы сообщим Livewire ожидаемый общий размер $fileSize, который мы получим от всех объединенных кусков. Затем мы начнем нарезать, загружать и объединять фрагменты в ”конечный файл” на нашем сервере один за другим с помощью Livewire. Как только размер конечного файла достигнет заданного $fileSize, это означает, что все куски были объединены. Поэтому мы передаем конечный файл классу TemporaryUploadedFile в Livewire, чтобы использовать возможности Livewire по загрузке файлов.</p>
<p>Чтобы собрать все воедино, вы можете посетить readme нашего репозитория и просмотреть соответствующие файлы.</p>
<h2 class="wp-block-heading" id="вид">Вид</h2>
<p>Давайте начнем с создания Livewire-компонента, выполнив команду php artisan make:livewire chunked-file-upload. После этого обновите наше представление Livewire, чтобы включить тег формы, содержащий элемент ввода файла и кнопку для отправки.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="markup" class="language-markup">&#x3C;form wire:submit.prevent="submit">
  &#x3C;input type="file" id="myFile"/>
  &#x3C;button type="button" onClick="uploadChunks()">Submit&#x3C;/button>
&#x3C;/form>
</code></pre>
<!-- /wp:code -->
<p>Каждый раз, когда пользователь нажимает на кнопку отправки, наша пользовательская функция JavaScript uploadChunks() будет разрезать выбранный файл на фрагменты и запрашивать Livewire для загрузки каждого фрагмента.</p>
<h2 class="wp-block-heading" id="ожидания-от-совместного-использования">Ожидания от совместного использования</h2>
<p>Для того чтобы загрузить большой файл, мы будем нарезать его на более мелкие фрагменты, не выходящие за пределы размера запроса нашего сервера. Мы будем загружать каждый фрагмент один за другим, чтобы сразу объединить загруженный фрагмент в ”конечный файл”.</p>
<p>Но как именно сервер узнает, что все фрагменты были объединены в наш конечный файл? Конечно же, ему нужно знать ожидаемый конечный размер нашего конечного файла!</p>
<p>Свойства Livewire идеально подходят для обмена информацией от клиента к серверу, поэтому давайте включим информацию о нашем файле, такую как его $fileName и $fileSize, в качестве публичных атрибутов в наш компонент Livewire. Сегодня мы разделим наш файл на куски по 1 МБ, поэтому объявим отдельный атрибут для загружаемого куска $fileChunk и ожидаемого максимального размера куска $chunkSize:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="powershell" class="language-powershell">// app/Http/Livewire/ChunkedFileUpload.php
public $chunkSize = 1000000; // 1 MB
public $fileChunk; 

public $fileName;
public $fileSize; 
</code></pre>
<!-- /wp:code -->
<p>Давайте вернемся к нашему представлению Livewire и изменим функцию uploadChunks(), вызываемую нашей кнопкой отправки. Каждый раз, когда пользователь отправляет файл для загрузки, мы будем устанавливать значения для $fileName и $fileSize, которые позже будут отправлены в наш компонент Livewire:</p>
<p>Обратите внимание, что мы используем метод set в Livewire. Это позволяет нам установить публичный атрибут в нашем клиенте, но не делать немедленного вызова на сервер.</p>
<p>Изменения $fileName и $fileSize будут отправлены в Livewire в следующем немедленном запросе компонента.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="php" class="language-php">// resources/views/livewire/chunked-file-upload.blade.php
function uploadChunks()
{
    const file = document.querySelector('#myFile').files[0];

    // Send the following later at the next available call to component
    @this.set('fileName', file.name, true);
    @this.set('fileSize', file.size, true);
</code></pre>
<!-- /wp:code -->
<p>Теперь, когда наши окончательные данные о файле готовы для передачи компоненту Livewire, мы можем взглянуть на наш первый фрагмент, начиная с 0-го байта файла:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="php" class="language-php">    livewireUploadChunk( file, 0 );
}
</code></pre>
<!-- /wp:code -->
<p>Нарезка фрагмента</p>
<h2 class="wp-block-heading" id="как-вырезать-фрагмент-из-нашего-файла">Как вырезать фрагмент из нашего файла?</h2>
<p>Нам нужно знать, где начинается кусок и где он заканчивается. Для первого куска нашего файла начальная точка - это данность: 0. Но как насчет того, где кусок заканчивается?</p>
<p>Конец куска всегда будет находиться на расстоянии 1 МБ (наш $chunkSize) от начальной точки куска или размера файла - в зависимости от того, что меньше:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="php" class="language-php">// resources/views/livewire/chunked-file-upload.blade.php
function livewireUploadChunk( file, start ){
    const chunkEnd  = Math.min( start + @js($chunkSize), file.size );
    const chunk     = file.slice( start, chunkEnd ); 
</code></pre>
<!-- /wp:code -->
<p>Теперь, когда у нас есть наш чанк, нам нужно отправить его на наш сервер. Мы можем использовать функцию Livewire upload JavaScript для загрузки и связать чанк с нашим атрибутом $fileChunk, объявленным выше:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="php" class="language-php">    @this.upload('fileChunk', chunk);
</code></pre>
<!-- /wp:code -->
<p>После загрузки первого чанка давайте отправим и следующий. Нам нужно убедиться, что текущий фрагмент полностью загружен, для этого мы можем подключиться к обратному вызову события прогресса функции upload:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="php" class="language-php">-    @this.upload('fileChunk', chunk);
+    @this.upload('fileChunk', chunk,(uName)=>{}, ()=>{}, (event)=>{
+        if( event.detail.progress == 100 ){
+          // We recursively call livewireUploadChunk from within itself
+          start = chunkEnd;
+          if( start &#x3C; file.size ){
+            livewireUploadChunk( file, start );
+          }
+        }
+    });
}
</code></pre>
<!-- /wp:code -->
<p>Загрузка завершается, когда значение event.detail.progress достигает 100. После этого мы рекурсивно вызываем текущую функцию livewireUploadChunk(), чтобы загрузить следующий чанк.</p>
<p>Диапазон метода file.slice исключает chunkEnd. Например, диапазон slice(0,10) на самом деле означает от 0 до 9, но не 10! Это означает, что наша следующая начальная точка будет chunkEnd.</p>
<p>Переместите свои серверы поближе к пользователям - и восхититесь скоростью близкого расположения. Глобальное развертывание на Fly за считанные минуты!</p>
<p>Разверните свое приложение Laravel!  →</p>
<!-- <img srcset="https://fly.io/static/images/cta-turtle@2x.jpg 2x" src="https://fly.io/static/images/cta-turtle.jpg" alt="">Сохранение и объединение -->
<p>Теперь, когда JavaScript нашего представления Livewire настроен для нарезки и загрузки фрагментов, мы подошли к заключительной части нашего путешествия по нарезке фрагментов: сохранению и объединению фрагментов в компоненте Livewire!</p>
<p>Мы будем использовать свойство WithFileUploads компонента Livewire, чтобы облегчить загрузку файлов. Этот признак позволяет нам объявить атрибут, который можно загружать - в нашем случае $fileChunk!</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="php" class="language-php">// app/Http/Livewire/ChunkedFileUpload.php

+ use WithFileUploads;

// Chunks info
public $chunkSize = 1000000; // 1M
public $fileChunk;

// Final file 
public $fileName;
public $fileSize;

+ public $finalFile;
</code></pre>
<!-- /wp:code -->
<p>После загрузки фрагмента Livewire должен объединить его в ”конечный файл”. Чтобы сделать это, нам нужно перехватить поток Livewire после загрузки нашего фрагмента.</p>
<p>К счастью для нас, Livewire предоставляет ”крючки”, которые мы можем использовать для перехвата потока жизненного цикла Livewire для наших публичных атрибутов. В нашем конкретном случае мы можем подключиться к обновленному хуку для нашего атрибута $fileChunk.</p>
<p>Из нашего крючка updatedFileChunk мы получим имя файла, созданное Livewire для текущего чанка, используя метод getFileName():</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="php" class="language-php">public function updatedFileChunk()
{
    $chunkFileName = $this->fileChunk->getFileName();
</code></pre>
<!-- /wp:code -->
<p>Затем мы объединим этот фрагмент в наш окончательный файл и удалим фрагмент после объединения:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="php" class="language-php">      $finalPath = Storage::path('/livewire-tmp/'.$this->fileName);
      $tmpPath   = Storage::path('/livewire-tmp/'.$chunkFileName);
      $file = fopen($tmpPath, 'rb');
      $buff = fread($file, $this->chunkSize);
      fclose($file);

      $final = fopen($finalPath, 'ab');
      fwrite($final, $buff);
      fclose($final);
      unlink($tmpPath);
</code></pre>
<!-- /wp:code -->
<p>В конечном итоге все фрагменты будут поступать один за другим и объединяться в наш конечный файл. Чтобы определить, все ли фрагменты были объединены, мы просто сравним размер конечного файла с ожидаемым $fileSize.</p>
<p>Конечно, этот вновь созданный файл является нашим пользовательским файлом. Нам нужно будет заключить его в класс TemporaryUploadedFile в Livewire, чтобы использовать возможности Livewire по работе с загруженными файлами.</p>
<p>Не забудьте импортировать класс TemporaryUploadedFile и объявить новый публичный атрибут $finalFile!</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="php" class="language-php">      $curSize = Storage::size('/livewire-tmp/'.$this->fileName);
      if( $curSize == $this->fileSize ){
          $this->finalFile = 
          TemporaryUploadedFile::createFromLivewire("https://fly.io/".$this->fileName);
      }
}
</code></pre>
<!-- /wp:code -->
<p>Скажем, например, предварительный просмотр нового, временного изображения в нашем представлении выглядит следующим образом:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="markup" class="language-markup">@if ($finalFile)
    Photo Preview:
    &#x3C;img src="{{ $finalFile->temporaryUrl() }}">
@endif
</code></pre>
<!-- /wp:code -->
<p>Implementations are generally just so much more smooth with Livewire, uploading file chunks is no different!</p>
<!-- <img srcset="" class="w-16 h-16 object-cover rounded-xl" src="https://fly.io/static/images/kathryn.jpg" alt="Kathryn Anne Tan">  -->
<p>Имя Кэтрин Энн Тан</p> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Загрузка файлов в виде кусков с помощью Livewire&url=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&url=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire&title=Загрузка файлов в виде кусков с помощью Livewire&summary=Сегодня мы загрузим файл по частям с помощью Livewire. Загружайте файлы рядом с пользователями с помощью Fly.io, и вы сможете запустить свое приложение Laravel за считанные минуты!&source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/zagruzka-fajlov-v-vide-kuskov-s-pomoshhyu-livewire&media=&description=Сегодня мы загрузим файл по частям с помощью Livewire. Загружайте файлы рядом с пользователями с помощью Fly.io, и вы сможете запустить свое приложение Laravel за считанные минуты!" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <nav class="circular-pagination" aria-label="Circular Pagination" data-astro-cid-ihkjvfsn> <a href="/blog/zashhita-prilozhenij-next-js-ot-csrf-atak" class="circular-pagination__link circular-pagination__link--prev" data-astro-cid-ihkjvfsn> Защита приложений Next.js от CSRF-атак </a> <a href="/blog/zagruzka-fajlov-v-laravel-10" class="circular-pagination__link circular-pagination__link--next" data-astro-cid-ihkjvfsn> Загрузка файлов в Laravel 10 </a> </nav>  </div> </div> </article> <div class="container" data-astro-cid-axzg2cw6> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="Z1T5Wnr" prefix="r0" component-url="/_astro/YandexRelatedAds.D-6fTqBY.js" component-export="default" renderer-url="/_astro/client.Bd2Qst3j.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;YandexRelatedAds&quot;,&quot;value&quot;:true}" await-children=""><div id="yandex_rtb_C-A-2592503-2"></div><!--astro:end--></astro-island> </div> <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();</script><astro-island uid="Z2a8j9B" component-url="/_astro/CommentBlock.ChJFdf82.js" component-export="default" renderer-url="/_astro/client.44T8euMP.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;CommentBlock&quot;,&quot;value&quot;:true}"></astro-island>  <!-- <div class="blocks__container container">
			<CtaBlock id="cta" class=""
			/>
		</div> --> </div>    </main> <footer class="footer" data-astro-cid-dwelrhxs> <div class="footer__container container" data-astro-cid-dwelrhxs> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg footer__logo dark:hover:text-light text-blue dark:text-white" aria-label="logo" data-astro-cid-ijoll5s5> <svg width="1.44em" height="1em" viewBox="0 0 5660 3931" class="icon" data-astro-cid-ijoll5s5 data-icon="logo-one">  <use xlink:href="#ai:local:logo-one"></use>  </svg>  </a> <small class="footer__copyright" data-astro-cid-dwelrhxs>все права защищены. © 2024</small> </div> </footer>  </body></html>