<!DOCTYPE html><html lang="ru"> <head><title>Создание безопасного OpenAPI, ориентированного на базу данных, за 15 минут - Igor Gorlov</title><link rel="canonical" href="https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut"><meta name="description" content="Если вы являетесь разработчиком, знакомым с RESTful API, вы, возможно, слышали о OpenAPI. Это спецификация для описания RESTful API в формате, читаемом людьми и машинами. Создание публичного OpenAPI включает в себя три задачи:"><meta name="robots" content="index, follow"><!-- favicon --><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><!-- theme meta --><meta name="theme-name" content="igorlov.ru"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="generator" content="Astro v4.10.0"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- responsive meta --><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><meta name="google-adsense-account" content="ca-pub-0634695143666394"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/_regular_.Dg72Zwgc.css">
<style>.breadcrumbs[data-astro-cid-vcbh62el]{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#0d52a1;color:rgba(13,82,161,var(--tw-text-opacity));border-radius:min(1.5rem,1.1625rem + .45vw)}.breadcrumbs[data-astro-cid-vcbh62el]:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}.container[data-astro-cid-vcbh62el]{padding:min(2rem,1.2125rem + 1.05vw)}.list[data-astro-cid-vcbh62el]{display:flex;align-items:center;gap:.125rem}.link[data-astro-cid-vcbh62el]{font-weight:500;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;padding:.125rem .75rem;font-size:min(1.5rem,1.1625rem + .45vw);line-height:var(--tw-lh)}
</style>
<link rel="stylesheet" href="/_astro/_single_.CzD8Xhhr.css">
<style>.circular-pagination[data-astro-cid-ihkjvfsn]{display:flex;width:100%;flex-wrap:wrap;align-items:center;justify-content:center;overflow:hidden;border-top-width:1px;--tw-border-opacity: 1;border-color:#27292d;border-color:rgba(39,41,45,var(--tw-border-opacity));margin-top:min(1.25rem,1.1375rem + .15vw)}.circular-pagination__link[data-astro-cid-ihkjvfsn]{width:100%;--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity));text-decoration-line:none}.circular-pagination__link[data-astro-cid-ihkjvfsn]:hover{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.circular-pagination__link[data-astro-cid-ihkjvfsn]{padding-left:min(1.5rem,1.1625rem + .45vw);padding-right:min(1.5rem,1.1625rem + .45vw);padding-top:.5rem;padding-bottom:.5rem}
.comments[data-v-f9c4118f]{margin:auto;margin-top:1.25rem;width:100%;--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.comments:where([class=dark][data-v-f9c4118f],[class=dark] *[data-v-f9c4118f]){--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.giscus-frame[data-v-f9c4118f]{width:100%;--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.giscus-frame:where([class=dark][data-v-f9c4118f],[class=dark] *[data-v-f9c4118f]){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity))}
</style><script type="module" src="/_astro/hoisted.CUFolni_.js"></script><style>[data-astro-transition-scope="astro-xdjatz7t-1"] { view-transition-name: blog-image-sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut; }</style></head> <body class="flex min-h-screen flex-col bg-gray-light pt-16 font-inter text-blue fluid:text-lg lg:pt-24 dark:bg-black dark:text-white"> <header class="header" data-astro-cid-rq644orq> <div class="header__container container" data-astro-cid-rq644orq> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg header__logo dark:hover:text-light text-blue dark:text-white" aria-label="logo" data-astro-cid-ijoll5s5> <svg width="1.44em" height="1em" viewBox="0 0 5660 3931" class="icon" data-astro-cid-ijoll5s5 data-icon="logo-one">  <symbol id="ai:local:logo-one"><g fill="currentColor"><path d="M1198.57 596.749c0 329.575-267.171 596.751-596.747 596.751-329.575 0-596.749-267.176-596.749-596.751S272.248 0 601.823 0c329.576 0 596.747 267.174 596.747 596.749Z"/><circle cx="3035.75" cy="617.751" r="596.749" transform="rotate(-90 3035.75 617.751)"/><path d="M3035.75 2736.81c329.57 0 596.75 267.18 596.75 596.75 0 329.58-267.18 596.75-596.75 596.75-329.58 0-596.75-267.17-596.75-596.75 0-329.57 267.17-596.75 596.75-596.75Z"/><circle cx="596.749" cy="1964.8" r="596.749"/><path d="M1193.5 3332.87c0 329.57-267.176 596.75-596.751 596.75S0 3662.44 0 3332.87c0-329.58 267.174-596.75 596.749-596.75 329.575 0 596.751 267.17 596.751 596.75Z"/><circle cx="5062.46" cy="617.751" r="596.749" transform="rotate(-90 5062.46 617.751)"/><circle cx="5062.46" cy="3333.56" r="596.749" transform="rotate(-90 5062.46 3333.56)"/></g></symbol><use xlink:href="#ai:local:logo-one"></use>  </svg>  </a> <div class="nav header__nav" data-astro-cid-7wkmezxd> <button class="nav__open" title="Открыть меню" data-astro-cid-7wkmezxd> Меню</button> <nav class="nav__container" data-astro-cid-7wkmezxd> <button class="nav__close" title="Закрыть меню" data-astro-cid-7wkmezxd> Закрыть</button> <ul class="nav__list" data-astro-cid-7wkmezxd> <li class="nav__item" data-astro-cid-7wkmezxd> <a href="/blog" class="nav__link nav__link--active" data-astro-cid-7wkmezxd> Блог </a> </li><li class="nav__item" data-astro-cid-7wkmezxd> <a href="#cta" class="nav__link" data-astro-cid-7wkmezxd> Контакты </a> </li> </ul> </nav> </div>   <!-- <ThemeToggle client:only /> --> </div> </header>  <main id="main-content" class="main flex-1">  <div class="blocks"> <nav aria-label="Breadcrumbs" class="breadcrumbs" data-astro-cid-vcbh62el> <div class="container" data-astro-cid-vcbh62el> <ol class="list" role="list" data-astro-cid-vcbh62el> <li class="item" role="listitem" data-astro-cid-vcbh62el> <a class="link" href="/" data-astro-cid-vcbh62el> Главная </a> </li><li class="item" role="listitem" data-astro-cid-vcbh62el> <a class="link" href="/blog" data-astro-cid-vcbh62el> Blog </a> </li><li class="item" role="listitem" data-astro-cid-vcbh62el>  </li> </ol> </div> </nav>  <!-- <TextAds class="fade-in-bottom fluid:my-2" style="--delay: .8s;" /> --><article class="article" data-astro-cid-axzg2cw6> <article data-astro-cid-axzg2cw6> <figure class="article__image" data-astro-cid-axzg2cw6> <picture data-astro-cid-axzg2cw6> <source srcset="/_astro/undefined-Mar-21-2023.DTuNckWQ_jUNn5.avif" type="image/avif"><source srcset="/_astro/undefined-Mar-21-2023.DTuNckWQ_wRIVw.webp" type="image/webp"> <img src="/_astro/undefined-Mar-21-2023.DTuNckWQ_149wR0.png" alt="Создание безопасного OpenAPI, ориентированного на базу данных, за 15 минут" class="aspect-video h-full w-full object-cover object-center" loading="eager" data-astro-cid-axzg2cw6 data-astro-transition-scope="astro-xdjatz7t-1" width="1120" height="580" decoding="async"> </picture> </figure> </article> <div class="container" data-astro-cid-axzg2cw6> <div class="article__header" data-astro-cid-axzg2cw6> <ul class="article__categories categories" data-astro-cid-axzg2cw6> <li class="categories__item" data-astro-cid-axzg2cw6> <a href="/category/учебник" class="categories__link" data-astro-cid-axzg2cw6> Учебник  </a> </li> </ul> <h1 class="article__title text-wrap" data-astro-cid-axzg2cw6> Создание безопасного OpenAPI, ориентированного на базу данных, за 15 минут </h1> <ul class="article__tags tags" data-astro-cid-axzg2cw6> <li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/openapi" data-astro-cid-axzg2cw6> Openapi </a> </li><li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/prisma" data-astro-cid-axzg2cw6> Prisma </a> </li><li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/restapi" data-astro-cid-axzg2cw6> Restapi </a> </li><li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/zenstack" data-astro-cid-axzg2cw6> ZenStack </a> </li> </ul> <time class="article__date" data-astro-cid-axzg2cw6>
Опубликовано 21 мар., 2023 by Igor Gorlov </time> <time class="article__date" data-astro-cid-axzg2cw6> Последнее изменение: 21 мар., 2024 </time> </div> <div class="article__content prose prose-zinc max-w-full break-words text-blue dark:prose-invert prose-headings:text-blue prose-p:text-balance prose-a:no-underline hover:prose-a:underline prose-figure:bg-gray-light prose-figure:p-10 prose-figcaption:text-dark dark:prose-figure:bg-dark dark:prose-figcaption:text-white" data-astro-cid-axzg2cw6> <!-- <TextAds /> --> <!-- <AdfoxTocAds blockId="adfox_17062261612859555" /> --> <div class="article__meta" data-astro-cid-axzg2cw6> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Создание безопасного OpenAPI, ориентированного на базу данных, за 15 минут&url=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&url=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut&title=Создание безопасного OpenAPI, ориентированного на базу данных, за 15 минут&summary=Если вы являетесь разработчиком, знакомым с RESTful API, вы, возможно, слышали о OpenAPI. Это спецификация для описания RESTful API в формате, читаемом людьми и машинами. Создание публичного OpenAPI включает в себя три задачи:&source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut&media=&description=Если вы являетесь разработчиком, знакомым с RESTful API, вы, возможно, слышали о OpenAPI. Это спецификация для описания RESTful API в формате, читаемом людьми и машинами. Создание публичного OpenAPI включает в себя три задачи:" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <a class="article__meta-section" href="#comments" data-astro-cid-axzg2cw6> Комментарии</a> </div> <p>Если вы являетесь разработчиком, знакомым с RESTful API, вы, возможно, слышали о OpenAPI. Это спецификация для описания RESTful API в формате, читаемом людьми и машинами. Создание публичного OpenAPI включает в себя три задачи:</p>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Разработка спецификации OpenAPI, которая служит контрактом между поставщиком и потребителем API.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Реализация конечных точек API на основе спецификации.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Опционально, реализация клиентских SDK для использования API.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<p>В этом посте вы увидите, как выполнить все эти задачи и создать OpenAPI-сервис, ориентированный на базу данных, безопасный и документированный, за 15 минут.</p>
<p>Готовый проект вы можете найти <a href="https://github.com/ymc9/petstore-openapi-zenstack" target="_blank" rel="noreferrer noopener nofollow">здесь</a>.</p>
<!-- wp:rank-math/toc-block {"title":"Оглавление","headings":[{"key":"04b56b4e-d896-48d8-8d6a-b42fb042b168","content":"Сценарий","level":2,"link":"#сценарий","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"24abe9ca-8e50-4154-a54d-bee6e113a53d","content":"Бизнес-правила:","level":3,"link":"#бизнес-правила","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"38223229-5507-49e2-b7e2-5f3d8e6943a3","content":"Создание","level":2,"link":"#создание","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"55c406cf-78a0-4805-a7e5-f202eec6531e","content":"1. Создание проекта","level":3,"link":"#1-создание-проекта","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"3fff40e2-e558-46b6-9acc-e1d88e72e674","content":"2. Моделирование данных","level":3,"link":"#2-моделирование-данных","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"a1e6e4a5-c358-46c6-acbe-09e046943b64","content":"3. Реализация API","level":3,"link":"#3-реализация-api","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"a1291175-1fcc-43b6-af83-3554fd6c8dec","content":"4. Добавление аутентификации","level":3,"link":"#4-добавление-аутентификации","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"bcf2cb13-3de4-492e-aea5-ceb16a593b06","content":"5. Добавление авторизации","level":3,"link":"#5-добавление-авторизации","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"3e017b73-20d6-483f-8877-0783f19e2fa3","content":"Генерация спецификации OpenAPI","level":2,"link":"#генерация-спецификации-open-api","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"25bd31ec-14b1-4d50-abf7-4fd2f233cf2f","content":"Генерация SDK клиента","level":2,"link":"#генерация-sdk-клиента","disable":false,"isUpdated":false,"isGeneratedLink":true},{"key":"f4cc7c12-be85-4a52-a74d-f27cc864569b","content":"Подведение итогов","level":2,"link":"#подведение-итогов","disable":false,"isUpdated":false,"isGeneratedLink":true}],"listStyle":"ul"} -->
<div class="wp-block-rank-math-toc-block" id="rank-math-toc"><h2>Оглавление</h2><nav><ul><li class=""><a href="#сценарий">Сценарий</a><ul><li class=""><a href="#бизнес-правила">Бизнес-правила:</a></li></ul></li><li class=""><a href="#создание">Создание</a><ul><li class=""><a href="#1-создание-проекта">1. Создание проекта</a></li><li class=""><a href="#2-моделирование-данных">2. Моделирование данных</a></li><li class=""><a href="#3-реализация-api">3. Реализация API</a></li><li class=""><a href="#4-добавление-аутентификации">4. Добавление аутентификации</a></li><li class=""><a href="#5-добавление-авторизации">5. Добавление авторизации</a></li></ul></li><li class=""><a href="#генерация-спецификации-open-api">Генерация спецификации OpenAPI</a></li><li class=""><a href="#генерация-sdk-клиента">Генерация SDK клиента</a></li><li class=""><a href="#подведение-итогов">Подведение итогов</a></li></ul></nav></div>
<!-- /wp:rank-math/toc-block -->
<h2 class="wp-block-heading" id="сценарий">Сценарий</h2>
<p>Для облегчения понимания я буду использовать в качестве примера простой API зоомагазина. API будет иметь следующие ресурсы:</p>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Пользователь: который может зарегистрироваться, войти в систему и заказать питомца.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Питомец: который может быть перечислен и заказан пользователями.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Заказ: который создается пользователями и содержит список питомцев.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading" id="бизнес-правила">Бизнес-правила:</h3>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Анонимные пользователи могут регистрироваться и входить в систему.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Анонимные пользователи могут перечислять непроданных питомцев.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Аутентифицированные пользователи могут перечислять непроданных питомцев и питомцев, заказанных ими.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Аутентифицированные пользователи могут создавать заказы на непроданных питомцев.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Аутентифицированные пользователи могут просматривать свои заказы.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<h2 class="wp-block-heading" id="создание">Создание</h2>
<p>Мы будем использовать Express.js в качестве фреймворка для создания сервиса. Однако можно использовать и другие фреймворки, например Fastify, и общий процесс будет аналогичным.</p>
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading" id="1-создание-проекта">1. Создание проекта</h3>
<p>Сначала создадим новый проект Express.js с помощью Typescript.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">mkdir express-petstore
cd express-petstore
npm init -y
npm install express
npm install -D typescript tsx @types/node @types/express
npx tsc --init
</code></pre>
<!-- /wp:code -->
<p>Создайте код точки входа в сервис app.ts со следующим содержимым:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">// app.ts
import express from 'express';

const app = express();

// enable JSON body parser
app.use(express.json());

app.get('/', (req, res) => {
    res.send('Hello World!');
});

app.listen(3000, () => console.log('🚀 Server ready at: http://localhost:3000'));
</code></pre>
<!-- /wp:code -->
<p>Запустите сервер:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npx tsx watch app.ts
</code></pre>
<!-- /wp:code -->
<p>Теперь в новом окне оболочки выберите конечную точку службы и убедитесь, что она работает:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl localhost:3000
</code></pre>
<!-- /wp:code -->
<p>Hello World!</p>
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading" id="2-моделирование-данных">2. Моделирование данных</h3>
<p>Моделирование данных - это самая важная часть построения ресурсно-ориентированного API. В этом руководстве мы будем использовать Prisma и ZenStack для моделирования базы данных. Prisma - это набор инструментов, обеспечивающий декларативное моделирование данных, а ZenStack - это мощный пакет для Prisma, предоставляющий такие возможности, как контроль доступа, генерация спецификаций, автоматическое создание сервисов и многие другие улучшения.</p>
<p>Давайте сначала инициализируем наш проект для моделирования данных:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npm install -D prisma
npm install @prisma/client
npx zenstack@latest init
</code></pre>
<!-- /wp:code -->
<p>zenstack CLI устанавливает Prisma и другие зависимости и создает шаблонный файл schema.zmodel. Обновите его следующим содержимым, чтобы отразить наши требования:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">// schema.zmodel
datasource db {
    provider = 'sqlite'
    url = 'file:./petstore.db'
}

generator client {
    provider = "prisma-client-js"
}

model User {
    id String @id @default(cuid())
    email String @unique
    password String
    orders Order[]
}

model Pet {
    id String @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    name String
    category String
    order Order? @relation(fields: [orderId], references: [id])
    orderId String?
}

model Order {
    id String @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    pets Pet[]
    user User @relation(fields: [userId], references: [id])
    userId String
}
</code></pre>
<!-- /wp:code -->
<p>Выполните следующую команду, чтобы сгенерировать схему Prisma и поместить ее в базу данных:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npx zenstack generate
npx prisma db push
</code></pre>
<!-- /wp:code -->
<p>Также создайте файл prisma/seed.ts, который заполняет базу данных некоторыми данными. Затем, когда вы перезагрузите локальную базу данных, вы сможете повторно запустить сценарий для заполнения данных.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">// prisma/seed.ts
import { PrismaClient, Prisma } from '@prisma/client';

const prisma = new PrismaClient();

const petData: Prisma.PetCreateInput[] = [
    {
        id: 'luna',
        name: 'Luna',
        category: 'kitten',
    },
    {
        id: 'max',
        name: 'Max',
        category: 'doggie',
    },
    {
        id: 'cooper',
        name: 'Cooper',
        category: 'reptile',
    },
];

async function main() {
    console.log(`Start seeding ...`);
    for (const p of petData) {
        const pet = await prisma.pet.create({
            data: p,
        });
        console.log(`Created Pet with id: ${pet.id}`);
    }
    console.log(`Seeding finished.`);
}

main()
    .then(async () => {
        await prisma.$disconnect();
    })
    .catch(async (e) => {
        console.error(e);
        await prisma.$disconnect();
        process.exit(1);
    });
</code></pre>
<!-- /wp:code -->
<p>Запустите скрипт, чтобы засеять нашу базу данных:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npx tsx prisma/seed.ts
</code></pre>
<!-- /wp:code -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading" id="3-реализация-api">3. Реализация API</h3>
<p>ZenStack значительно упрощает разработку API, ориентированных на базы данных, предоставляя встроенную реализацию RESTful. Вы можете использовать адаптер, специфичный для фреймворка, для установки RESTful-сервисов в ваше приложение. Давайте посмотрим, как это сделать с помощью Express.js.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npm install @zenstackhq/server
</code></pre>
<!-- /wp:code -->
<p>Интеграция с Express.js осуществляется с помощью фабрики промежуточного ПО ZenStackMiddleware. Используйте его для монтирования RESTful API по выбранному вами пути. Обратный вызов getPrisma используется для получения экземпляра клиента Prisma для текущего запроса. Пока мы просто вернем глобальный клиент Prisma.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">// app.ts
import { PrismaClient } from '@prisma/client';
import { ZenStackMiddleware } from '@zenstackhq/server/express';
import express from 'express';

const app = express();
app.use(express.json());

const prisma = new PrismaClient();
app.use('/api', ZenStackMiddleware({ getPrisma: () => prisma }));

app.listen(3000, () => console.log('🚀 Server ready at: http://localhost:3000'));
</code></pre>
<!-- /wp:code -->
<p>С помощью этих нескольких строк кода у вас есть CRUD API для всех ресурсов - пользователя, питомца и заказа. Протестируйте его, получив всех питомцев:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl localhost:3000/api/pet/findMany
</code></pre>
<!-- /wp:code -->
<!-- wp:code -->
<pre class="wp-block-code"><code lang="json" class="language-json">[
    {
        "id": "luna",
        "createdAt": "2023-03-18T08:09:41.417Z",
        "updatedAt": "2023-03-18T08:09:41.417Z",
        "name": "Luna",
        "category": "kitten"
    },
    {
        "id": "max",
        "createdAt": "2023-03-18T08:09:41.419Z",
        "updatedAt": "2023-03-18T08:09:41.419Z",
        "name": "Max",
        "category": "doggie"
    },
    {
        "id": "cooper",
        "createdAt": "2023-03-18T08:09:41.420Z",
        "updatedAt": "2023-03-18T08:09:41.420Z",
        "name": "Cooper",
        "category": "reptile"
    }
]
</code></pre>
<!-- /wp:code -->
<p>Легко, не правда ли? Автоматически созданные API имеют отображение 1:1 на методы клиента Prisma - findMany, findUnique, create, update, aggregate и т.д. Они также имеют ту же структуру, что и PrismaClient, для входных аргументов и ответов. Для запросов POST и PUT входные аргументы отправляются непосредственно как тело запроса (application/json). Для запросов GET и DELETE входные аргументы сериализуются в JSON и отправляются как параметры запроса q (url-кодировка). Например, вы можете получить отфильтрованный список домашних животных по:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl 'http://localhost:3000/api/pet/findMany?q=%7B%22where%22%3A%7B%22category%22%3A%22doggie%22%7D%7D'
</code></pre>
<!-- /wp:code -->
<p>URL закодирован так: <a href="http://localhost:3000/api/pet/findMany?q=%7B%E2%80%9Cwhere%E2%80%9D:%7B%E2%80%9Ccategory%E2%80%9D" rel="noopener noreferrer nofollow" target="_blank">http://localhost:3000/api/pet/findMany?q={“where”:{“category”</a>: “doggie”}}.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="json" class="language-json">[
    {
        "id": "max",
        "createdAt": "2023-03-18T08:09:41.419Z",
        "updatedAt": "2023-03-18T08:09:41.419Z",
        "name": "Max",
        "category": "doggie"
    }
]
</code></pre>
<!-- /wp:code -->
<p>Наш API уже работает, но у него есть одна большая проблема: он не защищен никакими мерами безопасности. Любой может читать и обновлять любые данные. Давайте исправим это в следующих разделах в два этапа: аутентификация и авторизация.</p>
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading" id="4-добавление-аутентификации">4. Добавление аутентификации</h3>
<p>Для этого простого сервиса мы примем аутентификацию на основе email/пароля и будем выдавать JWT-токен для каждого успешного входа.</p>
<p>Сначала рассмотрим часть, связанную с регистрацией. Поскольку ресурс User уже имеет CRUD API, нам не нужно реализовывать отдельный API для регистрации, так как регистрация - это просто создание пользователя. Единственное, о чем нам нужно позаботиться, это убедиться, что мы храним хэшированные пароли, а не простой текст. Достичь этого просто: достаточно добавить атрибут @password к полю пароля. ZenStack автоматически хэширует поле перед сохранением его в базе данных. Обратите внимание, что мы также добавили атрибут @omit, чтобы пометить поле password, которое будет удалено из ответа, поскольку мы не хотим, чтобы оно когда-либо возвращалось клиенту.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">// schema.prisma
model User {
    id String @id @default(cuid())
    email String @unique
    password String @password @omit
    orders Order[]
}
</code></pre>
<!-- /wp:code -->
<p>Вход в систему требует проверки учетных данных, и нам необходимо реализовать ее вручную. Установите несколько новых зависимостей:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npm install bcryptjs jsonwebtoken dotenv
npm install -D @types/jsonwebtoken
</code></pre>
<!-- /wp:code -->
<p>Создайте файл .env под корнем и поместите в него переменную окружения JWT_SECRET. Вы всегда должны использовать сильный секрет в производстве.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">JWT_SECRET=abc123
</code></pre>
<!-- /wp:code -->
<p>Добавьте маршрут /api/login следующим образом:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">//app.ts
import dotenv from 'dotenv';
import jwt from 'jsonwebtoken';
import { compareSync } from 'bcryptjs';

// load .env environment variables
dotenv.config();

app.post('/api/login', async (req, res) => {
    const { email, password } = req.body;
    const user = await prisma.user.findFirst({
        where: { email },
    });
    if (!user || !compareSync(password, user.password)) {
        res.status(401).json({ error: 'Invalid credentials' });
    } else {
        // sign a JWT token and return it in the response
        const token = jwt.sign({ sub: user.id }, process.env.JWT_SECRET!);
        res.json({ id: user.id, email: user.email, token });
    }
});
</code></pre>
<!-- /wp:code -->
<p>Наконец, измените обратный вызов getPrisma в ZenStackMiddleware на улучшенный клиент Prisma, возвращаемый вызовом withPresets, чтобы атрибуты @password и @omit могли вступить в силу.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">// app.ts
import { withPresets } from '@zenstackhq/runtime';
app.use('/api', ZenStackMiddleware({ getPrisma: () => withPresets(prisma) }));
</code></pre>
<!-- /wp:code -->
<p>Имейте в виду, что в расширенном клиенте Prisma все операции CRUD по умолчанию запрещены, если вы не откроете их явно. Давайте откроем операции создания и чтения для User, чтобы поддержать поток регистрации/входа в систему:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">// schema.prisma
model User {
    id String @id @default(cuid())
    email String @unique
    password String @password @omit
    orders Order[]

    // everybody can signup
    @@allow('create', true)

    // user profile is publicly readable
    @@allow('read', true)
}
</code></pre>
<!-- /wp:code -->
<p>Теперь перегенерируйте схему Prisma и перенесите изменения в базу данных:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npx zenstack generate &#x26;&#x26; npx prisma db push
</code></pre>
<!-- /wp:code -->
<p>Перезапустите сервер разработчиков, и мы сможем протестировать наш поток регистрации/входа в систему.</p>
<p>Зарегистрируйте пользователя:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl -X POST localhost:3000/api/user/create \
    -H 'Content-Type: application/json' \
    -d '{ "data": { "email": "tom@pet.inc", "password": "abc123" } }'
</code></pre>
<!-- /wp:code -->
<!-- wp:code -->
<pre class="wp-block-code"><code lang="json" class="language-json">{
    "id": "clfan0lys0000vhtktutornel",
    "email": "tom@pet.inc"
}
</code></pre>
<!-- /wp:code -->
<p>Логин:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl -X POST localhost:3000/api/login \
    -H 'Content-Type: application/json' \
    -d '{ "email": "tom@pet.inc", "password": "abc123" }'
</code></pre>
<!-- /wp:code -->
<!-- wp:code -->
<pre class="wp-block-code"><code lang="json" class="language-json">{
    "id": "clfan0lys0000vhtktutornel",
    "email": "tom@pet.inc",
    "token": "..."
}
</code></pre>
<!-- /wp:code -->
<!-- wp:heading {"level":3} -->
<h3 class="wp-block-heading" id="5-добавление-авторизации">5. Добавление авторизации</h3>
<p>Теперь, когда аутентификация установлена, мы можем добавить правила контроля доступа в нашу схему, чтобы защитить нашу службу CRUD. Внесите следующие изменения в модели Pet и Order:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">// schema.prisma
model Pet {
    id String @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    name String
    category String
    order Order? @relation(fields: [orderId], references: [id])
    orderId String?

    // unsold pets are readable to all; sold ones are readable to buyers only
    @@allow('read', orderId == null || order.user == auth())

    // only allow update to 'orderId' field if it's not set yet (unsold)
    @@allow('update', name == future().name &#x26;&#x26; category == future().category &#x26;&#x26; orderId == null )
}

model Order {
    id String @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    pets Pet[]
    user User @relation(fields: [userId], references: [id])
    userId String

    // users can read their orders
    @@allow('read,create', auth() == user)
}
</code></pre>
<!-- /wp:code -->
<p>Синтаксис для @@allow и @@deny довольно понятен. Несколько моментов, на которые следует обратить внимание:</p>
<!-- wp:list -->
<ul><!-- wp:list-item -->
<li>Функция auth() возвращает текущего аутентифицированного пользователя. Вскоре вы увидите, как она подключается.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Функция future() возвращает значение сущности после применения обновления.</li>
<!-- /wp:list-item -->
<!-- wp:list-item -->
<li>Второе правило @@allow в модели Pet выглядит немного сложным. Оно необходимо, потому что мы хотим запретить создание заказов, включающих проданных питомцев. На уровне базы данных это означает, что поле orderId модели Pet может быть обновлено только в том случае, если оно равно null (то есть животное еще не продано). Мы также использовали функцию future(), чтобы запретить обновление других полей.</li>
<!-- /wp:list-item --></ul>
<!-- /wp:list -->
<p>Подробнее о политиках доступа вы можете узнать <a href="https://zenstack.dev/docs/guides/understanding-access-policy" target="_blank" rel="noreferrer noopener nofollow">здесь</a>.</p>
<p>Декларативно определяя политики доступа в схеме, вам больше не нужно реализовывать эти правила в API. Легче обеспечить согласованность, что делает схему единым источником истины для формы ваших данных и правил безопасности.</p>
<p>Однако одной детали все еще не хватает: нам нужно подключить аутентифицированную личность пользователя к системе, чтобы функция auth() работала. Для этого мы потребуем от вызывающих API передавать токен JWT в качестве маркера предъявителя в заголовке авторизации. Затем на стороне сервера мы извлекаем его из текущего запроса и передаем в вызов withPresets в качестве контекста.</p>
<p>Добавляем помощник getUser для декодирования пользователя из токена и передаем его в вызов withPresets:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">// app.ts
import type { Request } from 'express';

function getUser(req: Request) {
    const token = req.headers.authorization?.split(' ')[1];
    console.log('TOKEN:', token);
    if (!token) {
        return undefined;
    }
    try {
        const decoded: any = jwt.verify(token, process.env.JWT_SECRET!);
        return { id: decoded.sub };
    } catch {
        // bad token
        return undefined;
    }
}

app.use(
    '/api',
    ZenStackMiddleware({
        getPrisma: (req) => {
            return withPresets(prisma, { user: getUser(req) });
        },
    })
);
</code></pre>
<!-- /wp:code -->
<p>Теперь механизм политики имеет доступ к аутентифицированному пользователю и может применять правила авторизации. Перезапустите генерацию кода и перезапустите сервер dev. Теперь давайте протестируем авторизацию.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npx zenstack generate &#x26;&#x26; npx prisma db push
</code></pre>
<!-- /wp:code -->
<ol start="6">
<li>Тестирование авторизации</li>
</ol>
<p>Войдите в систему, чтобы получить токен:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl -X POST localhost:3000/api/login \
    -H 'Content-Type: application/json' \
    -d '{ "email": "tom@pet.inc", "password": "abc123" }'
</code></pre>
<!-- /wp:code -->
<!-- wp:code -->
<pre class="wp-block-code"><code lang="json" class="language-json">{
    "id": "&#x3C;user id>",
    "email": "tom@pet.inc",
    "token": "&#x3C;token>"
}
</code></pre>
<!-- /wp:code -->
<p>Сохраните возвращенные идентификатор пользователя и токен в переменных окружения для дальнейшего использования:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">userId=&#x3C;user id>
token=&#x3C;token>
</code></pre>
<!-- /wp:code -->
<p>Создание заказа:</p>
<p>Разместите заказ на кошку ”Луна”. Обратите внимание, что мы передаем маркер в заголовке авторизации.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl -X POST localhost:3000/api/order/create \
    -H 'Content-Type: application/json' -H "Authorization: Bearer $token"  \
    -d "{ \"data\": { \"userId\": \"$userId\", \"pets\": { \"connect\": { \"id\": \"luna\" } } } }"
</code></pre>
<!-- /wp:code -->
<!-- wp:code -->
<pre class="wp-block-code"><code lang="json" class="language-json">{
    "id": "clfapaykz0002vhwr634sd9l7",
    "createdAt": "2023-03-16T05:59:04.586Z",
    "updatedAt": "2023-03-16T05:59:04.586Z",
    "userId": "clfan0lys0000vhtktutornel"
}
</code></pre>
<!-- /wp:code -->
<p>Разместите список домашних животных анонимно:</p>
<p>”Луна” больше нет, потому что она продана.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl localhost:3000/api/pet/findMany
</code></pre>
<!-- /wp:code -->
<!-- wp:code -->
<pre class="wp-block-code"><code lang="json" class="language-json">[
    {
        "id": "clfamyjp90002vhql2ng70ay8",
        "createdAt": "2023-03-16T04:53:26.205Z",
        "updatedAt": "2023-03-16T04:53:26.205Z",
        "name": "Max",
        "category": "doggie"
    },
    {
        "id": "clfamyjpa0004vhql4u0ys8lf",
        "createdAt": "2023-03-16T04:53:26.206Z",
        "updatedAt": "2023-03-16T04:53:26.206Z",
        "name": "Cooper",
        "category": "reptile"
    }
]
</code></pre>
<!-- /wp:code -->
<p>Перечислите питомцев с учетными данными:</p>
<p>“Luna” снова видна (с указанием OrderId), потому что пользователь, который делает заказ, может читать питомцев в нем.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl localhost:3000/api/pet/findMany -H "Authorization: Bearer $token"
</code></pre>
<!-- /wp:code -->
<!-- wp:code -->
<pre class="wp-block-code"><code lang="json" class="language-json">[
    {
        "id": "clfamyjp60000vhql266hko28",
        "createdAt": "2023-03-16T04:53:26.203Z",
        "updatedAt": "2023-03-16T05:59:04.586Z",
        "name": "Luna",
        "category": "kitten",
        "orderId": "clfapaykz0002vhwr634sd9l7"
    },
    {
        "id": "clfamyjp90002vhql2ng70ay8",
        "createdAt": "2023-03-16T04:53:26.205Z",
        "updatedAt": "2023-03-16T04:53:26.205Z",
        "name": "Max",
        "category": "doggie"
    },
    {
        "id": "clfamyjpa0004vhql4u0ys8lf",
        "createdAt": "2023-03-16T04:53:26.206Z",
        "updatedAt": "2023-03-16T04:53:26.206Z",
        "name": "Cooper",
        "category": "reptile"
    }
]
</code></pre>
<!-- /wp:code -->
<p>Повторное создание заказа для “Luna” приведет к ошибке:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">curl -X POST localhost:3000/api/order/create \
    -H 'Content-Type: application/json' -H "Authorization: Bearer $token"  \
    -d "{ \"data\": { \"userId\": \"$userId\", \"pets\": { \"connect\": { \"id\": \"luna\" } } } }"
</code></pre>
<!-- /wp:code -->
<!-- wp:code -->
<pre class="wp-block-code"><code lang="json" class="language-json">{
    "prisma": true,
    "rejectedByPolicy": true,
    "code": "P2004",
    "message": "denied by policy: Pet entities failed 'update' check, 1 entity failed policy check"
}
</code></pre>
<!-- /wp:code -->
<p>Вы можете продолжить тестирование с моделью Order и посмотреть, соответствует ли ее поведение политике доступа.</p>
<h2 class="wp-block-heading" id="генерация-спецификации-open-api">Генерация спецификации OpenAPI</h2>
<p>На данный момент мы реализовали безопасный REST-подобный API. Он не полностью соответствует дизайну конечной точки RESTful API, ориентированному на ресурсы, но полностью сохраняет гибкость запросов к данным Prisma.</p>
<p>Чтобы назвать его OpenAPI, мы должны предложить формальную спецификацию. К счастью, ZenStack может генерировать спецификации OpenAPI V3 для вас. Вам нужно только включить плагин в вашей схеме:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npm install -D @zenstackhq/openapi
</code></pre>
<!-- /wp:code -->
<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">// schema.prisma
plugin openapi {
    provider = '@zenstackhq/openapi'
    prefix = '/api'
    title = 'Pet Store API'
    version = '0.1.0'
    description = 'My awesome pet store API'
    output = 'petstore-api.json'
}
</code></pre>
<!-- /wp:code -->
<p>Когда вы запустите zenstack generate, он сгенерирует для вас файл petstore-api.json. Вы можете передать его потребителю API с помощью таких инструментов, как Swagger UI.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npx zenstack generate
</code></pre>
<!-- /wp:code -->
<p>Однако здесь есть оговорка: помните, мы вручную реализовали конечную точку /api/login? ZenStack не знает этого, и сгенерированная спецификация JSON не включает ее. Однако мы можем использовать некоторые дополнительные инструменты, чтобы исправить это.</p>
<p>Сначала установите некоторые новые зависимости:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npm install swagger-ui-express express-jsdoc-swagger
npm install -D @types/swagger-ui-express
</code></pre>
<!-- /wp:code -->
<p>Затем добавьте JSDoc для указания его входа и выхода в маршрут /api/login:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">// app.ts
/**
 * Login input
 * @typedef {object} LoginInput
 * @property {string} email.required - The email
 * @property {string} password.required - The password
 */

/**
 * Login response
 * @typedef {object} LoginResponse
 * @property {string} id.required - The user id
 * @property {string} email.required - The user email
 * @property {string} token.required - The access token
 */

/**
 * POST /api/login
 * @tags user
 * @param {LoginInput} request.body.required - input
 * @return {LoginResponse} 200 - login response
 */
app.post('/api/login', async (req, res) => {
    ...
}
</code></pre>
<!-- /wp:code -->
<p>JSDoc прикрепляет метаданные OpenAPI к маршруту /api/login. Затем мы можем использовать express-jsdoc-swagger и swagger-ui-express, чтобы объединить эти два фрагмента спецификации API и создать для них Swagger UI:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">// app.ts
import expressJSDocSwagger from 'express-jsdoc-swagger';

// load the CRUD API spec from the JSON file generated by `zenstack`
const crudApiSpec = require('./petstore-api.json');

// options for loading the extra OpenAPI from JSDoc
const swaggerOptions = {
    info: {
        version: '0.1.0',
        title: 'Pet Store API',
    },
    filesPattern: './app.ts', // scan app.ts for OpenAPI JSDoc
    baseDir: __dirname,
    exposeApiDocs: true,
    apiDocsPath: '/v3/api-docs', // serve the merged JSON specifcation at /v3/api-docs
};

// merge two specs and serve the UI
expressJSDocSwagger(app)(swaggerOptions, crudApiSpec);
</code></pre>
<!-- /wp:code -->
<p>Теперь, если вы нажмете <a href="http://localhost:3000/api-docs" rel="noopener noreferrer nofollow" target="_blank">http://localhost:3000/api-docs</a>, вы увидите пользовательский интерфейс документации API. Вы также можете получить доступ к необработанной спецификации JSON по адресу <a href="http://localhost:3000/v3/api-docs" rel="noopener noreferrer nofollow" target="_blank">http://localhost:3000/v3/api-docs</a>.</p>
<!-- wp:image -->
<figure class="wp-block-image"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--lQJdusGZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://zenstack.dev/../../assets/images/2023-03-18-09-21-50-3f15967125aa8e93df52098d8c1594cb.png" alt="Swagger UI"></figure>
<!-- /wp:image -->
<h2 class="wp-block-heading" id="генерация-sdk-клиента">Генерация SDK клиента</h2>
<p>Отлично! У нас есть работающий сервис с формальной спецификацией. Теперь потребители могут реализовать клиентов для общения с ним, используя любой HTTP-клиент. Благодаря спецификации OpenAPI мы можем сделать еще один шаг и создать для них SDK с сильным типом клиента.</p>
<p>В этом примере мы достигнем этого, используя <a href="https://github.com/drwpow/openapi-typescript" target="_blank" rel="noreferrer noopener nofollow">openapi-typescript</a> и <a href="https://github.com/drwpow/openapi-typescript-fetch" target="_blank" rel="noreferrer noopener nofollow">openapi-typescript-fetch</a>.</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npm install -D openapi-typescript @types/node-fetch
npm install node-fetch openapi-typescript-fetch
npx openapi-typescript http://localhost:3000/v3/api-docs --output ./client-types.ts
</code></pre>
<!-- /wp:code -->
<p>Затем мы можем использовать сгенерированные типы для выполнения вызовов API с сильной типизацией (как для ввода, так и для вывода). Создайте файл client.ts, чтобы опробовать его:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="typescript" class="language-typescript">// client.ts
import fetch, { Headers, Request, Response } from 'node-fetch';
import { Fetcher } from 'openapi-typescript-fetch';
import { paths } from './client-types';

// polyfill `fetch` for node
if (!globalThis.fetch) {
    globalThis.fetch = fetch as any;
    globalThis.Headers = Headers as any;
    globalThis.Request = Request as any;
    globalThis.Response = Response as any;
}

async function main() {
    const fetcher = Fetcher.for&#x3C;paths>();
    fetcher.configure({
        baseUrl: 'http://localhost:3000',
    });

    const login = fetcher.path('/api/login').method('post').create();
    const { data: loginResult } = await login({
        email: 'tom@pet.inc',
        password: 'abc123',
    });
    // loginResult is typed as { id: string, email: string, token: string }
    console.log('Login result:', JSON.stringify(loginResult, undefined, 2));
    const token = loginResult.token;

    // get orders together with their pets
    const getOrders = fetcher.path(`/api/order/findMany`).method('get').create();
    const { data: orders } = await getOrders(
        { q: JSON.stringify({ include: { pets: true } }) },
        { headers: { Authorization: `Bearer ${token}` } }
    );
    console.log('Orders:', JSON.stringify(orders, undefined, 2));
}

main();
</code></pre>
<!-- /wp:code -->
<p>Вы можете запустить его с:</p>
<!-- wp:code -->
<pre class="wp-block-code"><code lang="bash" class="language-bash">npx tsx client.ts
</code></pre>
<!-- /wp:code -->
<h2 class="wp-block-heading" id="подведение-итогов">Подведение итогов</h2>
<p>Создание сервиса OpenAPI, ориентированного на базу данных, включает множество задач: проектирование модели данных, составление спецификации, реализация сервиса и создание клиентского SDK. Но, как вы видите, это не обязательно должно быть сложно и долго.</p>
<p>Главный вывод: если вы можете использовать единый источник истины для представления схемы данных и правил доступа, на его основе можно создать множество других артефактов. Это сэкономит ваше драгоценное время на написание шаблонного кода, а также значительно упростит синхронизацию всего процесса.</p>
<p>Готовый проект можно найти <a href="https://github.com/ymc9/petstore-openapi-zenstack" target="_blank" rel="noreferrer noopener nofollow">здесь</a>.</p>
<p>P.S. Мы создаем <a href="https://zenstack.dev/?utm_campaign=devto&#x26;utm_medium=organic&#x26;utm_content=openapi" target="_blank" rel="noreferrer noopener nofollow">ZenStack</a>, набор инструментов, который усиливает Prisma ORM мощным слоем управления доступом и раскрывает его полный потенциал для фуллстэк разработки.</p> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Создание безопасного OpenAPI, ориентированного на базу данных, за 15 минут&url=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&url=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut&title=Создание безопасного OpenAPI, ориентированного на базу данных, за 15 минут&summary=Если вы являетесь разработчиком, знакомым с RESTful API, вы, возможно, слышали о OpenAPI. Это спецификация для описания RESTful API в формате, читаемом людьми и машинами. Создание публичного OpenAPI включает в себя три задачи:&source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/sozdanie-bezopasnogo-openapi-orientirovannogo-na-bazu-dannyh-za-15-minut&media=&description=Если вы являетесь разработчиком, знакомым с RESTful API, вы, возможно, слышали о OpenAPI. Это спецификация для описания RESTful API в формате, читаемом людьми и машинами. Создание публичного OpenAPI включает в себя три задачи:" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <nav class="circular-pagination" aria-label="Circular Pagination" data-astro-cid-ihkjvfsn> <a href="/blog/sozdanie-bolee-bezopasnyh-onlajn-soobshhestv-s-pomoshhyu-ii-ml-moderaczii-kontenta" class="circular-pagination__link circular-pagination__link--prev" data-astro-cid-ihkjvfsn> Создание более безопасных онлайн-сообществ с помощью ИИ/МЛ модерации контента </a> <a href="/blog/sozdanie-axios-interceptors-v-react-i-nextjs" class="circular-pagination__link circular-pagination__link--next" data-astro-cid-ihkjvfsn> Создание Axios interceptors в React и NextJs </a> </nav>  </div> </div> </article> <div class="container" data-astro-cid-axzg2cw6> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="Z1T5Wnr" prefix="r0" component-url="/_astro/YandexRelatedAds.D-6fTqBY.js" component-export="default" renderer-url="/_astro/client.Bd2Qst3j.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;YandexRelatedAds&quot;,&quot;value&quot;:true}" await-children=""><div id="yandex_rtb_C-A-2592503-2"></div><!--astro:end--></astro-island> </div> <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();</script><astro-island uid="Zs59T3" component-url="/_astro/CommentBlock.ChJFdf82.js" component-export="default" renderer-url="/_astro/client.44T8euMP.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;CommentBlock&quot;,&quot;value&quot;:true}"></astro-island>  <!-- <div class="blocks__container container">
			<CtaBlock id="cta" class=""
			/>
		</div> --> </div>    </main> <footer class="footer" data-astro-cid-dwelrhxs> <div class="footer__container container" data-astro-cid-dwelrhxs> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg footer__logo dark:hover:text-light text-blue dark:text-white" aria-label="logo" data-astro-cid-ijoll5s5> <svg width="1.44em" height="1em" viewBox="0 0 5660 3931" class="icon" data-astro-cid-ijoll5s5 data-icon="logo-one">  <use xlink:href="#ai:local:logo-one"></use>  </svg>  </a> <small class="footer__copyright" data-astro-cid-dwelrhxs>все права защищены. © 2024</small> </div> </footer>  </body></html>