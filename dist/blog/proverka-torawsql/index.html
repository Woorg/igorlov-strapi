<!DOCTYPE html><html lang="ru"> <head><title>Проверка ToRawSql - Фул Фронт Дев
</title><link rel="canonical" href="https://igorlov.ru/blog/proverka-torawsql"><meta name="description" content="В недавнем прошлом мы могли выгружать SQL, который генерировал наш построитель запросов, следующим образом:
"><meta name="robots" content="index, follow"><!-- favicon --><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><!-- theme meta --><meta name="theme-name" content="igorlov.ru"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="generator" content="Astro v4.9.1"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- responsive meta --><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><meta name="google-adsense-account" content="ca-pub-0634695143666394"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/_regular_.CgLqGwzk.css">
<style>.breadcrumbs[data-astro-cid-vcbh62el]{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#0d52a1;color:rgba(13,82,161,var(--tw-text-opacity));border-radius:min(1.5rem,1.1625rem + .45vw);padding:min(2rem,1.2125rem + 1.05vw)}.breadcrumbs[data-astro-cid-vcbh62el]:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}.container[data-astro-cid-vcbh62el]{padding:min(2rem,1.2125rem + 1.05vw)}.list[data-astro-cid-vcbh62el]{display:flex;align-items:center;gap:.125rem}.link[data-astro-cid-vcbh62el]{font-weight:500;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;padding:.125rem .75rem;font-size:min(1.5rem,1.1625rem + .45vw);line-height:var(--tw-lh)}
</style>
<link rel="stylesheet" href="/_astro/_single_.C0aKA9dM.css">
<style>.circular-pagination[data-astro-cid-ihkjvfsn]{display:flex;width:100%;flex-wrap:wrap;align-items:center;justify-content:center;overflow:hidden;border-top-width:1px;--tw-border-opacity: 1;border-color:#27292d;border-color:rgba(39,41,45,var(--tw-border-opacity));margin-top:min(1.25rem,1.1375rem + .15vw)}.circular-pagination__link[data-astro-cid-ihkjvfsn]{width:100%;--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity));text-decoration-line:none}.circular-pagination__link[data-astro-cid-ihkjvfsn]:hover{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.circular-pagination__link[data-astro-cid-ihkjvfsn]{padding-left:min(1.5rem,1.1625rem + .45vw);padding-right:min(1.5rem,1.1625rem + .45vw);padding-top:.5rem;padding-bottom:.5rem}
.comments[data-v-f9c4118f]{margin:auto;margin-top:1.25rem;width:100%;--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.comments:where([class=dark][data-v-f9c4118f],[class=dark] *[data-v-f9c4118f]){--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.giscus-frame[data-v-f9c4118f]{width:100%;--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.giscus-frame:where([class=dark][data-v-f9c4118f],[class=dark] *[data-v-f9c4118f]){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity))}
</style><script type="module" src="/_astro/hoisted.CUFolni_.js"></script><style>[data-astro-transition-scope="astro-r75ddqls-1"] { view-transition-name: blog-image-proverka-torawsql; }</style></head> <body class="flex min-h-screen flex-col bg-gray-light pt-16 font-inter text-blue fluid:text-lg lg:pt-24 dark:bg-black dark:text-white"> <header class="header" data-astro-cid-rq644orq> <div class="header__container container" data-astro-cid-rq644orq> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg header__logo dark:hover:text-light text-blue dark:text-white" aria-label="logo" data-astro-cid-ijoll5s5> <svg width="1.44em" height="1em" viewBox="0 0 5660 3931" class="icon" data-astro-cid-ijoll5s5 data-icon="logo-one">  <symbol id="ai:local:logo-one"><g fill="currentColor"><path d="M1198.57 596.749c0 329.575-267.171 596.751-596.747 596.751-329.575 0-596.749-267.176-596.749-596.751S272.248 0 601.823 0c329.576 0 596.747 267.174 596.747 596.749Z"/><circle cx="3035.75" cy="617.751" r="596.749" transform="rotate(-90 3035.75 617.751)"/><path d="M3035.75 2736.81c329.57 0 596.75 267.18 596.75 596.75 0 329.58-267.18 596.75-596.75 596.75-329.58 0-596.75-267.17-596.75-596.75 0-329.57 267.17-596.75 596.75-596.75Z"/><circle cx="596.749" cy="1964.8" r="596.749"/><path d="M1193.5 3332.87c0 329.57-267.176 596.75-596.751 596.75S0 3662.44 0 3332.87c0-329.58 267.174-596.75 596.749-596.75 329.575 0 596.751 267.17 596.751 596.75Z"/><circle cx="5062.46" cy="617.751" r="596.749" transform="rotate(-90 5062.46 617.751)"/><circle cx="5062.46" cy="3333.56" r="596.749" transform="rotate(-90 5062.46 3333.56)"/></g></symbol><use xlink:href="#ai:local:logo-one"></use>  </svg>  </a> <div class="nav header__nav" data-astro-cid-7wkmezxd> <button class="nav__open" title="Открыть меню" data-astro-cid-7wkmezxd> Меню</button> <nav class="nav__container" data-astro-cid-7wkmezxd> <button class="nav__close" title="Закрыть меню" data-astro-cid-7wkmezxd> Закрыть</button> <ul class="nav__list" data-astro-cid-7wkmezxd> <li class="nav__item" data-astro-cid-7wkmezxd> <a href="/blog" class="nav__link nav__link--active" data-astro-cid-7wkmezxd> Блог </a> </li><li class="nav__item" data-astro-cid-7wkmezxd> <a href="#cta" class="nav__link" data-astro-cid-7wkmezxd> Контакты </a> </li> </ul> </nav> </div>   <!-- <ThemeToggle client:only /> --> </div> </header>  <main id="main-content" class="main flex-1">  <div class="blocks"> <nav aria-label="Breadcrumbs" class="breadcrumbs" data-astro-cid-vcbh62el> <div class="container" data-astro-cid-vcbh62el> <ol class="list" role="list" data-astro-cid-vcbh62el> <li class="item" role="listitem" data-astro-cid-vcbh62el> <a class="link" href="/" data-astro-cid-vcbh62el> Главная </a> </li><li class="item" role="listitem" data-astro-cid-vcbh62el> <a class="link" href="/blog" data-astro-cid-vcbh62el> Blog </a> </li><li class="item" role="listitem" data-astro-cid-vcbh62el>  </li> </ol> </div> </nav>  <!-- <TextAds class="fade-in-bottom fluid:my-2" style="--delay: .8s;" /> --><article class="article" data-astro-cid-axzg2cw6> <div class="container" data-astro-cid-axzg2cw6> <div class="article__header" data-astro-cid-axzg2cw6> <ul class="article__categories categories" data-astro-cid-axzg2cw6> <li class="categories__item" data-astro-cid-axzg2cw6> <a href="/category/как-закодить" class="categories__link" data-astro-cid-axzg2cw6> Как закодить  </a> </li> </ul> <h1 class="article__title text-wrap" data-astro-cid-axzg2cw6> Проверка toRawSql </h1> <ul class="article__tags tags" data-astro-cid-axzg2cw6> <li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/laravel" data-astro-cid-axzg2cw6> Laravel </a> </li><li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/torawsql" data-astro-cid-axzg2cw6> ToRawSql </a> </li> </ul> <time class="article__date" data-astro-cid-axzg2cw6>
Опубликовано 26 окт., 2023 by Igor Gorlov </time> <time class="article__date" data-astro-cid-axzg2cw6> Последнее изменение: 21 мар., 2024 </time> </div> <article data-astro-cid-axzg2cw6> <figure class="article__image" data-astro-cid-axzg2cw6> <picture data-astro-cid-axzg2cw6> <source srcset="/_astro/proverka-torawsql-Oct-26-2023.CspUpAlA_18pCA3.avif" type="image/avif"><source srcset="/_astro/proverka-torawsql-Oct-26-2023.CspUpAlA_Is3l1.webp" type="image/webp"> <img src="/_astro/proverka-torawsql-Oct-26-2023.CspUpAlA_1aQYpu.png" alt="Проверка toRawSql" class="aspect-video h-full w-full object-cover object-center" loading="eager" data-astro-cid-axzg2cw6 data-astro-transition-scope="astro-r75ddqls-1" width="1120" height="580" decoding="async"> </picture> </figure> </article> <div class="article__content prose prose-zinc max-w-full break-words text-blue dark:prose-invert prose-headings:text-blue prose-p:text-balance prose-a:no-underline hover:prose-a:underline prose-figure:bg-gray-light prose-figure:p-10 prose-figcaption:text-dark dark:prose-figure:bg-dark dark:prose-figcaption:text-white" data-astro-cid-axzg2cw6> <div id="adfox_17062261612859555"></div> <script>(function(){const blockId = "adfox_17062261612859555";

	window.yaContextCb = window.yaContextCb || [];
	window.yaContextCb.push(() => {
		Ya.adfoxCode.createAdaptive(
			{
				ownerId: 1493338,
				containerId: blockId,
				params: {
					p1: 'dawgg',
					p2: 'p',
				},
			},
			['desktop', 'tablet', 'phone'],
			{
				tabletWidth: 830,
				phoneWidth: 480,
				isAutoReloads: true,
			},
		);
	});
})();</script> <div class="article__meta" data-astro-cid-axzg2cw6> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/proverka-torawsql" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/proverka-torawsql" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Проверка toRawSql&url=https://igorlov.ru/blog/proverka-torawsql" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&url=https://igorlov.ru/blog/proverka-torawsql&title=Проверка toRawSql&summary=В недавнем прошлом мы могли выгружать SQL, который генерировал наш построитель запросов, следующим образом:
&source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/proverka-torawsql&media=&description=В недавнем прошлом мы могли выгружать SQL, который генерировал наш построитель запросов, следующим образом:
" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <a class="article__meta-section" href="#comments" data-astro-cid-axzg2cw6> Комментарии</a> </div> <details open  class="toc border border-blue text-blue fluid:p-8 cursor-pointer rounded-[50px]"><summary class="toc__title text-xl font-medium">Содержание</summary><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#получение-полного-запроса">Получение полного запроса</a></li><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#как-это-работает">Как это работает</a></li></ol></details open ><p>В недавнем прошлом мы могли выгружать SQL, который генерировал наш построитель запросов, следующим образом:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A6ACCD">$</span><span style="color:#E4F0FB">filter</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> '</span><span style="color:#5DE4C7">wew, dogs</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">// Using the `toSql()` helper</span></span>
<span class="line"><span style="color:#ADD7FF">DB</span><span style="color:#91B4D5">::</span><span style="color:#E4F0FBD0">table</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">foo</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#91B4D5">  -></span><span style="color:#E4F0FBD0">select</span><span style="color:#A6ACCD">([</span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">id</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">col1</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">col2</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">])</span></span>
<span class="line"><span style="color:#91B4D5">  -></span><span style="color:#E4F0FBD0">join</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">bar</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">foo.bar_id</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">bar.id</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#91B4D5">  -></span><span style="color:#E4F0FBD0">where</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">foo.some_colum</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, $</span><span style="color:#E4F0FB">filter</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#91B4D5">  -></span><span style="color:#E4F0FBD0">toSql</span><span style="color:#A6ACCD">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">// SELECT id, col1, cole2</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">//     FROM foo</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">//     INNER JOIN nar on foo.bar_id = bar.id</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">//     WHERE foo.some_column = ?</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>Это было полезно для отладки сложных запросов, но обратите внимание, как мы не получили значение в нашем операторе WHERE! Все, что мы получили, - это назойливый символ ? - заполнитель для значения, которое мы передаем в запрос. Фактическое значение скрыто от нас.</p>
<p>”Это не то, что мне нужно”, вы, возможно, сказали себе. Предполагая, что мы не отлаживаем синтаксис SQL, наши привязки запросов, вероятно, являются тем, что нас в большинстве случаев больше всего интересует.</p>
<h2 id="получение-полного-запроса">Получение полного запроса<a aria-hidden="true" tabindex="-1" href="#получение-полного-запроса"><span class="icon icon-link"></span></a></h2>
<p>В новой версии Laravel 10.15 появилась возможность получить полный SQL-запрос! Это гораздо более полезно для отладки.</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A6ACCD">$</span><span style="color:#E4F0FB">filter</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> '</span><span style="color:#5DE4C7">wew, dogs</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">// Using the `toRawSql()` helper</span></span>
<span class="line"><span style="color:#ADD7FF">DB</span><span style="color:#91B4D5">::</span><span style="color:#E4F0FBD0">table</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">foo</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#91B4D5">  -></span><span style="color:#E4F0FBD0">select</span><span style="color:#A6ACCD">([</span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">id</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">col1</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">col2</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">])</span></span>
<span class="line"><span style="color:#91B4D5">  -></span><span style="color:#E4F0FBD0">join</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">bar</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">foo.bar_id</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">bar.id</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#91B4D5">  -></span><span style="color:#E4F0FBD0">where</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">foo.some_colum</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">, $</span><span style="color:#E4F0FB">filter</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#91B4D5">  -></span><span style="color:#E4F0FBD0">toRawSql</span><span style="color:#A6ACCD">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">// SELECT "id", "col1", "col2"</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">//     FROM "foo"</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">//     INNER JOIN "bar" ON "foo"."bar_id" = "bar"."id"</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">//     WHERE "foo"."some_colum" = 'wew, dogs'"</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>то гораздо лучше!</p>
<p>Секрет заключается в том, что PDO (основная библиотека, используемая для подключения к базам данных) не предоставляет нам SQL-запроса сразу - мы можем получить только SQL с заполнителями (отсюда и ограничение старого метода toSql()).</p>
<p>Поэтому нам нужно сами создать запрос с учетом наших значений! Как это делается?</p>
<h2 id="как-это-работает">Как это работает<a aria-hidden="true" tabindex="-1" href="#как-это-работает"><span class="icon icon-link"></span></a></h2>
<p>Это довольно сложная задача, поскольку мы имеем дело с пользовательским вводом - любой нелепый запрос, который разработчик (или его пользователи) могут передать в SQL-запрос, должен быть правильно экранирован.</p>
<p>Новый вспомогательный метод toRawSql() выполняет важную логику в методе с именем substituteBindingsIntoRawSql(). Вот ссылка на соответствующий pull request для справки.</p>
<p>Если мы немного вглядимся в код этого метода, мы увидим, что в нем происходит!</p>
<p>Первое, что делает функция, - это экранирует все значения. Это позволяет Laravel выводить запрос как строку, не беспокоясь о несоответствии кавычек или подобных проблем.</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A6ACCD">$</span><span style="color:#E4F0FB">bindings</span><span style="color:#91B4D5"> =</span><span style="color:#E4F0FBD0"> array_map</span><span style="color:#A6ACCD">(</span><span style="color:#91B4D5">fn</span><span style="color:#A6ACCD"> ($</span><span style="color:#E4F0FB">value</span><span style="color:#A6ACCD">) => </span><span style="color:#A6ACCD;font-style:italic">$</span><span style="color:#5DE4C7;font-style:italic">this</span><span style="color:#91B4D5">-></span><span style="color:#E4F0FBD0">escape</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">value</span><span style="color:#A6ACCD">), $</span><span style="color:#E4F0FB">bindings</span><span style="color:#A6ACCD">);</span></span>
<span class="line"></span></code></pre>
<p>Вызов $this->escape() передает выполнение объекту подключения к базе данных и глубже - в базовый объект PDO. PDO фактически выполняет работу по экранированию значений запроса безопасным образом.</p>
<p>Если ваше подключение к базе данных не настроено или не работает, вы можете получить ошибку ”Отказ в соединении” при использовании метода toRawSql(). Это происходит потому, что внутренний код использует объект “connection” (внутри PDO) для экранирования символов в выводе.</p>
<p>После экранирования значений метод проходит по запросу посимвольно!</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A6ACCD">for ($</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> =</span><span style="color:#5DE4C7"> 0</span><span style="color:#A6ACCD">; $</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> &#x3C;</span><span style="color:#E4F0FBD0"> strlen</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">); $</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5">++</span><span style="color:#A6ACCD">) {</span></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">[$</span><span style="color:#E4F0FB">i</span><span style="color:#A6ACCD">];</span></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">nextChar</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">[$</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> +</span><span style="color:#5DE4C7"> 1</span><span style="color:#A6ACCD">] </span><span style="color:#91B4D5">??</span><span style="color:#5DE4C7"> null</span><span style="color:#A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">    // and so on</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"></span></code></pre>
<p>Различные базы данных, которые поддерживаются в Laravel, используют разные конвенции для символов экранирования. Этот код пытается найти символы экранирования и игнорировать их, чтобы не пытаться подставить что-то, что похоже на символ привязки запроса, но им не является. Это самый сложный момент в этой новой функции.</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A6ACCD">$</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> ''</span><span style="color:#A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">for ($</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> =</span><span style="color:#5DE4C7"> 0</span><span style="color:#A6ACCD">; $</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> &#x3C;</span><span style="color:#E4F0FBD0"> strlen</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">); $</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5">++</span><span style="color:#A6ACCD">) {</span></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">[$</span><span style="color:#E4F0FB">i</span><span style="color:#A6ACCD">];</span></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">nextChar</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">[$</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> +</span><span style="color:#5DE4C7"> 1</span><span style="color:#A6ACCD">] </span><span style="color:#91B4D5">??</span><span style="color:#5DE4C7"> null</span><span style="color:#A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">    // Single quotes can be escaped as '' according to the SQL standard while</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">    // MySQL uses \'. Postgres has operators like ?| that must get encoded</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">    // in PHP like ??|. We should skip over the escaped characters here.</span></span>
<span class="line"><span style="color:#A6ACCD">    if (</span><span style="color:#E4F0FBD0">in_array</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5">.</span><span style="color:#A6ACCD">$</span><span style="color:#E4F0FB">nextChar</span><span style="color:#A6ACCD">, [</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">\'</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">''</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">??</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">])) {</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">        // We are building the query string back up - We ignore escaped characters</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">        // and append them to our rebuilt query string. Since we append</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">        // two characters, we `$i += 1` so the loop skips $nextChar in our `for` loop</span></span>
<span class="line"><span style="color:#A6ACCD">        $</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> .=</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5">.</span><span style="color:#A6ACCD">$</span><span style="color:#E4F0FB">nextChar</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">        $</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> +=</span><span style="color:#5DE4C7"> 1</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">    } </span><span style="color:#91B4D5">...</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"></span></code></pre>
<p>Цикл for перестраивает строку запроса, подставляя значения вместо их заполнителей ?. Первая проверка здесь ищет определенные символы экранирования. Для того чтобы знать, является ли символ экранирования, и, следовательно, не следует выполнять замену, необходимо знать текущий символ И следующий символ.</p>
<p>Следующая часть условия - это:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A6ACCD">} elseif ($</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5"> ===</span><span style="color:#A6ACCD"> "</span><span style="color:#5DE4C7">'</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">) { </span><span style="color:#767C9DB0;font-style:italic">// Starting / leaving string literal...</span></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> .=</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">char</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">isStringLiteral</span><span style="color:#91B4D5"> =</span><span style="color:#91B4D5"> !</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">isStringLiteral</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"></span></code></pre>
<p>Если мы открываем неэкранированную кавычку, это означает, что мы находимся в начале (или конце) строкового литерала. Мы устанавливаем флаг для этого случая, который важен для нашей следующей проверки.</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A6ACCD">elseif ($</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5"> ===</span><span style="color:#A6ACCD"> '</span><span style="color:#5DE4C7">?</span><span style="color:#A6ACCD">'</span><span style="color:#91B4D5"> &#x26;&#x26;</span><span style="color:#91B4D5"> !</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">isStringLiteral</span><span style="color:#A6ACCD">) { </span><span style="color:#767C9DB0;font-style:italic">// Substitutable binding...</span></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> .=</span><span style="color:#E4F0FBD0"> array_shift</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">bindings</span><span style="color:#A6ACCD">) </span><span style="color:#91B4D5">??</span><span style="color:#A6ACCD"> '</span><span style="color:#5DE4C7">?</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"></span></code></pre>
<p>Вот волшебство. Если мы НЕ находимся внутри строкового литерала, И мы не находим экранированный символ, И находим символ ?, тогда мы можем предположить, что это привязка запроса, которую нужно заменить фактическим значением. Мы берем наш массив значений и сдвигаем его - удаляем первый элемент в этом массиве и добавляем его значение к нашей строке запроса. (Массив значений находится в том же порядке, что и символы привязки запроса - ? - в запросе).</p>
<p>Наконец, если у нас есть обычный символ без особого значения, мы просто добавляем его к нашей строке запроса:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#A6ACCD">else { </span><span style="color:#767C9DB0;font-style:italic">// Normal character...</span></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> .=</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">char</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"></span></code></pre>
<p>Вот весь метод, таким образом, как он существует на момент написания мною этого ответа:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#5DE4C7">public</span><span style="color:#91B4D5"> function</span><span style="color:#ADD7FF"> substituteBindingsIntoRawSql</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">, $</span><span style="color:#E4F0FB">bindings</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#A6ACCD">{</span></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">bindings</span><span style="color:#91B4D5"> =</span><span style="color:#E4F0FBD0"> array_map</span><span style="color:#A6ACCD">(</span><span style="color:#91B4D5">fn</span><span style="color:#A6ACCD"> ($</span><span style="color:#E4F0FB">value</span><span style="color:#A6ACCD">) => </span><span style="color:#A6ACCD;font-style:italic">$</span><span style="color:#5DE4C7;font-style:italic">this</span><span style="color:#91B4D5">-></span><span style="color:#E4F0FBD0">escape</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">value</span><span style="color:#A6ACCD">), $</span><span style="color:#E4F0FB">bindings</span><span style="color:#A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> ''</span><span style="color:#A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">    $</span><span style="color:#E4F0FB">isStringLiteral</span><span style="color:#91B4D5"> =</span><span style="color:#5DE4C7"> false</span><span style="color:#A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">    for ($</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> =</span><span style="color:#5DE4C7"> 0</span><span style="color:#A6ACCD">; $</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> &#x3C;</span><span style="color:#E4F0FBD0"> strlen</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">); $</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5">++</span><span style="color:#A6ACCD">) {</span></span>
<span class="line"><span style="color:#A6ACCD">        $</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">[$</span><span style="color:#E4F0FB">i</span><span style="color:#A6ACCD">];</span></span>
<span class="line"><span style="color:#A6ACCD">        $</span><span style="color:#E4F0FB">nextChar</span><span style="color:#91B4D5"> =</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">sql</span><span style="color:#A6ACCD">[$</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> +</span><span style="color:#5DE4C7"> 1</span><span style="color:#A6ACCD">] </span><span style="color:#91B4D5">??</span><span style="color:#5DE4C7"> null</span><span style="color:#A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">        // Single quotes can be escaped as '' according to the SQL standard while</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">        // MySQL uses \'. Postgres has operators like ?| that must get encoded</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">        // in PHP like ??|. We should skip over the escaped characters here.</span></span>
<span class="line"><span style="color:#A6ACCD">        if (</span><span style="color:#E4F0FBD0">in_array</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5">.</span><span style="color:#A6ACCD">$</span><span style="color:#E4F0FB">nextChar</span><span style="color:#A6ACCD">, [</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">\'</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">''</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">, </span><span style="color:#A6ACCD">'</span><span style="color:#5DE4C7">??</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">])) {</span></span>
<span class="line"><span style="color:#A6ACCD">            $</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> .=</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5">.</span><span style="color:#A6ACCD">$</span><span style="color:#E4F0FB">nextChar</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">            $</span><span style="color:#E4F0FB">i</span><span style="color:#91B4D5"> +=</span><span style="color:#5DE4C7"> 1</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">        } elseif ($</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5"> ===</span><span style="color:#A6ACCD"> "</span><span style="color:#5DE4C7">'</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">) { </span><span style="color:#767C9DB0;font-style:italic">// Starting / leaving string literal...</span></span>
<span class="line"><span style="color:#A6ACCD">            $</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> .=</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">char</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">            $</span><span style="color:#E4F0FB">isStringLiteral</span><span style="color:#91B4D5"> =</span><span style="color:#91B4D5"> !</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">isStringLiteral</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">        } elseif ($</span><span style="color:#E4F0FB">char</span><span style="color:#91B4D5"> ===</span><span style="color:#A6ACCD"> '</span><span style="color:#5DE4C7">?</span><span style="color:#A6ACCD">'</span><span style="color:#91B4D5"> &#x26;&#x26;</span><span style="color:#91B4D5"> !</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">isStringLiteral</span><span style="color:#A6ACCD">) { </span><span style="color:#767C9DB0;font-style:italic">// Substitutable binding...</span></span>
<span class="line"><span style="color:#A6ACCD">            $</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> .=</span><span style="color:#E4F0FBD0"> array_shift</span><span style="color:#A6ACCD">($</span><span style="color:#E4F0FB">bindings</span><span style="color:#A6ACCD">) </span><span style="color:#91B4D5">??</span><span style="color:#A6ACCD"> '</span><span style="color:#5DE4C7">?</span><span style="color:#A6ACCD">'</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">        } else { </span><span style="color:#767C9DB0;font-style:italic">// Normal character...</span></span>
<span class="line"><span style="color:#A6ACCD">            $</span><span style="color:#E4F0FB">query</span><span style="color:#91B4D5"> .=</span><span style="color:#A6ACCD"> $</span><span style="color:#E4F0FB">char</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">        }</span></span>
<span class="line"><span style="color:#A6ACCD">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">    return $</span><span style="color:#E4F0FB">query</span><span style="color:#A6ACCD">;</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"></span></code></pre>
<p>Это, в общем, все, что касается этой истории. Мы хотим, чтобы весь запрос был доступен с нашими значениями! Есть некоторые (незначительные) ограничения, которые мы должны учесть, чтобы использовать эту функцию:</p>
<ul>
<li>Нам необходимо установить соединение с базой данных (благодаря использованию библиотеки PDO для безопасного экранирования значений).</li>
<li>Вышеуказанный код МОЖЕТ содержать случайные ошибки в зависимости от используемых значений.</li>
<li>Очень длинные значения в запросе, например, бинарные данные, могут привести к полному беспорядку в строке запроса.</li>
</ul>
<p>Эти компромиссы мне кажутся приемлемыми!</p> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/proverka-torawsql" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/proverka-torawsql" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Проверка toRawSql&url=https://igorlov.ru/blog/proverka-torawsql" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&url=https://igorlov.ru/blog/proverka-torawsql&title=Проверка toRawSql&summary=В недавнем прошлом мы могли выгружать SQL, который генерировал наш построитель запросов, следующим образом:
&source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/proverka-torawsql&media=&description=В недавнем прошлом мы могли выгружать SQL, который генерировал наш построитель запросов, следующим образом:
" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <nav class="circular-pagination" aria-label="Circular Pagination" data-astro-cid-ihkjvfsn> <a href="/blog/luchshie-instrumenty-ci-cd-dlya-react-native" class="circular-pagination__link circular-pagination__link--prev" data-astro-cid-ihkjvfsn> Лучшие инструменты CI/CD для React Native </a> <a href="/blog/integraciya-steka-elastic-stack-elk-v-prilozhenie-laravel" class="circular-pagination__link circular-pagination__link--next" data-astro-cid-ihkjvfsn> Интеграция стека Elastic Stack (ELK) в приложение Laravel </a> </nav>  </div> </div> </article> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="Z1T5Wnr" prefix="r0" component-url="/_astro/YandexRelatedAds.D-6fTqBY.js" component-export="default" renderer-url="/_astro/client.Bd2Qst3j.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;YandexRelatedAds&quot;,&quot;value&quot;:true}" await-children=""><div id="yandex_rtb_C-A-2592503-2"></div><!--astro:end--></astro-island> <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();</script><astro-island uid="Z2a8j9B" component-url="/_astro/CommentBlock.ChJFdf82.js" component-export="default" renderer-url="/_astro/client.44T8euMP.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;CommentBlock&quot;,&quot;value&quot;:true}"></astro-island>  <!-- <div class="blocks__container container">
			<CtaBlock id="cta" class=""
			/>
		</div> --> </div>    </main> <footer class="footer" data-astro-cid-dwelrhxs> <div class="footer__container container" data-astro-cid-dwelrhxs> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg footer__logo dark:hover:text-light text-blue dark:text-white" aria-label="logo" data-astro-cid-ijoll5s5> <svg width="1.44em" height="1em" viewBox="0 0 5660 3931" class="icon" data-astro-cid-ijoll5s5 data-icon="logo-one">  <use xlink:href="#ai:local:logo-one"></use>  </svg>  </a> <small class="footer__copyright" data-astro-cid-dwelrhxs>все права защищены. © 2024</small> </div> </footer>  </body></html>