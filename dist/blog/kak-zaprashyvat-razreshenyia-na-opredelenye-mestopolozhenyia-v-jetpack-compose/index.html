<!DOCTYPE html><html lang="ru"> <head><title>Как запрашивать разрешения на определение местоположения в Jetpack Compose - Фул Фронт Дев</title><link rel="canonical" href="https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose"><meta name="description" content="Получение данных о местоположении пользователя может быть довольно сложным делом. За прошедшие годы разрешения, необходимые для этого, и логика, связанная с эт"><meta name="robots" content="index, follow"><!-- favicon --><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><!-- theme meta --><meta name="theme-name" content="igorlov.ru"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="generator" content="Astro v4.5.1"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- responsive meta --><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><meta name="google-adsense-account" content="ca-pub-0634695143666394"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ViewTransitions.astro_astro_type_script_index_0_lang.DqfSmqP7.js"></script><link rel="stylesheet" href="/_astro/_regular_.Dd2YhbvP.css" />
<style>.breadcrumbs[data-astro-cid-vcbh62el]{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity));border-radius:min(1.5rem,1.1625rem + .45vw);padding-left:min(2rem,1.2125rem + 1.05vw);padding-right:min(2rem,1.2125rem + 1.05vw);padding-top:1rem;padding-bottom:1rem}.breadcrumbs[data-astro-cid-vcbh62el]:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}.breadcrumbs__list[data-astro-cid-vcbh62el]{display:flex;align-items:center;gap:.125rem}.breadcrumbs__link[data-astro-cid-vcbh62el]{border-radius:9999px;--tw-bg-opacity: 1;background-color:#fef9f8;background-color:rgba(254,249,248,var(--tw-bg-opacity));font-weight:500;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.breadcrumbs__link[data-astro-cid-vcbh62el]:hover{--tw-bg-opacity: 1;background-color:#fce4e1;background-color:rgba(252,228,225,var(--tw-bg-opacity))}.breadcrumbs__link[data-astro-cid-vcbh62el]{padding:.125rem .75rem}.breadcrumbs__link[data-astro-cid-vcbh62el]:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#6a6a6a;background-color:rgba(106,106,106,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}.breadcrumbs__link[data-astro-cid-vcbh62el]:hover:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#8a8a93;background-color:rgba(138,138,147,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}
</style>
<link rel="stylesheet" href="/_astro/_single_.CyWP_2Jq.css" />
<style>.circular-pagination[data-astro-cid-ihkjvfsn]{display:flex;width:100%;flex-wrap:wrap;align-items:center;justify-content:center;overflow:hidden;border-top-width:1px;--tw-border-opacity: 1;border-color:#020202;border-color:rgba(2,2,2,var(--tw-border-opacity));margin-top:min(1.25rem,1.1375rem + .15vw)}.circular-pagination__link[data-astro-cid-ihkjvfsn]{width:100%;--tw-bg-opacity: 1;background-color:#fef9f8;background-color:rgba(254,249,248,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity));text-decoration-line:none}.circular-pagination__link[data-astro-cid-ihkjvfsn]:hover{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.circular-pagination__link[data-astro-cid-ihkjvfsn]{padding-left:min(1.5rem,1.1625rem + .45vw);padding-right:min(1.5rem,1.1625rem + .45vw);padding-top:.5rem;padding-bottom:.5rem}
.comments[data-v-533071ec]{margin:auto;margin-top:1.25rem;max-width:42rem;--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity))}.comments:where([class=dark][data-v-533071ec],[class=dark] *[data-v-533071ec]){--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity))}.giscus-frame[data-v-533071ec]{width:100%;--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity))}.giscus-frame:where([class=dark][data-v-533071ec],[class=dark] *[data-v-533071ec]){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity))}
.theme-toggle[data-v-8d8d9c54]{width:1.25rem;height:1.25rem}
</style><script type="module" src="/_astro/page.CFW0rSNk.js"></script><style>[data-astro-transition-scope="astro-vgmtzcrq-1"] { view-transition-name: blog-image-kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose; }</style></head> <body class="flex min-h-screen flex-col bg-gray-light pt-14 font-inter text-white fluid:text-lg dark:bg-black"> <header class="header" data-astro-cid-rq644orq> <div class="header__container container" data-astro-cid-rq644orq> <a href="/" class="logo font-extrabold lowercase transition-colors fluid:text-lg header__logo dark:hover:text-light text-dark  dark:text-gray" aria-label="logo" data-astro-cid-ijoll5s5>ФCВР</a>  <div class="nav header__nav" data-astro-cid-7wkmezxd> <button class="nav__open" title="Открыть меню" data-astro-cid-7wkmezxd> <span class="nav__open-line" data-astro-cid-7wkmezxd></span> <span class="nav__open-line" data-astro-cid-7wkmezxd></span> <span class="nav__open-line" data-astro-cid-7wkmezxd></span> </button> <nav class="nav__container" data-astro-cid-7wkmezxd> <button class="nav__close" title="Закрыть меню" data-astro-cid-7wkmezxd> <span class="nav__close-line" data-astro-cid-7wkmezxd></span> <span class="nav__close-line" data-astro-cid-7wkmezxd></span> <span class="nav__close-line" data-astro-cid-7wkmezxd></span> </button> <ul class="nav__list" data-astro-cid-7wkmezxd> <li class="nav__item" data-astro-cid-7wkmezxd> <a href="/projects" class="nav__link" data-astro-cid-7wkmezxd> Работы. </a> </li><li class="nav__item" data-astro-cid-7wkmezxd> <a href="/blog" class="nav__link nav__link--active" data-astro-cid-7wkmezxd> Блог. </a> </li><li class="nav__item" data-astro-cid-7wkmezxd> <a href="#cta" class="nav__link" data-astro-cid-7wkmezxd> Контакты. </a> </li> </ul> </nav> </div>  <script type="module">document.addEventListener("astro:page-load",()=>{const t=document.querySelector(".nav__open"),n=document.querySelector(".nav__close"),e=document.querySelector(".nav__container"),o=document.querySelectorAll(".nav__item");t?.addEventListener("click",()=>{e?.classList.toggle("nav__container--open"),e?.classList.toggle("fade-in-bottom")}),n?.addEventListener("click",()=>{e?.classList.toggle("nav__container--open"),e?.classList.toggle("fade-in-bottom")}),o.forEach(a=>{window.matchMedia("( max-width: 1024px)").matches&&a.addEventListener("click",()=>{e?.classList.toggle("nav__container--open"),e?.classList.toggle("fade-in-bottom")})})});</script> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();;(()=>{var v=Object.defineProperty;var A=(c,s,a)=>s in c?v(c,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):c[s]=a;var d=(c,s,a)=>(A(c,typeof s!="symbol"?s+"":s,a),a);var u;{let c={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},s=t=>{let[e,n]=t;return e in c?c[e](n):void 0},a=t=>t.map(s),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,s(n)]));customElements.get("astro-island")||customElements.define("astro-island",(u=class extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var f;if(!this.hydrator||!this.isConnected)return;let e=(f=this.parentElement)==null?void 0:f.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),r={},l=this.querySelectorAll("template[data-astro-template]");for(let o of l){let i=o.closest(this.tagName);i!=null&&i.isSameNode(this)&&(r[o.getAttribute("data-astro-template")||"default"]=o.innerHTML,o.remove())}for(let o of n){let i=o.closest(this.tagName);i!=null&&i.isSameNode(this)&&(r[o.getAttribute("name")||"default"]=o.innerHTML)}let h;try{h=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(o){let i=this.getAttribute("component-url")||"<unknown>",b=this.getAttribute("component-export");throw b&&(i+=` (export ${b})`),console.error(`[hydrate] Error parsing props for component ${i}`,this.getAttribute("props"),o),o}let p;await this.hydrator(this)(this.Component,h,r,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),n.disconnect(),this.childrenConnectedCallback()},n=new MutationObserver(()=>{var r;((r=this.lastChild)==null?void 0:r.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});n.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}try{await Astro[n](async()=>{let r=this.getAttribute("renderer-url"),[l,{default:h}]=await Promise.all([import(this.getAttribute("component-url")),r?import(r):()=>()=>{}]),p=this.getAttribute("component-export")||"default";if(!p.includes("."))this.Component=l[p];else{this.Component=l;for(let y of p.split("."))this.Component=this.Component[y]}return this.hydrator=h,this.hydrate},e,this)}catch(r){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,r)}}attributeChangedCallback(){this.hydrate()}},d(u,"observedAttributes",["props"]),u))}})();</script><astro-island uid="IJ3dh" component-url="/_astro/ThemeToggle.kpN4JrWQ.js" component-export="default" renderer-url="/_astro/client.DtEXyQF-.js" props="{&quot;data-astro-cid-rq644orq&quot;:[0,true]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;ThemeToggle&quot;,&quot;value&quot;:true}"></astro-island> </div> </header>  <main id="main-content" class="main flex-1">  <div class="blocks"> <div class="blocks__container container"> <nav aria-label="Breadcrumbs" class="breadcrumbs" data-astro-cid-vcbh62el> <ol class="breadcrumbs__list" role="list" data-astro-cid-vcbh62el> <li class="breadcrumbs__item" role="listitem" data-astro-cid-vcbh62el> <a class="breadcrumbs__link" href="/" data-astro-cid-vcbh62el> Главная </a> </li><li class="breadcrumbs__item" role="listitem" data-astro-cid-vcbh62el> <a class="breadcrumbs__link" href="/blog" data-astro-cid-vcbh62el> Blog </a> </li><li class="breadcrumbs__item" role="listitem" data-astro-cid-vcbh62el>  </li> </ol> </nav>  </div> <div class="blocks__container container"> <!-- <TextAds class="fade-in-bottom fluid:my-2" style="--delay: .8s;" /> --><article class="article" data-astro-cid-axzg2cw6> <div class="article__header" data-astro-cid-axzg2cw6> <ul class="article__categories categories" data-astro-cid-axzg2cw6> <li class="categories__item" data-astro-cid-axzg2cw6> <a href="/category/учебник" class="categories__link" data-astro-cid-axzg2cw6> Учебник  </a> </li> </ul> <h1 class="article__title text-wrap" data-astro-cid-axzg2cw6> Как запрашивать разрешения на определение местоположения в Jetpack Compose </h1> <ul class="article__tags tags" data-astro-cid-axzg2cw6> <li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/jetpack-compose" data-astro-cid-axzg2cw6> Jetpack Compose </a> </li> </ul> <time class="article__date" data-astro-cid-axzg2cw6>
Опубликовано 12 дек., 2023 by Igor Gorlov </time> <time class="article__date" data-astro-cid-axzg2cw6> Последнее изменение: 21 мар., 2024 </time> </div>  <figure class="article__image" data-astro-cid-axzg2cw6> <picture> <source srcset="/_astro/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose-Dec-12-2023.Dvj_dGAj_Z2fbKl8.avif" type="image/avif"><source srcset="/_astro/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose-Dec-12-2023.Dvj_dGAj_2f4b2F.webp" type="image/webp"> <img src="/_astro/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose-Dec-12-2023.Dvj_dGAj_Z123dFG.png" alt="Как запрашивать разрешения на определение местоположения в Jetpack Compose" class="aspect-auto h-full w-full object-cover object-center" loading="eager" data-astro-cid-axzg2cw6 data-astro-transition-scope="astro-vgmtzcrq-1" width="1200" height="500" decoding="async"> </picture> </figure>  <div class="article__content prose prose-zinc max-w-full dark:prose-invert prose-p:text-balance prose-a:no-underline hover:prose-a:underline prose-figure:-mx-12 prose-figure:w-screen prose-figure:bg-gray-light prose-figure:p-10 prose-figcaption:text-dark dark:prose-figure:bg-dark dark:prose-figcaption:text-white" data-astro-cid-axzg2cw6> <div id="adfox_17062261612859555"></div> <script>(function(){const blockId = "adfox_17062261612859555";

	window.yaContextCb = window.yaContextCb || [];
	window.yaContextCb.push(() => {
		Ya.adfoxCode.createAdaptive(
			{
				ownerId: 1493338,
				containerId: blockId,
				params: {
					p1: 'dawgg',
					p2: 'p',
				},
			},
			['desktop', 'tablet', 'phone'],
			{
				tabletWidth: 830,
				phoneWidth: 480,
				isAutoReloads: true,
			},
		);
	});
})();</script> <div class="article__meta" data-astro-cid-axzg2cw6> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Как запрашивать разрешения на определение местоположения в Jetpack Compose&#38;url=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&#38;url=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose&#38;title=Как запрашивать разрешения на определение местоположения в Jetpack Compose&#38;summary=Получение данных о местоположении пользователя может быть довольно сложным делом. За прошедшие годы разрешения, необходимые для этого, и логика, связанная с эт&#38;source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose&#38;media=&#38;description=Получение данных о местоположении пользователя может быть довольно сложным делом. За прошедшие годы разрешения, необходимые для этого, и логика, связанная с эт" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <a class="article__meta-section" href="#comments" data-astro-cid-axzg2cw6> Комментарии</a> </div> <details class="toc px-5 border border-gray-light lg:px-10 py-2 cursor-pointer"><summary class="title">Оглавление</summary><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#save-our-souls-sos">Save Our Souls (S.O.S.)</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#объяснение-обоснования">Объяснение обоснования</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#наблюдатель-жизненного-цикла">Наблюдатель жизненного цикла</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#местоположение-не-найдено">Местоположение не найдено</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#местоположение-подтверждено">Местоположение подтверждено</a></li></ol></details><p>Получение данных о местоположении пользователя может быть довольно сложным делом. За прошедшие годы разрешения, необходимые для этого, и логика, связанная с этим, претерпели значительные изменения.</p>
<p>Если ваше приложение зависит от получения информации о местоположении пользователя, вы хотите обеспечить ему приятные ощущения, когда приложение запрашивает эту информацию. Поэтому очень важно учесть все возможные варианты и позволить пользователю выбрать тот вариант, который ему наиболее удобен.</p>
<p>В Jetpack Compose логика, связанная с получением информации о местоположении пользователя, немного изменилась, и важно знать, как это делается.</p>
<p>Как и в большинстве случаев, для получения разрешений можно использовать библиотеку. Она от Accompanist (читайте Google), и вы можете найти ее <a href="https://google.github.io/accompanist/permissions/#:~:text=A%20library%20which%20provides%20Android%20runtime%20permissions%20support%20for%20Jetpack%20Compose.&#x26;text=The%20permission%20APIs%20are%20currently,marked%20with%20the%20%40ExperimentalPermissionsApi%20annotation." rel="noopener noreferrer nofollow" target="_blank">здесь</a>. *<strong>*Но вы ведь здесь для того, чтобы научиться делать все самостоятельно,</strong> верно?** Так что читайте дальше. 🕵️‍♀️</p>
<p>Прежде чем мы перейдем к коду и логике, важно понять, что запрос разрешения у пользователя - это путь, который может иметь множество точек принятия решения. Поэтому его лучше всего описывать с помощью состояний, которые представляют текущий статус разрешения (одобрено/отклонено/запрещено) и текущий статус операционной системы.</p>
<p>Приведенная ниже диаграмма иллюстрирует этот поток:</p>
<figure class="igorlov-figure"><img src="https://www.freecodecamp.org/news/content/images/2023/10/location.png" alt="location"><figcaption>location</figcaption></figure>
<p>Позже в этой статье вы увидите, как мы будем представлять эти состояния в переменных в нашем коде.</p>
<h2 id="save-our-souls-sos">Save Our Souls (S.O.S.)<a aria-hidden="true" tabindex="-1" href="#save-our-souls-sos"><span class="icon icon-link"></span></a></h2>
<p>Прежде чем мы перейдем к логике запроса разрешения, мы позаботимся о том, как его оформить. Как обычно, добавьте необходимые разрешения в файл AndroidManifest.xml:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#E4F0FB">&#x3C;</span><span style="color:#5DE4C7">uses-permission</span><span style="color:#91B4D5;font-style:italic"> android</span><span style="color:#A6ACCD;font-style:italic">:</span><span style="color:#91B4D5;font-style:italic">name</span><span style="color:#E4F0FB">=</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">android.permission.ACCESS_COARSE_LOCATION</span><span style="color:#A6ACCD">"</span><span style="color:#E4F0FB"> /></span></span>
<span class="line"><span style="color:#E4F0FB">&#x3C;</span><span style="color:#5DE4C7">uses-permission</span><span style="color:#91B4D5;font-style:italic"> android</span><span style="color:#A6ACCD;font-style:italic">:</span><span style="color:#91B4D5;font-style:italic">name</span><span style="color:#E4F0FB">=</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">android.permission.ACCESS_FINE_LOCATION</span><span style="color:#A6ACCD">"</span><span style="color:#E4F0FB"> /></span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>Затем мы создадим композитный экран, на котором будем запрашивать необходимые разрешения на местоположение. Первым шагом в этом экране будет проверка того, предоставлял ли пользователь ранее необходимые разрешения. Это можно сделать с помощью метода checkSelfPermission, который не является чем-то новым для Jetpack Compose:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#A6ACCD">val locationPermissionsAlreadyGranted </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> ContextCompat</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">checkSelfPermission</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#5DE4C7;font-style:italic">            this</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#E4F0FB">            Manifest</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">permission</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACCESS_FINE_LOCATION</span><span style="color:#A6ACCD">) </span><span style="color:#91B4D5">==</span><span style="color:#E4F0FB"> PackageManager</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">PERMISSION_GRANTED</span></span>
<span class="line"></span></code></pre>
<p>Если разрешение не предоставлено, мы должны запросить его. Для этого мы будем использовать объект <a href="https://developer.android.com/reference/kotlin/androidx/activity/compose/package-summary#rememberlauncherforactivityresult" rel="noopener noreferrer nofollow" target="_blank">rememberLauncherForActivityResult</a>. Это позволит нам в Jetpack Compose получить результат от активности.</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#A6ACCD">val locationPermissions </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FBD0"> arrayOf</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#E4F0FB">Manifest</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">permission</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACCESS_FINE_LOCATION</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#E4F0FB">Manifest</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">permission</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACCESS_COARSE_LOCATION</span><span style="color:#A6ACCD">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">val locationPermissionLauncher </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FBD0"> rememberLauncherForActivityResult</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#A6ACCD">contract </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> ActivityResultContracts</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">RequestMultiplePermissions</span><span style="color:#A6ACCD">(),</span></span>
<span class="line"><span style="color:#A6ACCD">onResult </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> { permissions </span><span style="color:#91B4D5">-></span></span>
<span class="line"><span style="color:#A6ACCD">val permissionsGranted </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> permissions</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">values</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">reduce</span><span style="color:#A6ACCD"> { acc, isPermissionGranted </span><span style="color:#91B4D5">-></span></span>
<span class="line"><span style="color:#A6ACCD">acc </span><span style="color:#91B4D5">&#x26;&#x26;</span><span style="color:#A6ACCD"> isPermissionGranted</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">                    if (</span><span style="color:#91B4D5">!</span><span style="color:#A6ACCD">permissionsGranted) {</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">                       //Логика, когда разрешения не были предоставлены пользователем</span></span>
<span class="line"><span style="color:#A6ACCD">                    }</span></span>
<span class="line"><span style="color:#A6ACCD">                })</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>Аргументы, которые нам нужно передать в <code>rememberLauncherForActivityResult</code>, следующие:</p>
<ol>
<li><a href="https://developer.android.com/reference/androidx/activity/result/contract/ActivityResultContract" rel="noopener noreferrer nofollow" target="_blank">ActivityResultContract</a> - определяет вход активности и выход.</li>
<li>onResult - обратный вызов при получении результата</li>
</ol>
<p>В приведенном выше фрагменте кода мы используем контракт с несколькими разрешениями, поскольку запрашиваем несколько разрешений на местоположение. Существует также контракт для запроса только одного разрешения, <strong>ActivityResultContracts.RequestPermission().</strong>.</p>
<p>Этот фрагмент кода не запускается сразу, поскольку нам нужно запросить разрешения. Для этого мы используем метод launch, чтобы запустить активность:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#E4F0FB">locationPermissionLauncher</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">launch</span><span style="color:#A6ACCD">(locationPermissions)</span></span>
<span class="line"></span></code></pre>
<p>В случае если пользователь предоставил все или несколько необходимых разрешений, мы можем продолжить логику работы приложения.</p>
<p>Но если пользователь не одобрил ни одно из разрешений, нам нужно найти способ объяснить ему, почему эти разрешения необходимы.</p>
<h2 id="объяснение-обоснования">Объяснение обоснования<a aria-hidden="true" tabindex="-1" href="#объяснение-обоснования"><span class="icon icon-link"></span></a></h2>
<p>Если пользователь отклонил разрешение, но не выбрал опцию ”Отказать и больше не спрашивать”, у нас есть способ дать пользователю краткое объяснение, почему он должен предоставить требуемое разрешение (разрешения).</p>
<p>Чтобы выяснить, нужно ли предоставлять это обоснование, мы используем параметр <a href="https://developer.android.com/reference/androidx/core/app/ActivityCompat#shouldShowRequestPermissionRationale(android.app.Activity,java.lang.String)" rel="noopener noreferrer nofollow" target="_blank">shouldShowRequestPermissionRationale</a> из класса Activity:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#A6ACCD">val shouldShowPermissionRationale: Boolean </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FBD0"> shouldShowRequestPermissionRationale</span><span style="color:#A6ACCD">(</span><span style="color:#E4F0FB">Manifest</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">permission</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACCESS_COARSE_LOCATION</span><span style="color:#A6ACCD">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>Как только мы узнаем, что мы можем отобразить это объяснение, есть два способа сделать это:</p>
<ol>
<li>Мы можем представить его пользователю с помощью AlertDialog</li>
<li>Мы можем использовать панель закусок</li>
</ol>
<p>Представить диалог оповещения довольно просто. Все, что нам нужно сделать, это четко описать пользователю, почему необходимо одобрить это разрешение:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#A6ACCD">@</span><span style="color:#91B4D5">Composable</span></span>
<span class="line"><span style="color:#A6ACCD">    fun </span><span style="color:#E4F0FBD0">ShowLocationPermissionRationale</span><span style="color:#A6ACCD">() {</span></span>
<span class="line"><span style="color:#E4F0FBD0">        AlertDialog</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#A6ACCD">            onDismissRequest </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">               //Логика, когда происходит увольнение</span></span>
<span class="line"><span style="color:#A6ACCD">            },</span></span>
<span class="line"><span style="color:#A6ACCD">        title </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#E4F0FBD0">            Text</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">Требуется разрешение</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#A6ACCD">                },</span></span>
<span class="line"><span style="color:#A6ACCD">        text </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#E4F0FBD0">            Text</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">Вам необходимо одобрить это разрешение, чтобы...</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#A6ACCD">        },</span></span>
<span class="line"><span style="color:#A6ACCD">        confirmButton </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#E4F0FBD0">            TextButton</span><span style="color:#A6ACCD">(onClick </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">              // Логика, когда пользователь подтверждает принятие разрешения</span></span>
<span class="line"><span style="color:#A6ACCD">            }) {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                Text</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">Confirm</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#A6ACCD">            }</span></span>
<span class="line"><span style="color:#A6ACCD">        },</span></span>
<span class="line"><span style="color:#A6ACCD">        dismissButton </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#E4F0FBD0">            TextButton</span><span style="color:#A6ACCD">(onClick </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">              //Логика, когда пользователь отказывается принимать разрешения</span></span>
<span class="line"><span style="color:#A6ACCD">            }) {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                Text</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">Deny</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#A6ACCD">            }</span></span>
<span class="line"><span style="color:#A6ACCD">        })</span></span>
<span class="line"><span style="color:#A6ACCD">    }</span></span>
<span class="line"></span></code></pre>
<p>Если мы хотим отобразить закусочную, нам нужно знать, что мы должны использовать контейнер Scaffold, поскольку это единственный контейнер, который поддерживает отображение закусочной. Если мы его не используем, то закусочная не появится.</p>
<p>Ниже приведен фрагмент, показывающий, как это сделать:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#A6ACCD">val scope </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FBD0"> rememberCoroutineScope</span><span style="color:#A6ACCD">()</span></span>
<span class="line"><span style="color:#A6ACCD">val snackbarHostState </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> remember { </span><span style="color:#E4F0FBD0">SnackbarHostState</span><span style="color:#A6ACCD">() }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E4F0FBD0">Scaffold</span><span style="color:#A6ACCD">(snackbarHost </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#E4F0FBD0">SnackbarHost</span><span style="color:#A6ACCD">(hostState </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> snackbarHostState)</span></span>
<span class="line"><span style="color:#A6ACCD">}) { contentPadding </span><span style="color:#91B4D5">-></span></span>
<span class="line"><span style="color:#A6ACCD">if (shouldShowPermissionRationale) {</span></span>
<span class="line"><span style="color:#E4F0FBD0">LaunchedEffect</span><span style="color:#A6ACCD">(key1 </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> shouldShowPermissionRationale, block </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#E4F0FB">scope</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">launch</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#A6ACCD">val userAction </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> snackbarHostState</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">showSnackbar</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#A6ACCD">message </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> "</span><span style="color:#5DE4C7">Пожалуйста, авторизуйте разрешения на местоположение</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">actionLabel </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> "</span><span style="color:#5DE4C7">Одобрить</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">duration </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> SnackbarDuration</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Indefinite</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">withDismissAction </span><span style="color:#91B4D5">=</span><span style="color:#5DE4C7"> true</span></span>
<span class="line"><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#E4F0FBD0">when</span><span style="color:#A6ACCD"> (userAction) {</span></span>
<span class="line"><span style="color:#E4F0FB">SnackbarResult</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ActionPerformed</span><span style="color:#91B4D5"> -></span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">//Пользователь одобрил предоставление разрешения</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">//Запросить разрешения снова</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"><span style="color:#E4F0FB">SnackbarResult</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Dismissed</span><span style="color:#91B4D5"> -></span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#767C9DB0;font-style:italic">//Пользователь отклонил закусочную</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"><span style="color:#A6ACCD">})</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>С помощью атрибута withDismissAction мы разрешили отменять саму панель закусок и прослушали действие, выполняемое пользователем.</p>
<h2 id="наблюдатель-жизненного-цикла">Наблюдатель жизненного цикла<a aria-hidden="true" tabindex="-1" href="#наблюдатель-жизненного-цикла"><span class="icon icon-link"></span></a></h2>
<p>Мы упустили из виду тот факт, что нам необходимо убедиться в том, что наш запрос разрешения соответствует композитному жизненному циклу. Это означает, что как только пользователь выберет свои предпочтения относительно запроса разрешения, нам нужно, чтобы пользовательский интерфейс адаптировался соответствующим образом.</p>
<p>Если вы попробуете поместить приведенный выше код в метод onCreate активности, вы будете удивлены результатом, поскольку приложение завершится со следующим исключением:</p>
<blockquote>
<p><strong>java.lang.IllegalStateException: Launcher has not been initialized</strong></p>
</blockquote>
<p>Это происходит потому, что Composable-функции должны быть свободны от побочных эффектов. Что такое побочный эффект? Согласно <a href="https://developer.android.com/jetpack/compose/side-effects" rel="noopener noreferrer nofollow" target="_blank">документации Google</a>, это:</p>
<blockquote>
<p>… изменение состояния приложения, которое происходит вне области действия составной функции.</p>
</blockquote>
<p>Таким образом, в нашем примере побочным эффектом является запуск активности для разрешений.</p>
<p>Чтобы обойти этот сценарий, нам нужно использовать одну из опций побочного эффекта. Поскольку мы не хотим спрашивать пользователя о разрешениях, не помня, что он выбрал ранее, мы не можем использовать общий *<strong>*SideEffect**</strong>. А *<strong>*LaunchedEffect**</strong> используется для вызова методов приостановки внутри Composable, что не является нашим случаем использования.</p>
<p>Таким образом, у нас остается *<strong>*DisposableEffect**</strong>. Читая <a href="https://developer.android.com/jetpack/compose/side-effects#disposableeffect" rel="noopener noreferrer nofollow" target="_blank">документацию</a>, мы видим, что <a href="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary#DisposableEffect(kotlin.Any,kotlin.Function1)" rel="noopener noreferrer nofollow" target="_blank">DisposableEffect</a> может быть объединен с событиями жизненного цикла, что нам и нужно.</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#A6ACCD">val lifecycleOwner </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> LocalLifecycleOwner</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">current</span></span>
<span class="line"><span style="color:#E4F0FBD0">            DisposableEffect</span><span style="color:#A6ACCD">(key1 </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> lifecycleOwner, effect </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#A6ACCD">                val observer </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> LifecycleEventObserver { _, event </span><span style="color:#91B4D5">-></span></span>
<span class="line"><span style="color:#A6ACCD">                    if (event </span><span style="color:#91B4D5">==</span><span style="color:#E4F0FB"> Lifecycle</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Event</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ON_START</span><span style="color:#91B4D5"> &#x26;&#x26;</span><span style="color:#91B4D5"> !</span><span style="color:#A6ACCD">locationPermissionsAlreadyGranted) {</span></span>
<span class="line"><span style="color:#E4F0FB">                        locationPermissionLauncher</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">launch</span><span style="color:#A6ACCD">(locationPermissions)</span></span>
<span class="line"><span style="color:#A6ACCD">                       }</span></span>
<span class="line"><span style="color:#A6ACCD">                    }</span></span>
<span class="line"><span style="color:#E4F0FB">                    lifecycleOwner</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">lifecycle</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">addObserver</span><span style="color:#A6ACCD">(observer)</span></span>
<span class="line"><span style="color:#A6ACCD">                    onDispose {</span></span>
<span class="line"><span style="color:#E4F0FB">                        lifecycleOwner</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">lifecycle</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">removeObserver</span><span style="color:#A6ACCD">(observer)</span></span>
<span class="line"><span style="color:#A6ACCD">                    }</span></span>
<span class="line"><span style="color:#A6ACCD">                }</span></span>
<span class="line"><span style="color:#A6ACCD">            )</span></span>
<span class="line"></span></code></pre>
<p>В приведенном выше фрагменте кода мы добавляем наблюдатель жизненного цикла, который запускается только в случае события onStart жизненного цикла. Мы также объединяем его с булевым значением, которое мы объявили в начале этого раздела, locationPermissionsAlreadyGranted. Это нужно для того, чтобы не показывать диалог запроса разрешений, если они уже предоставлены.</p>
<p>Как и в случае со всеми наблюдателями жизненного цикла, нам нужно удалить нашего наблюдателя после завершения композиции. Эта логика находится в пункте DisposableEffect’s onDispose.</p>
<h2 id="местоположение-не-найдено">Местоположение не найдено<a aria-hidden="true" tabindex="-1" href="#местоположение-не-найдено"><span class="icon icon-link"></span></a></h2>
<p>Последний случай, с которым нам нужно разобраться, - это когда пользователь выбирает опцию ”Отказать и больше не спрашивать”. В этом случае мы не можем попросить пользователя предоставить необходимые разрешения.</p>
<p>Единственный способ, которым пользователь может отменить свой выбор, - это перейти на экран настроек нашего приложения и изменить разрешения там. Поэтому нам нужно направить пользователя туда.</p>
<p>Чтобы открыть экран настроек нашего приложения, нам нужно использовать намерение с действием *<strong>*ACTION_APPLICATION_DETAILS_SETTINGS.**</strong></p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#E4F0FBD0">Intent</span><span style="color:#A6ACCD">(</span><span style="color:#E4F0FB">Settings</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACTION_APPLICATION_DETAILS_SETTINGS</span><span style="color:#A6ACCD">, </span><span style="color:#E4F0FB">Uri</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">fromParts</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">package</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">, packageName, </span><span style="color:#5DE4C7">null</span><span style="color:#A6ACCD">)).</span><span style="color:#E4F0FB">also</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#E4F0FBD0">startActivity</span><span style="color:#A6ACCD">(it)</span></span>
<span class="line"><span style="color:#A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>Используя приведенную выше логику, мы можем добавить ее в наш код, когда узнаем, что пользователь решил отказать в разрешениях и не запрашивать их снова. Это происходит внутри нашего запроса на получение разрешений, когда пользователь не предоставил разрешения, а опция показать обоснование равна false.</p>
<h2 id="местоположение-подтверждено">Местоположение подтверждено<a aria-hidden="true" tabindex="-1" href="#местоположение-подтверждено"><span class="icon icon-link"></span></a></h2>
<p>Если взять все, что мы обсуждали в этой статье, и поместить в один файл, мы получим следующий код:</p>
<pre class="astro-code poimandres" style="background-color:#1b1e28;color:#a6accd; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0"><code><span class="line"><span style="color:#5DE4C7">class</span><span style="color:#ADD7FF"> MainActivity</span><span style="color:#A6ACCD"> : ComponentActivity() {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">    @</span><span style="color:#91B4D5">OptIn</span><span style="color:#A6ACCD">(ExperimentalMaterial3Api::class)</span></span>
<span class="line"><span style="color:#A6ACCD">    override fun </span><span style="color:#ADD7FF">onCreate</span><span style="color:#A6ACCD">(</span><span style="color:#E4F0FB">savedInstanceState</span><span style="color:#A6ACCD">: </span><span style="color:#E4F0FB">Bundle</span><span style="color:#A6ACCD">?) {</span></span>
<span class="line"><span style="color:#ADD7FF;font-style:italic">        super</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">onCreate</span><span style="color:#A6ACCD">(savedInstanceState)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">        setContent {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">            var locationPermissionsGranted by remember { </span><span style="color:#E4F0FBD0">mutableStateOf</span><span style="color:#A6ACCD">(</span><span style="color:#E4F0FBD0">areLocationPermissionsAlreadyGranted</span><span style="color:#A6ACCD">()) }</span></span>
<span class="line"><span style="color:#A6ACCD">            var shouldShowPermissionRationale by remember {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                mutableStateOf</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#E4F0FBD0">                    shouldShowRequestPermissionRationale</span><span style="color:#A6ACCD">(</span><span style="color:#E4F0FB">Manifest</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">permission</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACCESS_COARSE_LOCATION</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#A6ACCD">                )</span></span>
<span class="line"><span style="color:#A6ACCD">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">            var shouldDirectUserToApplicationSettings by remember {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                mutableStateOf</span><span style="color:#A6ACCD">(</span><span style="color:#5DE4C7">false</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#A6ACCD">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">            var currentPermissionsStatus by remember {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                mutableStateOf</span><span style="color:#A6ACCD">(</span><span style="color:#E4F0FBD0">decideCurrentPermissionStatus</span><span style="color:#A6ACCD">(locationPermissionsGranted, shouldShowPermissionRationale))</span></span>
<span class="line"><span style="color:#A6ACCD">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">            val locationPermissions </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FBD0"> arrayOf</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#E4F0FB">                Manifest</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">permission</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACCESS_FINE_LOCATION</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#E4F0FB">                Manifest</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">permission</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACCESS_COARSE_LOCATION</span></span>
<span class="line"><span style="color:#A6ACCD">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">            val locationPermissionLauncher </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FBD0"> rememberLauncherForActivityResult</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#A6ACCD">                contract </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> ActivityResultContracts</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">RequestMultiplePermissions</span><span style="color:#A6ACCD">(),</span></span>
<span class="line"><span style="color:#A6ACCD">                onResult </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> { разрешения </span><span style="color:#91B4D5">-></span></span>
<span class="line"><span style="color:#A6ACCD">                    locationPermissionsGranted </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> permissions</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">values</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">reduce</span><span style="color:#A6ACCD"> { acc, isPermissionGranted </span><span style="color:#91B4D5">-></span></span>
<span class="line"><span style="color:#A6ACCD">                        acc </span><span style="color:#91B4D5">&#x26;&#x26;</span><span style="color:#A6ACCD"> isPermissionGranted</span></span>
<span class="line"><span style="color:#A6ACCD">                    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">                    if (</span><span style="color:#91B4D5">!</span><span style="color:#A6ACCD">locationPermissionsGranted) {</span></span>
<span class="line"><span style="color:#A6ACCD">                        shouldShowPermissionRationale </span><span style="color:#91B4D5">=</span></span>
<span class="line"><span style="color:#E4F0FBD0">                            shouldShowRequestPermissionRationale</span><span style="color:#A6ACCD">(</span><span style="color:#E4F0FB">Manifest</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">permission</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACCESS_COARSE_LOCATION</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#A6ACCD">                    }</span></span>
<span class="line"><span style="color:#A6ACCD">                    shouldDirectUserToApplicationSettings </span><span style="color:#91B4D5">=</span><span style="color:#91B4D5"> !</span><span style="color:#A6ACCD">shouldShowPermissionRationale </span><span style="color:#91B4D5">&#x26;&#x26;</span><span style="color:#91B4D5"> !</span><span style="color:#A6ACCD">locationPermissionsGranted</span></span>
<span class="line"><span style="color:#A6ACCD">                    currentPermissionsStatus </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FBD0"> decideCurrentPermissionStatus</span><span style="color:#A6ACCD">(locationPermissionsGranted, shouldShowPermissionRationale)</span></span>
<span class="line"><span style="color:#A6ACCD">                })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">            val lifecycleOwner </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> LocalLifecycleOwner</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">current</span></span>
<span class="line"><span style="color:#E4F0FBD0">            DisposableEffect</span><span style="color:#A6ACCD">(key1 </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> lifecycleOwner, effect </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#A6ACCD">                val observer </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> LifecycleEventObserver { _, event </span><span style="color:#91B4D5">-></span></span>
<span class="line"><span style="color:#A6ACCD">                    if (event </span><span style="color:#91B4D5">==</span><span style="color:#E4F0FB"> Lifecycle</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Event</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ON_START</span><span style="color:#91B4D5"> &#x26;&#x26;</span></span>
<span class="line"><span style="color:#91B4D5">                        !</span><span style="color:#A6ACCD">locationPermissionsGranted </span><span style="color:#91B4D5">&#x26;&#x26;</span></span>
<span class="line"><span style="color:#91B4D5">                        !</span><span style="color:#A6ACCD">shouldShowPermissionRationale) {</span></span>
<span class="line"><span style="color:#E4F0FB">                        locationPermissionLauncher</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">launch</span><span style="color:#A6ACCD">(locationPermissions)</span></span>
<span class="line"><span style="color:#A6ACCD">                    }</span></span>
<span class="line"><span style="color:#A6ACCD">                }</span></span>
<span class="line"><span style="color:#E4F0FB">                lifecycleOwner</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">lifecycle</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">addObserver</span><span style="color:#A6ACCD">(observer)</span></span>
<span class="line"><span style="color:#A6ACCD">                onDispose {</span></span>
<span class="line"><span style="color:#E4F0FB">                    lifecycleOwner</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">lifecycle</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">removeObserver</span><span style="color:#A6ACCD">(observer)</span></span>
<span class="line"><span style="color:#A6ACCD">                    }</span></span>
<span class="line"><span style="color:#A6ACCD">                }</span></span>
<span class="line"><span style="color:#A6ACCD">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">            val scope </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FBD0"> rememberCoroutineScope</span><span style="color:#A6ACCD">()</span></span>
<span class="line"><span style="color:#A6ACCD">            val snackbarHostState </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> remember { </span><span style="color:#E4F0FBD0">SnackbarHostState</span><span style="color:#A6ACCD">() }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD">            LocationPermissionsTheme {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                Surface</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#A6ACCD">                    modifier </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> Modifier</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">fillMaxSize</span><span style="color:#A6ACCD">(),</span></span>
<span class="line"><span style="color:#A6ACCD">                    color </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> MaterialTheme</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">colorScheme</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">background</span></span>
<span class="line"><span style="color:#A6ACCD">                ) {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                    Scaffold</span><span style="color:#A6ACCD">(snackbarHost </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                        SnackbarHost</span><span style="color:#A6ACCD">(hostState </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> snackbarHostState)</span></span>
<span class="line"><span style="color:#A6ACCD">                    }) { contentPadding </span><span style="color:#91B4D5">-></span></span>
<span class="line"><span style="color:#E4F0FBD0">                        Column</span><span style="color:#A6ACCD">(modifier </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> Modifier</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">fillMaxSize</span><span style="color:#A6ACCD">(),</span></span>
<span class="line"><span style="color:#A6ACCD">                        verticalArrangement </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> Arrangement</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Center</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">                        horizontalAlignment </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> Alignment</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">CenterHorizontally</span><span style="color:#A6ACCD">){</span></span>
<span class="line"><span style="color:#A6ACCD">                            Текст(модификатор </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> Модификатор</span></span>
<span class="line"><span style="color:#A6ACCD">                                .</span><span style="color:#E4F0FBD0">padding</span><span style="color:#A6ACCD">(contentPadding)</span></span>
<span class="line"><span style="color:#A6ACCD">                                .</span><span style="color:#E4F0FBD0">fillMaxWidth</span><span style="color:#A6ACCD">(),</span></span>
<span class="line"><span style="color:#A6ACCD">                                text </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> "</span><span style="color:#5DE4C7">Разрешения на местоположение</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">                                textAlign </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> TextAlign</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Center</span><span style="color:#A6ACCD">)</span></span>
<span class="line"><span style="color:#E4F0FBD0">                            Spacer</span><span style="color:#A6ACCD">(modifier </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> Modifier</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">padding</span><span style="color:#A6ACCD">(20.</span><span style="color:#E4F0FB">dp</span><span style="color:#A6ACCD">))</span></span>
<span class="line"><span style="color:#E4F0FBD0">                            Text</span><span style="color:#A6ACCD">(modifier </span><span style="color:#91B4D5">=</span><span style="color:#91B4D5"> Modifier</span></span>
<span class="line"><span style="color:#A6ACCD">                                .</span><span style="color:#E4F0FBD0">padding</span><span style="color:#A6ACCD">(contentPadding)</span></span>
<span class="line"><span style="color:#A6ACCD">                                .</span><span style="color:#E4F0FBD0">fillMaxWidth</span><span style="color:#A6ACCD">(),</span></span>
<span class="line"><span style="color:#A6ACCD">                                text </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> "</span><span style="color:#5DE4C7">Текущий статус разрешения: $currentPermissionsStatus</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">                                textAlign </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> TextAlign</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Center</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">                                fontWeight </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> FontWeight</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Bold</span></span>
<span class="line"><span style="color:#A6ACCD">                            )</span></span>
<span class="line"><span style="color:#A6ACCD">                        }</span></span>
<span class="line"><span style="color:#A6ACCD">                        if (shouldShowPermissionRationale) {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                            LaunchedEffect</span><span style="color:#A6ACCD">(Unit) {</span></span>
<span class="line"><span style="color:#E4F0FB">                                scope</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">launch</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#A6ACCD">                                    val userAction </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> snackbarHostState</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">showSnackbar</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#A6ACCD">                                        message </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> "</span><span style="color:#5DE4C7">Пожалуйста, авторизуйте разрешения на местоположение</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">                                        actionLabel </span><span style="color:#91B4D5">=</span><span style="color:#A6ACCD"> "</span><span style="color:#5DE4C7">Одобрить</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">                                        duration </span><span style="color:#91B4D5">=</span><span style="color:#E4F0FB"> SnackbarDuration</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Indefinite</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#A6ACCD">                                        withDismissAction </span><span style="color:#91B4D5">=</span><span style="color:#5DE4C7"> true</span></span>
<span class="line"><span style="color:#A6ACCD">                                    )</span></span>
<span class="line"><span style="color:#E4F0FBD0">                                    when</span><span style="color:#A6ACCD"> (userAction) {</span></span>
<span class="line"><span style="color:#E4F0FB">                                        SnackbarResult</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ActionPerformed</span><span style="color:#91B4D5"> -></span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#A6ACCD">                                            shouldShowPermissionRationale </span><span style="color:#91B4D5">=</span><span style="color:#5DE4C7"> false</span></span>
<span class="line"><span style="color:#E4F0FB">                                            locationPermissionLauncher</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">launch</span><span style="color:#A6ACCD">(locationPermissions)</span></span>
<span class="line"><span style="color:#A6ACCD">                                        }</span></span>
<span class="line"><span style="color:#E4F0FB">                                        SnackbarResult</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">Dismissed</span><span style="color:#91B4D5"> -></span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#A6ACCD">                                            shouldShowPermissionRationale </span><span style="color:#91B4D5">=</span><span style="color:#5DE4C7"> false</span></span>
<span class="line"><span style="color:#A6ACCD">                                        }</span></span>
<span class="line"><span style="color:#A6ACCD">                                    }</span></span>
<span class="line"><span style="color:#A6ACCD">                                }</span></span>
<span class="line"><span style="color:#A6ACCD">                            }</span></span>
<span class="line"><span style="color:#A6ACCD">                        }</span></span>
<span class="line"><span style="color:#A6ACCD">                        if (shouldDirectUserToApplicationSettings) {</span></span>
<span class="line"><span style="color:#E4F0FBD0">                            openApplicationSettings</span><span style="color:#A6ACCD">()</span></span>
<span class="line"><span style="color:#A6ACCD">                        }</span></span>
<span class="line"><span style="color:#A6ACCD">                    }</span></span>
<span class="line"><span style="color:#A6ACCD">                }</span></span>
<span class="line"><span style="color:#A6ACCD">            }</span></span>
<span class="line"><span style="color:#A6ACCD">        }</span></span>
<span class="line"><span style="color:#A6ACCD">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#5DE4C7">    private</span><span style="color:#A6ACCD"> fun </span><span style="color:#ADD7FF">areLocationPermissionsAlreadyGranted</span><span style="color:#A6ACCD">(): Boolean {</span></span>
<span class="line"><span style="color:#A6ACCD">        return </span><span style="color:#E4F0FB">ContextCompat</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">checkSelfPermission</span><span style="color:#A6ACCD">(</span></span>
<span class="line"><span style="color:#5DE4C7;font-style:italic">            this</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#E4F0FB">            Manifest</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">permission</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACCESS_FINE_LOCATION</span><span style="color:#A6ACCD">) </span><span style="color:#91B4D5">==</span><span style="color:#E4F0FB"> PackageManager</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">PERMISSION_GRANTED</span></span>
<span class="line"><span style="color:#A6ACCD">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#5DE4C7">    private</span><span style="color:#A6ACCD"> fun </span><span style="color:#ADD7FF">openApplicationSettings</span><span style="color:#A6ACCD">() {</span></span>
<span class="line"><span style="color:#E4F0FBD0">        Intent</span><span style="color:#A6ACCD">(</span><span style="color:#E4F0FB">Settings</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FB">ACTION_APPLICATION_DETAILS_SETTINGS</span><span style="color:#A6ACCD">, </span><span style="color:#E4F0FB">Uri</span><span style="color:#A6ACCD">.</span><span style="color:#E4F0FBD0">fromParts</span><span style="color:#A6ACCD">(</span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">package</span><span style="color:#A6ACCD">"</span><span style="color:#A6ACCD">, packageName, </span><span style="color:#5DE4C7">null</span><span style="color:#A6ACCD">)).</span><span style="color:#E4F0FB">also</span><span style="color:#A6ACCD"> {</span></span>
<span class="line"><span style="color:#E4F0FBD0">            startActivity</span><span style="color:#A6ACCD">(it)</span></span>
<span class="line"><span style="color:#A6ACCD">        }</span></span>
<span class="line"><span style="color:#A6ACCD">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#5DE4C7">    private</span><span style="color:#A6ACCD"> fun </span><span style="color:#ADD7FF">decideCurrentPermissionStatus</span><span style="color:#A6ACCD">(</span><span style="color:#E4F0FB">locationPermissionsGranted</span><span style="color:#A6ACCD">: </span><span style="color:#E4F0FB">Boolean</span><span style="color:#A6ACCD">,</span></span>
<span class="line"><span style="color:#E4F0FB">                                              shouldShowPermissionRationale</span><span style="color:#A6ACCD">: </span><span style="color:#E4F0FB">Boolean</span><span style="color:#A6ACCD">): String {</span></span>
<span class="line"><span style="color:#A6ACCD">        return if (locationPermissionsGranted) </span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">Granted</span><span style="color:#A6ACCD">"</span></span>
<span class="line"><span style="color:#A6ACCD">        else if (shouldShowPermissionRationale) </span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">Отклонено</span><span style="color:#A6ACCD">"</span></span>
<span class="line"><span style="color:#A6ACCD">        else </span><span style="color:#A6ACCD">"</span><span style="color:#5DE4C7">Denied</span><span style="color:#A6ACCD">"</span></span>
<span class="line"><span style="color:#A6ACCD">    }</span></span>
<span class="line"><span style="color:#91B4D5">}</span></span>
<span class="line"></span></code></pre>
<p>А вот так это выглядит:</p>
<figure class="igorlov-figure"><img src="https://www.freecodecamp.org/news/content/images/2023/10/location2.gif" alt="location2"><figcaption>location2</figcaption></figure>
<p>Я поместил всю логику в один файл только для целей этой статьи. Это далеко не самый эстетичный и правильный подход к работе с логикой запроса разрешений.</p>
<p>Вы можете легко рефакторизовать логические переменные, связанные с хранением различных состояний запроса разрешений, в классе модели представления, прикрепленном к этому экрану.</p>
<p>Вы можете увидеть весь код, описанный в этой статье, перейдя в этот проект:</p>
<p>Репозиторий, содержащий код, связанный с различными статьями Medium, которые я написал - TomerPacific/MediumArticles</p>
<p><a href="https://github.com/TomerPacific/MediumArticles/tree/master/LocationPermissions" rel="noopener noreferrer nofollow" target="_blank">https://github.com/TomerPacific/MediumArticles/tree/master/LocationPermissions</a></p>
<p>А если вы хотите прочитать другие мои статьи, вы можете просмотреть их ниже:</p>
<p>GitHub - TomerPacific/MediumArticles: Репозиторий, содержащий код, связанный с различными статьями на Medium, которые я написал</p>
<p>Репозиторий, содержащий код, связанный с различными статьями Medium, которые я написал - GitHub - TomerPacific/MediumArticles: Репозиторий, содержащий код, связанный с различными статьями Medium…</p>
<p><a href="https://github.com/TomerPacific/MediumArticles" rel="noopener noreferrer nofollow" target="_blank">https://github.com/TomerPacific/MediumArticles</a></p>
<p>Я также использовал эту логику в приложении, которое выможно попробовать <a href="https://play.google.com/store/apps/details?id=com.tomerpacific.scheduler" rel="noopener noreferrer nofollow" target="_blank">здесь</a>.</p>
<p>Спасибо, что читаете!</p> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Как запрашивать разрешения на определение местоположения в Jetpack Compose&#38;url=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&#38;url=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose&#38;title=Как запрашивать разрешения на определение местоположения в Jetpack Compose&#38;summary=Получение данных о местоположении пользователя может быть довольно сложным делом. За прошедшие годы разрешения, необходимые для этого, и логика, связанная с эт&#38;source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/kak-zaprashyvat-razreshenyia-na-opredelenye-mestopolozhenyia-v-jetpack-compose&#38;media=&#38;description=Получение данных о местоположении пользователя может быть довольно сложным делом. За прошедшие годы разрешения, необходимые для этого, и логика, связанная с эт" target="_blank" rel="noreferrer noopener" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <nav class="circular-pagination" aria-label="Circular Pagination" data-astro-cid-ihkjvfsn> <a href="/blog/kak-yspolzovat-url-adresa-dlia-upravlenyia-sostoianyiamy-v-react" class="circular-pagination__link circular-pagination__link--prev" data-astro-cid-ihkjvfsn> Как использовать URL-адреса для управления состояниями в React </a> <a href="/blog/kak-v-rovniat-tekst-po-tsentru-v-css" class="circular-pagination__link circular-pagination__link--next" data-astro-cid-ihkjvfsn> Как выровнять текст по центру в CSS </a> </nav>  </div> </article> <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="Z1T5Wnr" prefix="r0" component-url="/_astro/YandexRelatedAds.svLg6TOn.js" component-export="default" renderer-url="/_astro/client.D9Vng9vH.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;YandexRelatedAds&quot;,&quot;value&quot;:true}" await-children=""><div id="yandex_rtb_C-A-2592503-2"></div><!--astro:end--></astro-island> <astro-island uid="Z2a8j9B" component-url="/_astro/CommentBlock.BwogX8bT.js" component-export="default" renderer-url="/_astro/client.DtEXyQF-.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;CommentBlock&quot;,&quot;value&quot;:true}"></astro-island>  </div> <!-- <div class="blocks__container container">
			<CtaBlock id="cta" class=""
			/>
		</div> --> </div>    </main> <footer class="footer" data-astro-cid-dwelrhxs> <div class="footer__container container" data-astro-cid-dwelrhxs> <a href="/" class="logo font-extrabold lowercase transition-colors fluid:text-lg footer__logo dark:hover:text-light text-dark  dark:text-gray" aria-label="logo" data-astro-cid-ijoll5s5>ФCВР</a>  <small class="footer__copyright" data-astro-cid-dwelrhxs>все права защищены. © 2024</small> </div> </footer>  </body></html>