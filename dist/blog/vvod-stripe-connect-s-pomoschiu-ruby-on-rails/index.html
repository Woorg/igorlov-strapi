<!DOCTYPE html><html lang="ru"> <head><title>Ввод Stripe Connect с помощью Ruby on Rails | Игорь Горлов - Фронтeндер</title><link rel="canonical" href="https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails"><meta name="description" content="Stripe Connect предоставляет набор инструментов и API, которые позволяют вам создавать, управлять и масштабировать вашу платформу или торговую площадку, а такж"><meta name="robots" content="index, follow"><!-- favicon --><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><!-- theme meta --><meta name="theme-name" content="igorlov.ru"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="generator" content="Astro v4.5.1"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- responsive meta --><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><meta name="google-adsense-account" content="ca-pub-0634695143666394"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/_regular_.DbkvWnAm.css" />
<style>.breadcrumbs[data-astro-cid-vcbh62el]{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity));border-radius:min(1.5rem,1.1625rem + .45vw);padding-left:min(2rem,1.2125rem + 1.05vw);padding-right:min(2rem,1.2125rem + 1.05vw);padding-top:1rem;padding-bottom:1rem}.breadcrumbs[data-astro-cid-vcbh62el]:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}.breadcrumbs__list[data-astro-cid-vcbh62el]{display:flex;align-items:center;gap:.125rem}.breadcrumbs__link[data-astro-cid-vcbh62el]{border-radius:9999px;--tw-bg-opacity: 1;background-color:#fef9f8;background-color:rgba(254,249,248,var(--tw-bg-opacity));font-weight:500;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.breadcrumbs__link[data-astro-cid-vcbh62el]:hover{--tw-bg-opacity: 1;background-color:#fce4e1;background-color:rgba(252,228,225,var(--tw-bg-opacity))}.breadcrumbs__link[data-astro-cid-vcbh62el]{padding:.125rem .75rem}.breadcrumbs__link[data-astro-cid-vcbh62el]:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#6a6a6a;background-color:rgba(106,106,106,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}.breadcrumbs__link[data-astro-cid-vcbh62el]:hover:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#8a8a93;background-color:rgba(138,138,147,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}
</style>
<link rel="stylesheet" href="/_astro/_single_.BCoIA8H8.css" />
<style>.circular-pagination[data-astro-cid-ihkjvfsn]{display:flex;width:100%;flex-wrap:wrap;align-items:center;justify-content:center;overflow:hidden;border-top-width:1px;--tw-border-opacity: 1;border-color:#020202;border-color:rgba(2,2,2,var(--tw-border-opacity));margin-top:min(1.25rem,1.1375rem + .15vw)}.circular-pagination__link[data-astro-cid-ihkjvfsn]{width:100%;--tw-bg-opacity: 1;background-color:#fef9f8;background-color:rgba(254,249,248,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity));text-decoration-line:none}.circular-pagination__link[data-astro-cid-ihkjvfsn]:hover{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.circular-pagination__link[data-astro-cid-ihkjvfsn]{padding-left:min(1.5rem,1.1625rem + .45vw);padding-right:min(1.5rem,1.1625rem + .45vw);padding-top:.5rem;padding-bottom:.5rem}
.theme-toggle[data-v-8d8d9c54]{width:1.25rem;height:1.25rem}
.comments[data-v-533071ec]{margin:auto;margin-top:1.25rem;max-width:42rem;--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity))}.comments:where([class=dark][data-v-533071ec],[class=dark] *[data-v-533071ec]){--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity))}.giscus-frame[data-v-533071ec]{width:100%;--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#020202;color:rgba(2,2,2,var(--tw-text-opacity))}.giscus-frame:where([class=dark][data-v-533071ec],[class=dark] *[data-v-533071ec]){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity))}
</style><script type="module" src="/_astro/hoisted.DYPnEDpO.js"></script><style>[data-astro-transition-scope="astro-vgmtzcrq-1"] { view-transition-name: blog-image-vvod-stripe-connect-s-pomoschiu-ruby-on-rails; }</style></head> <body class="flex min-h-screen flex-col bg-gray-light pt-14 font-inter text-dark fluid:text-lg dark:bg-black dark:text-white"> <header class="header" data-astro-cid-rq644orq> <div class="header__container container" data-astro-cid-rq644orq> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg header__logo dark:hover:text-light text-dark  dark:text-gray" aria-label="logo" data-astro-cid-ijoll5s5>Фул фронт дев</a>  <div class="nav header__nav" data-astro-cid-7wkmezxd> <button class="nav__open" title="Открыть меню" data-astro-cid-7wkmezxd> <span class="nav__open-line" data-astro-cid-7wkmezxd></span> <span class="nav__open-line" data-astro-cid-7wkmezxd></span> <span class="nav__open-line" data-astro-cid-7wkmezxd></span> </button> <nav class="nav__container" data-astro-cid-7wkmezxd> <button class="nav__close" title="Закрыть меню" data-astro-cid-7wkmezxd> <span class="nav__close-line" data-astro-cid-7wkmezxd></span> <span class="nav__close-line" data-astro-cid-7wkmezxd></span> <span class="nav__close-line" data-astro-cid-7wkmezxd></span> </button> <ul class="nav__list" data-astro-cid-7wkmezxd> <li class="nav__item" data-astro-cid-7wkmezxd> <a href="/projects" class="nav__link" data-astro-cid-7wkmezxd> Работы. </a> </li><li class="nav__item" data-astro-cid-7wkmezxd> <a href="/blog" class="nav__link nav__link--active" data-astro-cid-7wkmezxd> Блог. </a> </li><li class="nav__item" data-astro-cid-7wkmezxd> <a href="#cta" class="nav__link" data-astro-cid-7wkmezxd> Контакты. </a> </li> </ul> </nav> </div>   <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();;(()=>{var v=Object.defineProperty;var A=(c,s,a)=>s in c?v(c,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):c[s]=a;var d=(c,s,a)=>(A(c,typeof s!="symbol"?s+"":s,a),a);var u;{let c={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},s=t=>{let[e,n]=t;return e in c?c[e](n):void 0},a=t=>t.map(s),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,s(n)]));customElements.get("astro-island")||customElements.define("astro-island",(u=class extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var f;if(!this.hydrator||!this.isConnected)return;let e=(f=this.parentElement)==null?void 0:f.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),r={},l=this.querySelectorAll("template[data-astro-template]");for(let o of l){let i=o.closest(this.tagName);i!=null&&i.isSameNode(this)&&(r[o.getAttribute("data-astro-template")||"default"]=o.innerHTML,o.remove())}for(let o of n){let i=o.closest(this.tagName);i!=null&&i.isSameNode(this)&&(r[o.getAttribute("name")||"default"]=o.innerHTML)}let h;try{h=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(o){let i=this.getAttribute("component-url")||"<unknown>",b=this.getAttribute("component-export");throw b&&(i+=` (export ${b})`),console.error(`[hydrate] Error parsing props for component ${i}`,this.getAttribute("props"),o),o}let p;await this.hydrator(this)(this.Component,h,r,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),n.disconnect(),this.childrenConnectedCallback()},n=new MutationObserver(()=>{var r;((r=this.lastChild)==null?void 0:r.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});n.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}try{await Astro[n](async()=>{let r=this.getAttribute("renderer-url"),[l,{default:h}]=await Promise.all([import(this.getAttribute("component-url")),r?import(r):()=>()=>{}]),p=this.getAttribute("component-export")||"default";if(!p.includes("."))this.Component=l[p];else{this.Component=l;for(let y of p.split("."))this.Component=this.Component[y]}return this.hydrator=h,this.hydrate},e,this)}catch(r){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,r)}}attributeChangedCallback(){this.hydrate()}},d(u,"observedAttributes",["props"]),u))}})();</script><astro-island uid="IJ3dh" component-url="/_astro/ThemeToggle.kpN4JrWQ.js" component-export="default" renderer-url="/_astro/client.DtEXyQF-.js" props="{&quot;data-astro-cid-rq644orq&quot;:[0,true]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;ThemeToggle&quot;,&quot;value&quot;:true}"></astro-island> </div> </header>  <main id="main-content" class="main flex-1">  <div class="blocks"> <div class="blocks__container container"> <nav aria-label="Breadcrumbs" class="breadcrumbs" data-astro-cid-vcbh62el> <ol class="breadcrumbs__list" role="list" data-astro-cid-vcbh62el> <li class="breadcrumbs__item" role="listitem" data-astro-cid-vcbh62el> <a class="breadcrumbs__link" href="/" data-astro-cid-vcbh62el> Главная </a> </li><li class="breadcrumbs__item" role="listitem" data-astro-cid-vcbh62el> <a class="breadcrumbs__link" href="/blog" data-astro-cid-vcbh62el> Blog </a> </li><li class="breadcrumbs__item" role="listitem" data-astro-cid-vcbh62el>  </li> </ol> </nav>  </div> <div class="blocks__container container"> <!-- <TextAds class="fade-in-bottom fluid:my-2" style="--delay: .8s;" /> --><article class="article" data-astro-cid-axzg2cw6> <div class="article__header" data-astro-cid-axzg2cw6> <ul class="article__categories categories" data-astro-cid-axzg2cw6> <li class="categories__item" data-astro-cid-axzg2cw6> <a href="/category/как-закодить" class="categories__link" data-astro-cid-axzg2cw6> Как закодить  </a> </li> </ul> <h1 class="article__title text-wrap" data-astro-cid-axzg2cw6> Ввод Stripe Connect с помощью Ruby on Rails </h1> <ul class="article__tags tags" data-astro-cid-axzg2cw6> <li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/stripe" data-astro-cid-axzg2cw6> Stripe </a> </li><li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/rails" data-astro-cid-axzg2cw6> Rails </a> </li> </ul> <time class="article__date" data-astro-cid-axzg2cw6>
Опубликовано 18 дек., 2023 by Игорь Горлов </time> <time class="article__date" data-astro-cid-axzg2cw6> Последнее изменение: 21 мар., 2024 </time> </div>  <figure class="article__image" data-astro-cid-axzg2cw6> <picture> <source srcset="/_astro/vvod-stripe-connect-s-pomoschiu-ruby-on-rails-Dec-18-2023.CmyZf2Jt_Z1oYB7A.avif" type="image/avif"><source srcset="/_astro/vvod-stripe-connect-s-pomoschiu-ruby-on-rails-Dec-18-2023.CmyZf2Jt_Z1gNro6.webp" type="image/webp"> <img src="/_astro/vvod-stripe-connect-s-pomoschiu-ruby-on-rails-Dec-18-2023.CmyZf2Jt_sEi0y.png" alt="Ввод Stripe Connect с помощью Ruby on Rails" class="aspect-auto h-full w-full object-cover object-center" loading="eager" data-astro-cid-axzg2cw6 data-astro-transition-scope="astro-vgmtzcrq-1" width="1200" height="500" decoding="async"> </picture> </figure>  <div class="article__content prose prose-zinc max-w-full break-words dark:prose-invert prose-p:text-balance prose-a:no-underline hover:prose-a:underline prose-figure:-mx-12 prose-figure:w-screen prose-figure:bg-gray-light prose-figure:p-10 prose-figcaption:text-dark dark:prose-figure:bg-dark dark:prose-figcaption:text-white" data-astro-cid-axzg2cw6> <div id="adfox_17062261612859555"></div> <script>(function(){const blockId = "adfox_17062261612859555";

	window.yaContextCb = window.yaContextCb || [];
	window.yaContextCb.push(() => {
		Ya.adfoxCode.createAdaptive(
			{
				ownerId: 1493338,
				containerId: blockId,
				params: {
					p1: 'dawgg',
					p2: 'p',
				},
			},
			['desktop', 'tablet', 'phone'],
			{
				tabletWidth: 830,
				phoneWidth: 480,
				isAutoReloads: true,
			},
		);
	});
})();</script> <div class="article__meta" data-astro-cid-axzg2cw6> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Ввод Stripe Connect с помощью Ruby on Rails&#38;url=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&#38;url=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails&#38;title=Ввод Stripe Connect с помощью Ruby on Rails&#38;summary=Stripe Connect предоставляет набор инструментов и API, которые позволяют вам создавать, управлять и масштабировать вашу платформу или торговую площадку, а такж&#38;source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails&#38;media=&#38;description=Stripe Connect предоставляет набор инструментов и API, которые позволяют вам создавать, управлять и масштабировать вашу платформу или торговую площадку, а такж" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <a class="article__meta-section" href="#comments" data-astro-cid-axzg2cw6> Комментарии</a> </div> <details open class="toc px-5 border border-gray-light lg:px-10 py-2 cursor-pointer"><summary class="toc__title text-xl font-medium">Содержание</summary><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#давайте-начнем">Давайте начнем!</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#настройка-базы-данных">Настройка базы данных</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#генерируем-модель-user">Генерируем модель User:</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#генерируем-модель-рассылки-новостей">Генерируем модель рассылки новостей:</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#генерирование-модели-выпуска-новостей">Генерирование модели выпуска новостей:</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#генерация-модели-подписки">Генерация модели подписки:</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#запустите-миграцию-базы-данных">Запустите миграцию базы данных:</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#настройка-stripe">Настройка Stripe</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#настройка-аутентификации">Настройка аутентификации</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#настройка-подключения-к-connect">Настройка подключения к Connect</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#настройка-веб-хуков">Настройка веб-хуков</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#запустите-слушатель-с-помощью-команды">Запустите слушатель с помощью команды:</a></li></ol></details open><p>Stripe Connect предоставляет набор инструментов и API, которые позволяют вам создавать, управлять и масштабировать вашу платформу или торговую площадку, а также осуществлять платежи и выплаты для ваших пользователей. Если вы впервые знакомитесь со Stripe Connect, ознакомьтесь с первыми статьями этого цикла. В этой статье вы узнаете, как интегрировать Stripe Connect Onboarding с Ruby on Rails, чтобы вы могли начать упрощать движение денег для своих пользователей.</p>
<p>Мы рассмотрим пример использования платформы для рассылки электронных писем, где читатели поддерживают своих любимых авторов, внося ежемесячную плату за получение периодических писем. Вы узнаете, как создавать аккаунты Stripe и собирать информацию о бизнесе с помощью хостинга Stripe Connect. Мы также рассмотрим настройку среды Rails и некоторые лучшие практики для плавной интеграции.</p>
<h2 id="давайте-начнем">Давайте начнем!<a aria-hidden="true" tabindex="-1" href="#давайте-начнем"><span class="icon icon-link"></span></a></h2>
<p>Мы начнем с того, что создадим новое Rails-приложение, использующее Tailwind CSS для стилей и Postgres для базы данных. <code>-T</code> означает пропуск добавления инфраструктуры тестирования по умолчанию, а <code>--main</code> задает имя ветки git.</p>
<p><code>rails new newsletter-platform -c tailwind -j esbuild -d postgresql -T --main</code>.</p>
<p>Мы будем хранить каждый выпуск рассылки в базе данных, чтобы авторы могли направлять пользователей в свой бэк-каталог, если они захотят прочитать прошлые выпуски. Прежде чем отправить выпуск рассылки читателю, мы проверим, что у читателя есть активная подписка на оплату.</p>
<p>Давайте начнем с настройки этих моделей баз данных.</p>
<h2 id="настройка-базы-данных">Настройка базы данных<a aria-hidden="true" tabindex="-1" href="#настройка-базы-данных"><span class="icon icon-link"></span></a></h2>
<p>Чтобы настроить необходимые модели баз данных для этой платформы рассылки, мы создадим основные модели: User, Newsletter, NewsletterIssue и Subscription. Модель User представляет автора, модель Newsletter соответствует каждой коллекции выпусков, модель NewsletterIssue представляет каждый ежемесячный выпуск рассылки, а модель Subscription связывает читателей с рассылками, на которые у них есть активные платежные подписки. Давайте начнем с генерации этих моделей.</p>
<h2 id="генерируем-модель-user">Генерируем модель User:<a aria-hidden="true" tabindex="-1" href="#генерируем-модель-user"><span class="icon icon-link"></span></a></h2>
<p>Модель User используется для аутентификации. И читатели, и авторы представлены в базе данных как пользователи.</p>
<p>Для читателей мы храним <code>stripe_customer_id</code>. Мы будем использовать API Stripe для создания объектов клиентов для всех пользователей, чтобы мы могли отслеживать все подписки и счета, связанные с данным читателем.</p>
<p>Для авторов мы храним <code>stripe_account_id</code>. Он представляет собой идентификатор Stripe-аккаунта автора и позволяет нам направлять платежи от читателей к автору. Мы также храним флаги <code>charges_enabled</code> и <code>payouts_enabled</code>, чтобы знать, когда аккаунт полностью подключен и может успешно получать деньги.</p>
<p><code>rails generate model User name:string email:string stripe_customer_id:string stripe_account_id:string charges_enabled:boolean payouts_enabled:boolean</code>.</p>
<h2 id="генерируем-модель-рассылки-новостей">Генерируем модель рассылки новостей:<a aria-hidden="true" tabindex="-1" href="#генерируем-модель-рассылки-новостей"><span class="icon icon-link"></span></a></h2>
<p>Новостные рассылки имеют связь по внешнему ключу с ID автора в таблице Users.</p>
<p><code>rails generate model Newsletter user:references title:string</code>.</p>
<h2 id="генерирование-модели-выпуска-новостей">Генерирование модели выпуска новостей:<a aria-hidden="true" tabindex="-1" href="#генерирование-модели-выпуска-новостей"><span class="icon icon-link"></span></a></h2>
<p>Выпуски рассылки связаны с рассылкой, о которой они пишут, и для начала мы ограничимся заголовком и блоком текста для содержания. Дата <code>published_at</code> позволяет нам запланировать выпуск на будущее.</p>
<p><code>rails generate model NewsletterIssue newsletter:references subject:string content:text published_at:datetime</code>.</p>
<h2 id="генерация-модели-подписки">Генерация модели подписки:<a aria-hidden="true" tabindex="-1" href="#генерация-модели-подписки"><span class="icon icon-link"></span></a></h2>
<p>Когда читатель подписывается на рассылку в первый раз, мы отправляем его через платежный поток с помощью Stripe Checkout, чтобы собрать его платежные данные и запустить подписку Stripe, которая собирает повторяющиеся платежи. Мы будем хранить <code>stripe_subscription_id</code> в базе данных, чтобы иметь возможность проверить Stripe API, чтобы узнать, активен ли платеж.</p>
<p><code>rails generate model Subscription user:references newsletter:references stripe_subscription_id:string status:string</code>.</p>
<h2 id="запустите-миграцию-базы-данных">Запустите миграцию базы данных:<a aria-hidden="true" tabindex="-1" href="#запустите-миграцию-базы-данных"><span class="icon icon-link"></span></a></h2>
<p><code>rails db:migrate</code></p>
<p>Теперь давайте настроим отношения между этими моделями:</p>
<p>В <code>app/models/user.rb</code>:</p>
<p><code>class User &#x3C; ApplicationRecord has_many :newsletters has_many :subscriptions end</code>.</p>
<p>В <code>app/models/newsletter.rb</code>:</p>
<p><code>class Newsletter &#x3C; ApplicationRecord belongs_to :user has_many :newsletter_issues end</code>.</p>
<p>В <code>app/models/newsletter_issue.rb</code>:</p>
<p><code>class NewsletterIssue &#x3C; ApplicationRecord belongs_to :newsletter end</code>.</p>
<p>В <code>app/models/subscription.rb</code>:</p>
<p><code>class Subscription &#x3C; ApplicationRecord belongs_to :user belongs_to :newsletter end</code>.</p>
<p>С этими моделями мы теперь можем представлять авторов, рассылки и их выпуски, а также подписки читателей в нашей базе данных. В следующих шагах мы реализуем логику Stripe Connect Onboarding.</p>
<h2 id="настройка-stripe">Настройка Stripe<a aria-hidden="true" tabindex="-1" href="#настройка-stripe"><span class="icon icon-link"></span></a></h2>
<p>Используйте stripe-ruby SDK для взаимодействия с API Stripe.</p>
<p><code>bundle add stripe</code></p>
<p>Получите API-ключи с dashboard.stripe.com и вставьте их в наши учетные данные в Rails.</p>
<p><code>EDITOR=vi rails credentials:edit</code></p>
<p>Вставьте ключи следующим образом:</p>
<p><code>stripe: secret_key: sk_test_51EceeUCZ6qs... publishable_key: pk_test_vAZ3gh1Lc...</code>.</p>
<p>Добавьте инициализатор в <code>config/initializers/stripe.rb</code> для установки API-ключа на уровне платформы. Нетчто у каждого авторского аккаунта Stripe будут свои собственные ключи API, но в Stripe Connect нам никогда не нужны ключи подключенных аккаунтов. Вместо этого мы аутентифицируем запросы к подключенным аккаунтам с помощью комбинации API-ключа нашего уровня платформы и идентификатора подключенного аккаунта. Более подробную информацию см. здесь.</p>
<p><code>Stripe.api_key = Rails.application.credentials.dig(:stripe, :secret_key)</code>.</p>
<p>Теперь мы готовы начать выполнять вызовы API для Stripe из Ruby. Прежде чем мы начнем использовать API Stripe, давайте настроим аутентификацию.</p>
<h2 id="настройка-аутентификации">Настройка аутентификации<a aria-hidden="true" tabindex="-1" href="#настройка-аутентификации"><span class="icon icon-link"></span></a></h2>
<p>Для этого случая пользователям нужен способ аутентификации в приложении. Поскольку мы используем Ruby on Rails, мы будем использовать аутентификацию devise для авторов.</p>
<p>Мы установим гем devise, запустим установочные скрипты и сгенерируем маршруты и миграцию для авторов, чтобы они могли аутентифицироваться в базе данных.</p>
<p><code>bundle add devise rails generate devise:install rails g devise:views rails g devise Author</code>.</p>
<p>И снова мы мигрируем базу данных.</p>
<p><code>rails db:migrate</code></p>
<p>Запустив <code>bin/dev</code>, мы запускаем сервер, чтобы протестировать наш поток регистрации по адресу localhost:3000/authors/sign_up.</p>
<p>Нам представлено нестилизованное представление входа в систему, которое мы очистим позже.</p>
<p>Теперь, когда пользователи могут зарегистрироваться в приложении, нам нужно подключить их к Stripe Connect, чтобы мы могли начать взаимодействовать с API Stripe от их имени.</p>
<h2 id="настройка-подключения-к-connect">Настройка подключения к Connect<a aria-hidden="true" tabindex="-1" href="#настройка-подключения-к-connect"><span class="icon icon-link"></span></a></h2>
<p>Connect поддерживает 3 различных типа аккаунтов: Standard, Express и Custom. Поскольку авторы могут не иметь опыта работы с возвратами и возвратными платежами в данном случае, имеет смысл предоставить им интеграцию, при которой они будут иметь доступ к более простой панели Stripe с подключенным аккаунтом типа Express. Подробнее о преимуществах различных типов аккаунтов можно узнать здесь. Примечание: мы надеемся убрать концепцию типа аккаунта, так что следите за новостями, чтобы не запутать пользователей в разграничении функций Connect.</p>
<p>Для входа в систему у нас будет страница, на которой мы либо покажем данные подключенного аккаунта, либо дадим пользователю кнопку для создания нового аккаунта и прохождения процесса входа в систему. Эти функции будут выполняться новым контроллером StripeAccountsController.</p>
<p><code>rails g controller StripeAccounts show</code></p>
<p>Мы добавим единичные маршруты ресурсов для /stripe_account, обновив config/routes.rb.</p>
<p><code>Rails.application.routes.draw do resource :stripe_account devise_for :users end</code>.</p>
<p>Далее мы добавим макрос before action из devise, который требует аутентифицированного автора для доступа к этим маршрутам.</p>
<p><code>class StripeAccountsController &#x3C; ApplicationController before_action :authenticate_author! end</code>.</p>
<p>Представление для маршрута show пока очень простое.</p>
<p><code>&#x3C;% if current_user.stripe_account_id.present? %> &#x3C;%= current_user.stripe_account.to_json %> &#x3C;% else %> Не найден аккаунт Stripe &#x3C;%= button_to "Create a Stripe Account", stripe_account_path, method: :post, data: { turbo: false } %> &#x3C;% end %></code></p>
<p>Когда пользователь нажимает на кнопку “Создать аккаунт Stripe”, мы сначала совершаем API-вызов в Stripe для создания нового аккаунта Express, затем обновляем базу данных с идентификатором аккаунта и, наконец, перенаправляем через поток регистрации аккаунта с помощью ссылки на аккаунт.</p>
<p>Цель состоит в том, чтобы свести к минимуму количество информации, которую автор должен вводить повторно. Например, у нас уже есть адрес электронной почты автора, поэтому мы можем заполнить его на уровне аккаунта и отдельного пользователя. Мы также предположим, что все авторы - частные лица, а не компании. Мы можем заполнить mcc (merchant category code) бизнес-профиля цифровыми товарами, чтобы каждому автору не приходилось копаться в списке типов услуг в поисках цифровых товаров.</p>
<p><code>def create account = Stripe::Account.create( type: 'standard', email: current_user.email, business_type: 'individual', business_profile: { mcc: '5818', }, individual: { email: current_user.email, }, metadata: { author_id: current_user.id, } ) current_user.update(stripe_account_id: account.id) account_link = Stripe::AccountLink.create( account: account.id, refresh_url: stripe_account_url, return_url: stripe_account_url, type: 'account_onboarding' ) redirect_to account_link.url, status: :see_other, allow_other_host: true end</code></p>
<p>Когда в Stripe происходят события, связанные с аккаунтами Stripe, приложение может быть уведомлено с помощью веб-крючков. Нам нужно прослушать тип события <code>account.updated</code> webhook, чтобы знать, когда аккаунт успешно завершил онбординг.</p>
<h2 id="настройка-веб-хуков">Настройка веб-хуков<a aria-hidden="true" tabindex="-1" href="#настройка-веб-хуков"><span class="icon icon-link"></span></a></h2>
<p>Нам нужен контроллер для обработки входящих POST-запросов от Stripe.</p>
<p><code>rails g controller Webhooks</code></p>
<p>Мы добавим простой маршрут /webhooks для обработки POST-запросов.</p>
<p><code>resources :webhooks, only: [:create]</code>.</p>
<p>Поскольку запросы приходят от Stripe, мы не можем проверить CSRF-токен, поэтому пропустим эту проверку в верхней части контроллера.</p>
<p><code>class WebhooksController &#x3C; ApplicationController skip_before_action :verify_authenticity_token</code></p>
<p>Затем мы добавим метод create для обработки пост-запросов от Stripe, чтобы десериализовать тело события и переключаться в зависимости от типа уведомления о событии.</p>
<p><code>def create payload = request.body.read event = nil begin event = Stripe::Event.construct_from( JSON.parse(payload, symbolize_names: true) ) rescue JSON::ParserError => e # Invalid payload puts "⚠️ Webhook error while parsing basic request. #{e.message})" render json: { message: 'failed' }, status: 400 return end case event.type when 'account.updated' account = event.data.object # содержит Stripe::Account # TODO: Handle account updates else puts "Unhandled event type: #{event.type}" end render json: { message: 'success' } end</code></p>
<p>Каждый раз, когда мы получаем событие account.updated, мы хотим обновить флаги нашего локального автора, чтобы узнать, включены ли начисления и выплаты.</p>
<p><code>when 'account.updated' account = event.data.object # содержит Stripe::Account author = User.find_by(stripe_account_id: account.id) author.update( charges_enabled: account.charges_enabled, payouts_enabled: account.payouts_enabled )</code>.</p>
<p>Для локального создания и тестирования веб-крючков мы будем использовать Stripe CLI. Команда <code>listen</code> позволяет нам перенаправлять события веб-хуков как от аккаунта, так и от соединения. События аккаунта, они же прямые события, - это события, которые происходят на нашем аккаунте, события подключения - это события, которые происходят на подключенных аккаунтах.</p>
<h2 id="запустите-слушатель-с-помощью-команды">Запустите слушатель с помощью команды:<a aria-hidden="true" tabindex="-1" href="#запустите-слушатель-с-помощью-команды"><span class="icon icon-link"></span></a></h2>
<p><code>stripe listen --forward-to localhost:3000/webhooks --forward-connect-to localhost:3000/webhooks</code>.</p>
<p>Для удобства работы с Rails я добавляю новый процесс в Procfile.dev, чтобы он запускался каждый раз, когда мы запускаем bin/dev. Мой Procfile.dev выглядит следующим образом:</p>
<p><code>web: bin/rails server -p 3000 js: yarn build --watch css: yarn build:css --watch stripe: stripe listen --forward-to localhost:3000/webhooks --forward-connect-to localhost:3000/webhooks</code>.</p>
<p>Теперь мы можем пройти через поток onboarding и ввести детали теста. Используйте магические тестовые строки из этой документации, чтобы обеспечить верификацию тестового аккаунта. Обратите внимание, что для активации учетной записи вам также потребуется подтвердить свой email, поэтому используйте реальный адрес электронной почты, к которому у вас есть доступ при создании новой учетной записи для подключения.</p>
<p>Если все прошло по плану, вы видите JSON для аккаунта Stripe в браузере, у вашего Автора есть идентификатор аккаунта Stripe, начисления включены в true, а выплаты включены в true в базе данных.</p>
<p><a href="https://dev.to/stripe/stripe-connect-onboarding-with-ruby-on-rails-32i4" rel="noopener noreferrer nofollow" target="_blank">Источник</a></p> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Ввод Stripe Connect с помощью Ruby on Rails&#38;url=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&#38;url=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails&#38;title=Ввод Stripe Connect с помощью Ruby on Rails&#38;summary=Stripe Connect предоставляет набор инструментов и API, которые позволяют вам создавать, управлять и масштабировать вашу платформу или торговую площадку, а такж&#38;source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/vvod-stripe-connect-s-pomoschiu-ruby-on-rails&#38;media=&#38;description=Stripe Connect предоставляет набор инструментов и API, которые позволяют вам создавать, управлять и масштабировать вашу платформу или торговую площадку, а такж" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <nav class="circular-pagination" aria-label="Circular Pagination" data-astro-cid-ihkjvfsn> <a href="/blog/symfony-vs-laravel-bytva-php-freimvorkov" class="circular-pagination__link circular-pagination__link--prev" data-astro-cid-ihkjvfsn> Symfony vs Laravel: Битва PHP-фреймворков </a> <a href="/blog/neskolko-sposobov-spravytsia-s-pobochn-m-ffektom-zaprosa-kotor-e-v-dolzhn-znat" class="circular-pagination__link circular-pagination__link--next" data-astro-cid-ihkjvfsn> Несколько способов справиться с побочным эффектом запроса, которые вы должны знать </a> </nav>  </div> </article> <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="Z1T5Wnr" prefix="r0" component-url="/_astro/YandexRelatedAds.svLg6TOn.js" component-export="default" renderer-url="/_astro/client.D9Vng9vH.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;YandexRelatedAds&quot;,&quot;value&quot;:true}" await-children=""><div id="yandex_rtb_C-A-2592503-2"></div><!--astro:end--></astro-island> <astro-island uid="Z2a8j9B" component-url="/_astro/CommentBlock.BwogX8bT.js" component-export="default" renderer-url="/_astro/client.DtEXyQF-.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;CommentBlock&quot;,&quot;value&quot;:true}"></astro-island>  </div> <!-- <div class="blocks__container container">
			<CtaBlock id="cta" class=""
			/>
		</div> --> </div>    </main> <footer class="footer" data-astro-cid-dwelrhxs> <div class="footer__container container" data-astro-cid-dwelrhxs> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg footer__logo dark:hover:text-light text-dark  dark:text-gray" aria-label="logo" data-astro-cid-ijoll5s5>Фул фронт дев</a>  <small class="footer__copyright" data-astro-cid-dwelrhxs>все права защищены. © 2024</small> </div> </footer>  </body></html>