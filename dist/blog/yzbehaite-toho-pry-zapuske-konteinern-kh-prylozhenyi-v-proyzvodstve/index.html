<!DOCTYPE html><html lang="ru"> <head><title>Избегайте этого при запуске контейнерных приложений в производстве | Игорь Горлов - Fullstack Developer</title><link rel="canonical" href="https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve"><meta name="description" content="Привет всем!Давайте поговорим о том, чем нужно управлять при запуске контейнерных приложений, и как это связано с правильным управлением сигналами завершения"><meta name="robots" content="index, follow"><!-- favicon --><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><!-- theme meta --><meta name="theme-name" content="igorlov.ru"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"><meta name="generator" content="Astro v4.10.0"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- responsive meta --><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><meta name="google-adsense-account" content="ca-pub-0634695143666394"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><link rel="stylesheet" href="/_astro/_regular_.Dg72Zwgc.css">
<style>.breadcrumbs[data-astro-cid-vcbh62el]{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#0d52a1;color:rgba(13,82,161,var(--tw-text-opacity));border-radius:min(1.5rem,1.1625rem + .45vw)}.breadcrumbs[data-astro-cid-vcbh62el]:where([class=dark],[class=dark] *){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#fff;color:rgba(255,255,255,var(--tw-text-opacity))}.container[data-astro-cid-vcbh62el]{padding:min(2rem,1.2125rem + 1.05vw)}.list[data-astro-cid-vcbh62el]{display:flex;align-items:center;gap:.125rem}.link[data-astro-cid-vcbh62el]{font-weight:500;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s;padding:.125rem .75rem;font-size:min(1.5rem,1.1625rem + .45vw);line-height:var(--tw-lh)}
</style>
<link rel="stylesheet" href="/_astro/_single_.CzD8Xhhr.css">
<style>.circular-pagination[data-astro-cid-ihkjvfsn]{display:flex;width:100%;flex-wrap:wrap;align-items:center;justify-content:center;overflow:hidden;border-top-width:1px;--tw-border-opacity: 1;border-color:#27292d;border-color:rgba(39,41,45,var(--tw-border-opacity));margin-top:min(1.25rem,1.1375rem + .15vw)}.circular-pagination__link[data-astro-cid-ihkjvfsn]{width:100%;--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity));text-decoration-line:none}.circular-pagination__link[data-astro-cid-ihkjvfsn]:hover{--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.circular-pagination__link[data-astro-cid-ihkjvfsn]{padding-left:min(1.5rem,1.1625rem + .45vw);padding-right:min(1.5rem,1.1625rem + .45vw);padding-top:.5rem;padding-bottom:.5rem}
.comments[data-v-f9c4118f]{margin:auto;margin-top:1.25rem;width:100%;--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.comments:where([class=dark][data-v-f9c4118f],[class=dark] *[data-v-f9c4118f]){--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.giscus-frame[data-v-f9c4118f]{width:100%;--tw-bg-opacity: 1;background-color:#fff;background-color:rgba(255,255,255,var(--tw-bg-opacity));--tw-text-opacity: 1;color:#27292d;color:rgba(39,41,45,var(--tw-text-opacity))}.giscus-frame:where([class=dark][data-v-f9c4118f],[class=dark] *[data-v-f9c4118f]){--tw-bg-opacity: 1;background-color:#131315;background-color:rgba(19,19,21,var(--tw-bg-opacity))}
</style><script type="module" src="/_astro/hoisted.CUFolni_.js"></script><style>[data-astro-transition-scope="astro-xdjatz7t-1"] { view-transition-name: blog-image-yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve; }</style></head> <body class="flex min-h-screen flex-col bg-gray-light pt-16 font-inter text-blue fluid:text-lg lg:pt-24 dark:bg-black dark:text-white"> <header class="header" data-astro-cid-rq644orq> <div class="header__container container" data-astro-cid-rq644orq> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg header__logo dark:hover:text-light text-blue dark:text-white" aria-label="logo" data-astro-cid-ijoll5s5> <svg width="1.44em" height="1em" viewBox="0 0 5660 3931" class="icon" data-astro-cid-ijoll5s5 data-icon="logo-one">  <symbol id="ai:local:logo-one"><g fill="currentColor"><path d="M1198.57 596.749c0 329.575-267.171 596.751-596.747 596.751-329.575 0-596.749-267.176-596.749-596.751S272.248 0 601.823 0c329.576 0 596.747 267.174 596.747 596.749Z"/><circle cx="3035.75" cy="617.751" r="596.749" transform="rotate(-90 3035.75 617.751)"/><path d="M3035.75 2736.81c329.57 0 596.75 267.18 596.75 596.75 0 329.58-267.18 596.75-596.75 596.75-329.58 0-596.75-267.17-596.75-596.75 0-329.57 267.17-596.75 596.75-596.75Z"/><circle cx="596.749" cy="1964.8" r="596.749"/><path d="M1193.5 3332.87c0 329.57-267.176 596.75-596.751 596.75S0 3662.44 0 3332.87c0-329.58 267.174-596.75 596.749-596.75 329.575 0 596.751 267.17 596.751 596.75Z"/><circle cx="5062.46" cy="617.751" r="596.749" transform="rotate(-90 5062.46 617.751)"/><circle cx="5062.46" cy="3333.56" r="596.749" transform="rotate(-90 5062.46 3333.56)"/></g></symbol><use xlink:href="#ai:local:logo-one"></use>  </svg>  </a> <div class="nav header__nav" data-astro-cid-7wkmezxd> <button class="nav__open" title="Открыть меню" data-astro-cid-7wkmezxd> Меню</button> <nav class="nav__container" data-astro-cid-7wkmezxd> <button class="nav__close" title="Закрыть меню" data-astro-cid-7wkmezxd> Закрыть</button> <ul class="nav__list" data-astro-cid-7wkmezxd> <li class="nav__item" data-astro-cid-7wkmezxd> <a href="/blog" class="nav__link nav__link--active" data-astro-cid-7wkmezxd> Блог </a> </li><li class="nav__item" data-astro-cid-7wkmezxd> <a href="#cta" class="nav__link" data-astro-cid-7wkmezxd> Контакты </a> </li> </ul> </nav> </div>   <!-- <ThemeToggle client:only /> --> </div> </header>  <main id="main-content" class="main flex-1">  <div class="blocks"> <nav aria-label="Breadcrumbs" class="breadcrumbs" data-astro-cid-vcbh62el> <div class="container" data-astro-cid-vcbh62el> <ol class="list" role="list" data-astro-cid-vcbh62el> <li class="item" role="listitem" data-astro-cid-vcbh62el> <a class="link" href="/" data-astro-cid-vcbh62el> Главная </a> </li><li class="item" role="listitem" data-astro-cid-vcbh62el> <a class="link" href="/blog" data-astro-cid-vcbh62el> Blog </a> </li><li class="item" role="listitem" data-astro-cid-vcbh62el>  </li> </ol> </div> </nav>  <!-- <TextAds class="fade-in-bottom fluid:my-2" style="--delay: .8s;" /> --><article class="article" data-astro-cid-axzg2cw6> <article data-astro-cid-axzg2cw6> <figure class="article__image" data-astro-cid-axzg2cw6> <picture data-astro-cid-axzg2cw6> <source srcset="/_astro/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve-Dec-18-2023.DPPfTujh_ZUvuv7.avif" type="image/avif"><source srcset="/_astro/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve-Dec-18-2023.DPPfTujh_Z23xwax.webp" type="image/webp"> <img src="/_astro/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve-Dec-18-2023.DPPfTujh_Z1x8Cya.png" alt="Избегайте этого при запуске контейнерных приложений в производстве" class="aspect-video h-full w-full object-cover object-center" loading="eager" data-astro-cid-axzg2cw6 data-astro-transition-scope="astro-xdjatz7t-1" width="1120" height="580" decoding="async"> </picture> </figure> </article> <div class="container" data-astro-cid-axzg2cw6> <div class="article__header" data-astro-cid-axzg2cw6> <ul class="article__categories categories" data-astro-cid-axzg2cw6> <li class="categories__item" data-astro-cid-axzg2cw6> <a href="/category/как-пофиксить" class="categories__link" data-astro-cid-axzg2cw6> Как пофиксить  </a> </li> </ul> <h1 class="article__title text-wrap" data-astro-cid-axzg2cw6> Избегайте этого при запуске контейнерных приложений в производстве </h1> <ul class="article__tags tags" data-astro-cid-axzg2cw6> <li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/docker" data-astro-cid-axzg2cw6> Docker </a> </li><li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/kubernetes" data-astro-cid-axzg2cw6> Kubernetes </a> </li><li class="tags__item" data-astro-cid-axzg2cw6> <a class="tags__link" href="/tag/контейнеры" data-astro-cid-axzg2cw6> Контейнеры </a> </li> </ul> <time class="article__date" data-astro-cid-axzg2cw6>
Опубликовано 18 дек., 2023 by Игорь Горлов </time> <time class="article__date" data-astro-cid-axzg2cw6> Последнее изменение: 21 мар., 2024 </time> </div> <div class="article__content prose prose-zinc max-w-full break-words text-blue dark:prose-invert prose-headings:text-blue prose-p:text-balance prose-a:no-underline hover:prose-a:underline prose-figure:bg-gray-light prose-figure:p-10 prose-figcaption:text-dark dark:prose-figure:bg-dark dark:prose-figcaption:text-white" data-astro-cid-axzg2cw6> <!-- <TextAds /> --> <!-- <AdfoxTocAds blockId="adfox_17062261612859555" /> --> <div class="article__meta" data-astro-cid-axzg2cw6> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Избегайте этого при запуске контейнерных приложений в производстве&url=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&url=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve&title=Избегайте этого при запуске контейнерных приложений в производстве&summary=Привет всем!

Давайте поговорим о том, чем нужно управлять при запуске контейнерных приложений, и как это связано с правильным управлением сигналами завершения&source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve&media=&description=Привет всем!

Давайте поговорим о том, чем нужно управлять при запуске контейнерных приложений, и как это связано с правильным управлением сигналами завершения" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <a class="article__meta-section" href="#comments" data-astro-cid-axzg2cw6> Комментарии</a> </div> <details open class="toc border-b border-blue text-blue fluid:p-8 overflow-auto cursor-pointer bg-box"><summary class="toc__title text-xl font-medium">Содержание</summary><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#сигналы-завершения">Сигналы завершения</a></li><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#как-выполнить-плавное-выключение">Как выполнить плавное выключение?</a></li><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#производственная-среда">Производственная среда</a></li><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#жизненный-цикл-контейнера">Жизненный цикл контейнера</a></li><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#поведение-сигнала-о-прекращении-обслуживания">Поведение сигнала о прекращении обслуживания</a></li><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#что-может-пойти-не-так">Что может пойти не так?</a></li><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#не-позволяйте-вашему-процессу-подачи-заявки-стать-pid1">Не позволяйте вашему процессу подачи заявки стать PID1</a></li><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#что-представляет-собой-процесс-pid1-под-псевдонимом-init">Что представляет собой процесс PID1 под псевдонимом “init”?</a></li><li class="toc-item toc-item-h2"><a class="text-blue text-blue-h2" href="#кто-же-тогда-должен-быть-pid1">Кто же тогда должен быть PID1?</a></li></ol></details open><p>Привет всем!</p>
<p>Давайте поговорим о том, чем нужно управлять при запуске контейнерных приложений, и как это связано с правильным управлением сигналами завершения.</p>
<p>Если вы предпочитаете формат GitHub с примерами, я создал репозиторий, который следует тому же пути с практическими примерами.</p>
<p>Прежде чем говорить конкретно о контейнерах, давайте отложим их в сторону и посмотрим, как мы запускаем приложения на ежедневной основе. Все мы используем различные операционные системы, способные выполнять огромное количество задач. Эти задачи выполняются в рамках процессов - одной из фундаментальных единиц операционной системы.</p>
<p>Следовательно, каждое приложение назначается процессу, который будет жить до тех пор, пока приложение не завершится должным образом.</p>
<p>С помощью Node.js мы можем проверить, какой идентификатор процесса в данный момент выполняет наше приложение:</p>
<p><code>$ node -e "console.log(process.pid)" > 39829</code></p>
<p>В общем, одной из основных обязанностей операционной системы является управление жизненным циклом этих процессов: их создание, уничтожение, приостановка, перезапуск и т. д.</p>
<p>Процессы также могут взаимодействовать с другими процессами, например, довольно часто родительский процесс управляет набором дочерних процессов для запуска многопроцессного приложения.</p>
<h2 id="сигналы-завершения">Сигналы завершения<a aria-hidden="true" tabindex="-1" href="#сигналы-завершения"><span class="icon icon-link"></span></a></h2>
<p>Сигналы завершения - это примитивы, используемые ОС, чтобы сообщить определенному процессу о его завершении.</p>
<p>В Unix эти сигналы завершения работы можно послать с помощью команды kill.</p>
<p><code>$ kill 39829 // SIGTERM by default $ kill -9 39829 // SIGKILL</code></p>
<p>Существует множество существующих сигналов завершения, но мы поговорим о трех наиболее распространенных:</p>
<p>SIGTERM: это самый распространенный сигнал завершения. Такое завершение называется ”мягким”, потому что сигнал просто приказывает процессу остановиться, но процесс может решить проигнорировать его. В Unix OS этот сигнал используется по умолчанию при использовании команды <code>kill</code>. Это эквивалент кнопки OFF на вашем пульте дистанционного управления.</p>
<p>SIGKILL: это самый грубый сигнал завершения, поскольку он не позволяет целевому процессу реагировать на сигнал или игнорировать его. Этот сигнал используется для немедленного завершения процесса и по определению не допускает изящного завершения приложения (об этом чуть ниже). Это эквивалентно внезапному выдергиванию вилки из розетки.</p>
<p>SIGINT: это сигнал прерывания, который, например, посылается, когда пользователь отправляет команду CTRL+C в терминале, на котором в данный момент выполняется процесс.</p>
<p>Благодатное завершение работы: одна из основных обязанностей приложения производственного класса</p>
<p>Теперь, когда мы знаем, что такое сигналы завершения, мы можем задаться вопросом, какова ответственность приложения в отношении этих сигналов?</p>
<p>Само приложение должно правильно обрабатывать эти сигналы, иначе не будет возможности для плавного завершения работы.</p>
<p>Под изящным завершением работы приложения понимается чистое и контролируемое завершение работы программы, при котором не происходит ни потери данных, ни утечки ресурсов, и программа имеет возможность выполнить другие критические операции перед завершением работы, например, ведение журнала. Это происходит благодаря действию ”Извлечение” на компьютерном диске, которое позволяет выполнить чистое отключение. Я предполагаю, что вы уже знаете о последствиях такого действия 💣.</p>
<h2 id="как-выполнить-плавное-выключение">Как выполнить плавное выключение?<a aria-hidden="true" tabindex="-1" href="#как-выполнить-плавное-выключение"><span class="icon icon-link"></span></a></h2>
<p>Чаще всего супервизоры процессов сначала подают ”мягкие” сигналы, такие как SIGTERM или SIGINT, которые не завершают процессы сразу.</p>
<p>В течение определенного периода времени (в зависимости от супервизора) процесс приложения успеет очистить все, что ему нужно было сделать, и затем выйти, т. е. сам выполнит грациозное завершение работы. Другими словами, льготное завершение работы начинается с реакции на сигнал о завершении работы и последующего запуска кода на уровне приложения для управления завершением работы.</p>
<p><code>// Node.js  // Graceful shutdown on SIGTERM process.on("SIGTERM", () => { // close server, close database connection, write logs... releaseAllResources(); // then manually exit process.exit(143); });</code></p>
<p>Как мы видим, для обработки этих сигналов мы можем подключить обработчики процессов с нашей собственной логикой. Обратите внимание, что важно, чтобы обработчик завершал процесс вручную после очистки, иначе процесс будет висеть и продолжать жить.</p>
<p><code>// Node.js  process.on("SIGTERM", () => { // If we don't manually exit, the process will hang forever // until a SIGKILL is fired. Once attaching these types of handler, // it's then your responsibility to release the last ressource: the process itself. });</code></p>
<p>Добавление обработчиков процесса SIGTERM позволяет нам взять под контроль логику, которая будет выполняться, но мы также несем ответственность за правильный выход после этого.</p>
<p>Мы также могли бы склониться к тому, чтобы не завершать процесс после завершения и оставить его работать, но это очень неудобно, и обработчик должен использоваться только для самого изящного завершения.</p>
<p>Но не может ли прикрепление этих обработчиков быть вредным, если мы не выйдем после этого?</p>
<p>Конечно, может! Именно поэтому большинство супервизоров обычно не полагаются только на SIGTERM, а после отправки SIGTERM ждут определенное время и посылают SIGKILL, если процесс все еще не завершен (это, по сути, разница между “Quit” и “Force Quit” при использовании диспетчера задач). Обратите внимание, что в зависимости от ОС, некоторые могут просто позволить процессу висеть неопределенное время.</p>
<p>Следовательно, даже приложения на вашей собственной хост-машине должны правильно обрабатывать эти сигналы, а не только те, которые находятся в производстве, даже если последствия, скорее всего, будут менее серьезными и стоить меньше денег.</p>
<h2 id="производственная-среда">Производственная среда<a aria-hidden="true" tabindex="-1" href="#производственная-среда"><span class="icon icon-link"></span></a></h2>
<p>Давайте вернемся к основной теме - запуску контейнерных приложений в производственных средах.</p>
<p>В этой статье я исхожу из того, что вы знаете, что такое контейнер. Если нет, ознакомьтесь с документацией Docker, прежде чем углубляться в эту тему.</p>
<h2 id="жизненный-цикл-контейнера">Жизненный цикл контейнера<a aria-hidden="true" tabindex="-1" href="#жизненный-цикл-контейнера"><span class="icon icon-link"></span></a></h2>
<p>В большинстве производственных систем приложения развертываются и запускаются в контейнерах, что позволяет приложениям работать в ”песочнице” и легкой среде. Существует множество различных типов контейнеров, но мы не будем вдаваться в подробности в этой серии, поскольку большинство положительных практик и вещей, которых следует избегать, могут быть применены ко всем типам контейнеров.</p>
<p>Контейнеры обычно управляются супервизорами или оркестраторами, которые определяют, следует ли запускать, перезапускать, останавливать контейнер, увеличивать/уменьшать его масштаб и т. д. Одним из самых известных контейнерных оркестров является Kubernetes (K8S), изначально разработанный компанией Google.</p>
<p>Целью K8S является оркестровка контейнеров в масштабе, управление кластерами контейнеров, включающими множество различных сервисов и приложений компании. В двух словах K8S управляет развертыванием контейнеров, жизненным циклом контейнеров, определяя необходимость их увеличения или уменьшения в зависимости от нагрузки, а также имеет дело с развертыванием и принятием произвольных решений, таких как остановка/перезапуск контейнеров при появлении новых версий.</p>
<p>Чтобы Kubernetes работала эффективно, необходимо соблюдать один фундаментальный критерий для контейнеров: приложение, запущенное в контейнере, должно правильно реагировать на сигналы, поступающие от орхистратора.</p>
<p>В чем опасность неправильной реакции на эти сигналы в контексте контейнеров?</p>
<p>Как было описано в предыдущем разделе для процессов ОС, супервизор, которым в контексте контейнеров является Kubernetes, сначала попытается отправить SIGTERM, а по истечении стандартного значения 30 секунд (может быть настроено) будет отправлен сигнал SIGKILL, чтобы убедиться, что контейнер остановлен.</p>
<p>Здесь приведен список контейнерных сервисов с соответствующим поведением при SIGTERM и SIGKILL</p>
<h2 id="поведение-сигнала-о-прекращении-обслуживания">Поведение сигнала о прекращении обслуживания<a aria-hidden="true" tabindex="-1" href="#поведение-сигнала-о-прекращении-обслуживания"><span class="icon icon-link"></span></a></h2>
<p>AWS Elastic Container Service SIGTERM, подождите 30 секунд, затем SIGKILL</p>
<p>Kubernetes SIGTERM, подождите 30 секунд, затем SIGKILL</p>
<p>Azure App Service SIGTERM, wait 30s, then SIGKILL</p>
<p>Docker SIGTERM, подождите 10 секунд, затем SIGKILL</p>
<p>Мы можем сказать, что все в порядке и нас не очень заботит обработка сигналов завершения, поскольку SIGKILL все равно будет отправлен в какой-то момент и завершит как наш процесс приложения, так и контейнер, в котором изначально находился процесс приложения.</p>
<p>Если отложить в сторону процесс изящного выключения, о котором мы уже рассказывали в предыдущем разделе, есть еще одна проблема, которая может стать критической в большинстве производственных систем, - это задержка.</p>
<p>Представьте, что контейнер необходимо откатить из-за ошибки, это значит, что в течение 30 секунд мы не сможем делать ничего, кроме как ждать. Кроме того, все операции, такие как уменьшение масштаба или остановка, будут продолжать использовать ресурсы до тех пор, пока не будет получен сигнал SIGKILL. При масштабировании на сотни/тысячи контейнеров 30s может быстро стать очень накладным и привести к критическим штрафам за производительность.</p>
<p>Не забывайте подключать к своим приложениям обработчики сигналов завершения и правильно обрабатывать изящные завершения. Это поможет и приложению, и всем производственным системам, построенным вокруг него, быть более надежными, устойчивыми и эффективными.</p>
<p>Убедитесь, что сигналы об окончании могут распространяться</p>
<p>Обычно, когда ваше приложение правильно управляет сигналом завершения, это уже хорошо. Однако для этого есть необходимое условие: сигнал завершения должен корректно распространяться, начиная с супервизора на самом верху и заканчивая самым низом, где находится ваш прикладной процесс.</p>
<h2 id="что-может-пойти-не-так">Что может пойти не так?<a aria-hidden="true" tabindex="-1" href="#что-может-пойти-не-так"><span class="icon icon-link"></span></a></h2>
<p>Рассмотрим очень простой пример с контейнерами Docker, где <code>Dockerfile</code> задает ENTRYPOINT так, чтобы породить shell-процесс в качестве PID1, что известно как shell-форма команды ENTRYPOINT.</p>
<p>Пожалуйста, не используйте следующий Dockerfile для доставки приложений Node.js в производство. Это упрощенный пример, который будет использовать устаревшую версию Node.js (v12), которая подходит только для образовательных целей.</p>
<p>Вы можете самостоятельно протестировать все последующие примеры, используя созданный мной репозиторий</p>
<p><code>Dockerfile</code></p>
<p><code>FROM ubuntu:22.04  RUN apt-get update &#x26;&#x26; \ apt-get install -y nodejs  ENTRYPOINT node index.js</code></p>
<p>Собирать свой собственный образ Node.js не рекомендуется, здесь мы собираем его из Ubuntu в образовательных целях. Пожалуйста, полагайтесь на официальные образы для производства.</p>
<p>В результате в контейнере будет два процесса: shell - родительский, а приложение Node.js - дочерний процесс shell (subshell). Следствием этого будет то, что shell не будет корректно передавать сигналы завершения, а это значит, что процесс Node.js никогда не получит этих сигналов.</p>
<p><code># Command run within the container  $ ps aux USER PID COMMAND root 1 /bin/sh -c node index.js root 7 node index.js</code></p>
<p>Теперь, когда мы выполняем команду <code>docker stop &#x3C;container-id></code>, мы видим, что процесс Node.js не получает сигнал SIGTERM и продолжает жить, пока Docker не отправит сигнал SIGKILL через 10 с.</p>
<p>Один из способов обойти это - не делать оболочку PID1 и превратить сам процесс приложения в PID1 с помощью exec-формы ENTRYPOINT.</p>
<p><code>Dockerfile</code></p>
<p><code>FROM ubuntu:22.04  RUN apt-get update &#x26;&#x26; \ apt-get install -y nodejs  ENTRYPOINT ["node", "index.js"]</code></p>
<p>Если мы снова запустим <code>ps aux</code> внутри контейнера, то увидим, что процесс Node.js теперь имеет PID1:</p>
<p><code>$ ps aux USER PID COMMAND root 1 node index.js</code></p>
<p>Поскольку наше приложение следует хорошим практикам, о которых мы говорили в первой части, оно правильно обрабатывает сигналы и способно выполнить изящное завершение работы.</p>
<h2 id="не-позволяйте-вашему-процессу-подачи-заявки-стать-pid1">Не позволяйте вашему процессу подачи заявки стать PID1<a aria-hidden="true" tabindex="-1" href="#не-позволяйте-вашему-процессу-подачи-заявки-стать-pid1"><span class="icon icon-link"></span></a></h2>
<p>Положительной стороной того, что процесс нашего приложения является единственным процессом в контейнере, и учитывая, что наше приложение настроило ожидаемые обработчики процессов, является то, что мы можем правильно управлять сигналами завершения.</p>
<p>Тем не менее, у нас появилась новая проблема, которая заключается в том, что нашим приложением теперь является PID1, также известный как процесс init.</p>
<h2 id="что-представляет-собой-процесс-pid1-под-псевдонимом-init">Что представляет собой процесс PID1 под псевдонимом “init”?<a aria-hidden="true" tabindex="-1" href="#что-представляет-собой-процесс-pid1-под-псевдонимом-init"><span class="icon icon-link"></span></a></h2>
<p>PID1 или процесс “init” имеет очень четкие обязанности в отношении операционной системы (или, точнее, контейнера в данном контексте).</p>
<p>Прежде чем объяснять проблему вокруг PID1, давайте быстро вернемся к основе ОС с организацией процессов.</p>
<p>Реестр процессов представлен в виде графа, где PID1 представляет корневой узел, обычно называемый “init”.</p>
<p>В отличие от других процессов, процесс “init” (PID1) наделяется ядром весьма специфическими обязанностями, которые, в частности, заключаются в следующем:</p>
<p>инициализировать все службы (процессы), необходимые операционной системе.</p>
<p>управлять так называемыми ”зомби” или “сиротскими” процессами и получать от них прибыль. Зомби-процесс - это процесс, который завершил выполнение, но ресурсы которого продолжают монополизироваться.</p>
<p>обеспечить правильную передачу кода завершения дочернего процесса за пределы контейнера.</p>
<p>Все эти обязанности не могут и не должны возлагаться ни на ваше приложение, ни на среду выполнения, на которой оно выполняется (JVM, Node.js и т. д.).</p>
<h2 id="кто-же-тогда-должен-быть-pid1">Кто же тогда должен быть PID1?<a aria-hidden="true" tabindex="-1" href="#кто-же-тогда-должен-быть-pid1"><span class="icon icon-link"></span></a></h2>
<p>Существует множество решений, но Tini - самое известное и проверенное в боях.</p>
<p>У Tini одна цель - обеспечить процесс “init”, который работает так, как ожидается. Это независимый исполняемый файл, но важно упомянуть, что он по умолчанию встроен в Docker начиная с версии 1.13, его можно использовать с помощью <code>docker run --init</code> или с помощью docker-compose (версия 2.2), используя <code>init: true</code> из конфигурационного файла для сервиса.</p>
<p>В контексте приложения Node.js вот пример минималистичного, но более близкого к производственной готовности Dockerfile с использованием Tini:</p>
<p><code>FROM node:18-alpine  RUN apk add --no-cache tini  # Copy app files  ENTRYPOINT ["/sbin/tini", "--", "node", "index.js"]</code></p>
<p>Надеемся, теперь вы знаете о некоторых ловушках, которых следует избегать при запуске контейнерных приложений в производстве, и в целом понимаете, как взаимодействуют процессы и как руководители управляют их жизненным циклом.</p>
<p>Я часто публикую в своем блоге статьи о программной инженерии, не забудьте подписаться, если вам интересно узнать больше!</p>
<p>Увидимся позже 👋🏻</p> <div class="share article__share" data-astro-cid-g7nhfqu5> <h3 class="share__title" data-astro-cid-g7nhfqu5>Поделиться:</h3> <ul class="share__list" data-astro-cid-g7nhfqu5> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://vk.com/share.php?url=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Vk
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="facebook share button" href="https://facebook.com/sharer/sharer.php?u=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Fb
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="twitter share button" href="https://twitter.com/share?title=Избегайте этого при запуске контейнерных приложений в производстве&url=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
X
</a> </li><li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="linkedin share button" href="https://www.linkedin.com/shareArticle?mini=true&url=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve&title=Избегайте этого при запуске контейнерных приложений в производстве&summary=Привет всем!

Давайте поговорим о том, чем нужно управлять при запуске контейнерных приложений, и как это связано с правильным управлением сигналами завершения&source=https://igorlov.ru/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Linkd
</a> </li> <li class="share__item" data-astro-cid-g7nhfqu5> <a class="share__link" aria-label="pinterest share button" href="https://pinterest.com/pin/create/button/?url=https://igorlov.ru/blog/yzbehaite-toho-pry-zapuske-konteinern-kh-prylozhenyi-v-proyzvodstve&media=&description=Привет всем!

Давайте поговорим о том, чем нужно управлять при запуске контейнерных приложений, и как это связано с правильным управлением сигналами завершения" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-g7nhfqu5>
Pint
</a> </li> </ul>  </div> <nav class="circular-pagination" aria-label="Circular Pagination" data-astro-cid-ihkjvfsn> <a href="/blog/pryvedenye-v-poriadok-vasheho-koda-rails-yskusstvo-refaktorynha-v-style-mary-kondo" class="circular-pagination__link circular-pagination__link--prev" data-astro-cid-ihkjvfsn> Приведение в порядок вашего кода Rails: Искусство рефакторинга в стиле Мари Кондо </a> <a href="/blog/ruby-on-rails-dlia-nachynaiuschykh-sozdaem-ynternet-mahazyn-s-pomoschiu-rails" class="circular-pagination__link circular-pagination__link--next" data-astro-cid-ihkjvfsn> Ruby on Rails для начинающих: создаем интернет-магазин с помощью Rails </a> </nav>  </div> </div> </article> <div class="container" data-astro-cid-axzg2cw6> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><astro-island uid="Z1T5Wnr" prefix="r0" component-url="/_astro/YandexRelatedAds.D-6fTqBY.js" component-export="default" renderer-url="/_astro/client.Bd2Qst3j.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;YandexRelatedAds&quot;,&quot;value&quot;:true}" await-children=""><div id="yandex_rtb_C-A-2592503-2"></div><!--astro:end--></astro-island> </div> <script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();</script><astro-island uid="Z2a8j9B" component-url="/_astro/CommentBlock.ChJFdf82.js" component-export="default" renderer-url="/_astro/client.44T8euMP.js" props="{&quot;data-astro-cid-axzg2cw6&quot;:[0,true]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;CommentBlock&quot;,&quot;value&quot;:true}"></astro-island>  <!-- <div class="blocks__container container">
			<CtaBlock id="cta" class=""
			/>
		</div> --> </div>    </main> <footer class="footer" data-astro-cid-dwelrhxs> <div class="footer__container container" data-astro-cid-dwelrhxs> <a href="/" class="logo font-medium lowercase transition-colors fluid:text-lg footer__logo dark:hover:text-light text-blue dark:text-white" aria-label="logo" data-astro-cid-ijoll5s5> <svg width="1.44em" height="1em" viewBox="0 0 5660 3931" class="icon" data-astro-cid-ijoll5s5 data-icon="logo-one">  <use xlink:href="#ai:local:logo-one"></use>  </svg>  </a> <small class="footer__copyright" data-astro-cid-dwelrhxs>все права защищены. © 2024</small> </div> </footer>  </body></html>