---
title: >-
  Разработка бэкенда Web3 и смарт-контрактов для Python-разработчиков часть 8:
  Бэкенд Django функциональность логирования и выхода из системы
meta_title: |
  Разработка Бэкенда Web3 И Смарт-Контрактов Для...
description: >
  Теперь перейдем к рассмотрению бэкенда Django. Первым шагом, как всегда,
  является активация соответствующего виртуального окружения Python. Из...
date: 2023-10-18T18:22:02.594Z
image: >-
  ../../assets/images/razrabotka-bekenda-web3-i-smart-kontraktov-dlya-python-razrabotchikov-chastь-8-bekend-django-funkcionalьnostь-logirovaniya-i-vyhoda-iz-sistemy-Oct-18-2023.avif
categories:
  - Как закодить
author: Igor Gorlov
tags:
  - Python
draft: false
keywords:
  - бэкенда Web3 Python
type: blog
slug: >-
  razrabotka-bekenda-web3-i-smart-kontraktov-dlya-python-razrabotchikov-chastь-8-bekend-django-funkcionalьnostь-logirovaniya-i-vyhoda-iz-sistemy
lastmod: 2024-03-20T21:26:48.520Z
---

Теперь перейдем к рассмотрению бэкенда Django. Первым шагом, как всегда, является активация соответствующего виртуального окружения Python. Из папки ./musical_nft_thumbnails

<code>$source env/bin/activate</code>

На данный момент нам нужна посадочная страница. Функции входа, выхода, регистрации, а также сброса пароля. После того как пользователь зарегистрируется и войдет в нашу платформу, мы перенаправим его на его персональную страницу. Там он сможет увидеть свою информацию, NFT, которыми он владеет, и купить новый NFT с помощью криптовалюты или кредитной карты.

Создание нового приложения Django для аутентификации

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">$py manage.py startapp authentication
</code></pre>
<!-- /wp:code -->

В этом вновь созданном приложении мы будем управлять процессом регистрации, входом в систему, выходом из нее и сбросом пароля.

Добавить в musical_nft/settings.py аутентификацию в список установленных приложений:

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">    INSTALLED_APPS = [
        "django.contrib.admin",
        "django.contrib.auth",
        "django.contrib.contenttypes",
        "django.contrib.sessions",
        "django.contrib.messages",
        "django.contrib.staticfiles",
        # here =&gt;
        "authentication",
]
</code></pre>
<!-- /wp:code -->

Теперь в глобальном файле urls.py внутри musical_nft/settings.py добавьте

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript"> from django.contrib import admin
    from django.urls import path, include

    urlpatterns = [
        path("admin/", admin.site.urls),
        path("", include("authentication.urls"))
    ]
</code></pre>
<!-- /wp:code -->

Теперь все пути, которые мы имеем внутри приложения аутентификации, будут подключены к этому проекту urls.py

В папке приложения аутентификации создайте еще один urls.py и передайте в него следующий код

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">   from django.urls import path
    from .views import HomeView

    urlpatterns = [
        path("", HomeView.as_view(), name="home"),
    ]
</code></pre>
<!-- /wp:code -->

Если вы не создали суперпользователя, давайте сделаем это сейчас

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">$python manage.py createsuperuser
</code></pre>
<!-- /wp:code -->

Теперь откройте браузер http:127.0.0.1:8000/admin при запущенном локальном Django-сервере и введите учетные данные суперпользователя (обязательно убедитесь, что ваш postgres-сервер запущен $sudo service postgresql start).

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--rD1DZzeW--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/j30gzl0by2akqcbh0n15.png" alt="Описание изображения"/></figure>
<!-- /wp:image -->

После того как вы вошли в систему, перейдите в раздел ”Пользователь" и добавьте нового пользователя (подтвердите пароль)

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--AM1AHf5i--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/bma5py7k9bq9wt4sb44c.png" alt="Описание изображения"/></figure>
<!-- /wp:image -->

На данном этапе нам нужен класс представления аутентификации и несколько html-страниц для рендеринга. При создании приложений Django следует помнить, что это всегда трехступенчатый процесс: определение адресов (в приложении), представлений (в нашем случае представлений на основе классов. Если вы хотите поэкспериментировать с альтернативными реализациями этого кода, то можно сделать представление на основе функций) и шаблоны (html-страница, которая будет отображаться с небольшим количеством добавленных Django-элементов).

В файл views.py приложения аутентификации добавьте следующий код:

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">from django.shortcuts import render
    from django.views.generic import TemplateView

    class HomeView(TemplateView):

        def get(self, request):
            return render(request, "home.html", {})
</code></pre>
<!-- /wp:code -->

Только для тестирования создадим простой файл home.html с сообщением, которое будет отображаться в браузере. Для этого создадим в ./muscial_nft_thumbnails/tempaltes/home.html

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript"> {% extends "base.html" %}

    {% block content%}
        &lt;h1&gt; Test screen &lt;/h1&gt;
    {% endblock content%}
</code></pre>
<!-- /wp:code -->

Эти своеобразные фигурные скобки являются частью синтаксиса Django, который мы должны использовать с нашими шаблонами

Затем в settings.py добавьте определение корневой папки шаблона

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">TEMPLATES = [
        {
            "BACKEND": "django.template.backends.django.DjangoTemplates",
            "DIRS": [os.path.join(BASE_DIR, "templates")],
            "APP_DIRS": True,
            "OPTIONS": {
                "context_processors": [
                    "django.template.context_processors.debug",
                    "django.template.context_processors.request",
                    "django.contrib.auth.context_processors.auth",
                    "django.contrib.messages.context_processors.messages",
                ],
            },
        },
    ]
</code></pre>
<!-- /wp:code -->

В этом проекте мы будем использовать bootstrap для стилизации. Перейдите на страницу их документации и возьмите из введения второй вариант номер два, Include Bootstrap’s CSS and JS. и вставьте этот код во вновь созданный файл base.html в корневой папке проекта ./templates (или просто скопируйте отсюда)

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">&lt;!doctype html&gt;
    &lt;html lang="en"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
        &lt;title&gt;Muscial NFT&lt;/title&gt;
        &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="container "&gt;       
            &lt;br/&gt;
            &lt;br/&gt;
            {% block content %}
            {% endblock content %}
        &lt;/div&gt;
        &lt;script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"&gt;&lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
</code></pre>
<!-- /wp:code -->

Теперь добавим navbar на нашу страницу base.html.

Это можно сделать, просто зайдя в документацию сайта bootstrap и поискав navbar в компонентах. Выбираем наиболее понравившийся. Для нашей демонстрации подойдет первый вариант.

Вот отредактированный код, который нужно передать в файл navbar.html в папке ./templates в корневой директории проекта.

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">&lt;nav class="navbar navbar-expand-lg navbar-dark bg-dark"&gt;
        &lt;div class="container-fluid"&gt;
        &lt;a class="navbar-brand" href="https://dev.to/ilija/{% url"home' %}"&gt;Musical NFT &lt;/a&gt;
        &lt;button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"&gt;
            &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;
        &lt;/button&gt;
        &lt;div class="collapse navbar-collapse" id="navbarSupportedContent"&gt;
            &lt;ul class="navbar-nav me-auto mb-2 mb-lg-0"&gt;
            &lt;li class="nav-item"&gt;
                &lt;a class="nav-link" href="#"&gt;Link&lt;/a&gt;
            &lt;/li&gt;
                &lt;/ul&gt;
            &lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
        &lt;/div&gt;
    &lt;/nav&gt;
</code></pre>
<!-- /wp:code -->

А затем просто перейдите в ранее созданный файл base.html и добавьте одну новую строку после первого тега body

{% include “navbar.html”%}

Из корневого каталога

$py manage.py runserver

Перейдите в браузер по адресу http://127.0.0.1:8000 и проверьте, появилось ли на экране правильное сообщение.

Теперь, если вы вернетесь в браузер, вы должны увидеть что-то вроде этого

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--cWJLMXC---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/95po8ydnchwdpigdh521.png" alt="Описание изображения"/></figure>
<!-- /wp:image -->

После этого мы можем перейти к добавлению базовых функций входа, регистрации, выхода и сброса пароля. Для входа и выхода мы будем использовать систему аутентификации Django.

Вот общий обзор того, как мы планируем подключить все, что связано с аутентификацией

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--YhN024Sk--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/87n9oiuq0t6vukbodhda.png" alt="Описание изображения"/></figure>
<!-- /wp:image -->

Сначала мы доработаем 3 основных шаблона: navbar, base и home (base включает в себя navbar, а home расширяет base, как показывает поток). Следует иметь в виду, что у home будет две возможности: 1) если пользователь залогинен, то мы будем показывать ему его персональную страницу; 2) если пользователь не залогинен, то мы будем предлагать ему формы входа (это можно проверить в файле home.html).

navbar.html (модифицированный bootstrap navbar)

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">&lt;nav class="navbar navbar-expand-lg navbar-dark bg-dark"&gt;
        &lt;div class="container-fluid"&gt;
        &lt;a class="navbar-brand" href="https://dev.to/ilija/{% url"home' %}"&gt;Musical NFT &lt;/a&gt;
        &lt;button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"&gt;
            &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;
        &lt;/button&gt;
        &lt;div class="collapse navbar-collapse" id="navbarSupportedContent"&gt;
            &lt;ul class="navbar-nav me-auto mb-2 mb-lg-0"&gt;
            {% if user.is_authenticated%}
            &lt;li class="nav-item"&gt;
            &lt;a class="nav-link" href="https://dev.to/ilija/{% url"logout'%}"&gt;Logout&lt;/a&gt;
            &lt;/li&gt;
            {% else %}
            &lt;li class="nav-item"&gt;
            &lt;a class="nav-link" href="https://dev.to/ilija/{% url"home'%}"&gt;Login&lt;/a&gt;
            &lt;/li&gt;
            {% endif%}
                &lt;/ul&gt;
            &lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
        &lt;/div&gt;
    &lt;/nav&gt;

</code></pre>
<!-- /wp:code -->

Теперь base.html включает в себя navbar.html

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">&lt;!doctype html&gt;
    &lt;html lang="en"&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
        &lt;title&gt;Muscial NFT&lt;/title&gt;
        &lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"&gt;
    &lt;/head&gt;
    &lt;body&gt;
        {% include "navbar.html"%}
        &lt;div class="container "&gt;       
            &lt;br/&gt;
            &lt;br/&gt;
            {% if messages %}
            {% for message in messages%}
            &lt;div class="alert alert-warning alert-dismissible fade show" role="alert"&gt;
            {{ message }}
            &lt;button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"&gt;&lt;/button&gt;
            &lt;/div&gt;

            {% endfor%}
            {% endif %}

            {% block content %}

            {% endblock content %}
        &lt;/div&gt;
        &lt;script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"&gt;&lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
</code></pre>
<!-- /wp:code -->

Здесь я хочу обратить ваше внимание на последний {% block content %} {% endblock content %} Это место, где base.html инжектирует любой другой шаблон, который наследует от него с помощью команды extends (в нашем случае home.html).

Далее несколькими строками выше вы имеете немного странный синтаксис с {% if messages %} {% for message in messages%} Просто таким образом мы передаем в наш шаблон сообщение об успехе или ошибке. Более подробную информацию об этом можно найти в файле view.py.

Как мы видим, home.html будет расширять base.html и иметь внутри себя специфические для Django статусы if/else. Эта строка if/else поможет нам проверить, вошел ли пользователь в систему, после чего мы предложим ему его персональную страницу. В случае если пользователь не вошел в систему, мы покажем ему форму входа.

Ниже приведен пример кода:

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript"> {% extends "base.html" %}

    {% block content%}

    &lt;div class="col-md-6 offset-md-3"&gt; 

        {% if user.is_authenticated %} 
        &lt;h1&gt; Welcome &lt;h1/&gt;
        {% else %}
        &lt;h1&gt; Login &lt;/h1&gt;
        &lt;br/&gt;
        &lt;form method="POST" action="https://dev.to/ilija/{% url"home' %}"&gt; 
            {% csrf_token %}
            &lt;form&gt;
                &lt;div class="mb-3"&gt;
                &lt;input type="text" class="form-control" aria-describedby="emailHelp" placeholder="Username" name="username" required&gt;
                &lt;/div&gt;
                &lt;div class="mb-3"&gt;
                &lt;input type="password" class="form-control" placeholder="Password" name="password" required&gt;
                &lt;/div&gt;
                &lt;button type="submit" class="btn btn-secondary"&gt;Submit&lt;/button&gt;
            &lt;/form&gt;
            &lt;/form&gt; 
    &lt;/div&gt;

    {% endif %}
    {% endblock content%}

</code></pre>
<!-- /wp:code -->

Теперь у нас есть все шаблоны, и мы можем перейти в папку authentication app, где нам нужно обновить наш urls.py следующим кодом

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">    from django.urls import path
    from .views import HomeView, LogoutUser

    urlpatterns = [
        path("", HomeView.as_view(), name="home"),
        # path("login/", LoginUser.as_view(), name="login"),
        path("logout/", LogoutUser.as_view(), name="logout"),
    ]
</code></pre>
<!-- /wp:code -->

Как видно, мы добавили новый путь выхода из системы (логин является частью обычного пути home и класса HomeView), который будет обрабатываться классом LogoutUser внутри authenticaiotn view.py.

Как вы уже догадались, последний кусочек паззла, который нам нужен, это обработчик просмотра, который склеит все эти элементы вместе. Вот пример возможного кода:

<!-- wp:code -->
<pre class="wp-block-code"><code lang="javascript" class="language-javascript">from django.shortcuts import render, redirect
    from django.views.generic import TemplateView
    from django.contrib.auth import authenticate, login, logout
    from django.contrib import messages



    class HomeView(TemplateView):
        template_name="home.html"

        def post(self, request):
            # check to see if loggin in
            if request.method == "POST":
                user_name = request.POST["username"]
                password = request.POST["password"]
                user = authenticate(request, username=user_name, password=password)
                if user is not None:
                    login(request, user)
                    messages.success(request, "You have been logged in!")
                    return redirect("home")    
                else:
                    messages.success(request, "There was An Error login in, please try again")
                    return redirect("home")  
            else:
                return render(request, "home.html", {})


    class LogoutUser(TemplateView):    
        def get(self, request):
            logout(request)
            messages.success(request, "You have been logged out!")
            return redirect("home")  

</code></pre>
<!-- /wp:code -->

В этот момент запустите ваш Django-сервер локально (убедитесь, что ваш postgres-сервер работает и запущен), а затем перейдите по адресу http://127.0.0.1:8000. Если вы вошли в систему как администратор, вы должны увидеть что-то вроде этого

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--EJN6kDWB--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/9trpf1oc5ag7r87oal6l.png" alt="Описание изображения"/></figure>
<!-- /wp:image -->

Теперь введите учетные данные администратора или только что созданного пользователя, и вы должны увидеть что-то вроде этого =&gt;

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--122Yj87r--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/nvdn42rorgt57152qx36.png" alt="Описание изображения"/></figure>
<!-- /wp:image -->

Посмотрите на кнопку выхода из системы в левом верхнем углу навигационной панели. Эта кнопка попадет на наш путь logout/, а затем на обработчик класса LogoutUser (из views.py), который просто выйдет из системы и перенаправит текущего пользователя на домашнюю страницу.

И на этом месте мы, наконец, можем увидеть очень красивый момент в файле home.html. Этот цикл внутри home.html увидит, что пользователь уже не вошел в систему, и покажет ему формат логина. И, в общем-то, благодаря этой приятной детали у нас все в одном месте: и вход, и выход, и профиль пользователя - все прекрасно связано в этом шаблонном цикле.

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--VfHBD3x1--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_800/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mugg7gkbqzuhmtzunupo.png" alt="Описание изображения"/></figure>
<!-- /wp:image -->

Теперь, когда у нас есть вход и выход, перейдем к разработке функциональности регистрации и сброса пароля, прежде чем приступать к интеграции с web3.

Код для этого можно найти на <a href="https://github.com/ilijapet/musical_nft_thumbnails">github</a>
